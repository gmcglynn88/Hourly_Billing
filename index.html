<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Cloud - Hourly Billing Calculator</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --filter-bg:#f0f7f3; --warning:#ffc107; --danger:#dc3545;
      --success:#28a745; --info:#17a2b8;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1800px;
      background:var(--light-bg);color:var(--text-color);
      line-height:1.6;
    }

    .container{max-width:1400px;margin:0 auto}
    header{
      background:var(--card-bg);border-radius:12px;padding:24px 32px;
      margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,.1);
      border-left:5px solid var(--primary-color);border:1px solid var(--border-color);
    }

    h1{color:var(--text-color);margin-bottom:8px;font-size:28px}
    .subtitle{color:var(--text-light);font-size:16px}
    .main-grid{display:grid;grid-template-columns:350px 1fr;gap:24px}
    @media(max-width:1024px){.main-grid{grid-template-columns:1fr}}

    /* Card Styling */
    .card{
      background:var(--card-bg);border:1px solid var(--border-color);
      border-radius:12px;padding:24px;margin-bottom:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }

    .card h2{
      color:var(--primary-color);margin-bottom:20px;font-size:20px;
      padding-bottom:12px;border-bottom:2px solid var(--light-bg);
      display:flex;align-items:center;gap:10px;
    }

    /* Form Controls */
    .form-group{margin-bottom:20px}
    label{display:block;font-weight:600;margin-bottom:6px;color:var(--text-color)}
    select,input,button{
      padding:10px;border:1px solid var(--border-color);
      border-radius:6px;background:var(--card-bg);font-size:14px;width:100%;
    }

    button{
      background:var(--primary-color);color:#fff;font-weight:600;
      cursor:pointer;transition:background .2s;border:none;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }

    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}
    .btn-block{width:100%;padding:12px}
    .btn-success{background:var(--success)}.btn-success:hover{background:#218838}
    .btn-secondary{background:var(--text-light)}.btn-secondary:hover{background:#5a6268}

    /* Auth Section */
    .auth-card{
      background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
      color:white;padding:32px;border-radius:12px;margin-bottom:16px;
      text-align:center;
    }

    .auth-card h3{margin-bottom:16px;font-size:20px;color:white}
    .auth-card p{margin-bottom:24px;opacity:0.9}

    /* Status Display */
    .status-container{
      position:fixed;top:20px;right:20px;z-index:1000;
      display:flex;flex-direction:column;gap:10px;
      max-width:400px;
    }

    .status-message{
      background:white;padding:16px;border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);border-left:4px solid var(--primary-color);
      animation:slideIn 0.3s ease-out;display:flex;align-items:center;gap:12px;
    }

    @keyframes slideIn{
      from{transform:translateX(100%);opacity:0}
      to{transform:translateX(0);opacity:1}
    }

    /* Stats Cards */
    .stats-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;margin-top:20px;
    }

    .stat-card{
      background:var(--pill);border-radius:12px;padding:20px;
      border:1px solid var(--border-color);text-align:center;
      transition:all 0.3s;
    }

    .stat-card:hover{
      transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.1);
      border-color:var(--primary-color);
    }

    .stat-value{
      font-size:36px;font-weight:700;color:var(--primary-color);
      margin:10px 0;
    }

    .stat-label{
      font-size:14px;color:var(--text-light);
      text-transform:uppercase;letter-spacing:1px;
    }

    /* Table */
    .table-container{
      overflow-x:auto;margin-top:20px;border-radius:8px;
      border:1px solid var(--border-color);background:var(--card-bg);
      max-height:500px;overflow-y:auto;
    }

    table{width:100%;border-collapse:collapse}
    th{
      background-color:var(--primary-color);color:white;font-weight:600;
      position:sticky;top:0;z-index:10;white-space:nowrap;padding:16px;text-align:left;
    }
    td{padding:14px 16px;border-bottom:1px solid var(--border-color)}
    tr:hover{background-color:var(--pill)}

    /* Status Badges */
    .status-badge{
      display:inline-block;padding:4px 12px;border-radius:20px;
      font-size:12px;font-weight:600;text-transform:uppercase;
    }

    .status-named{background:rgba(99,171,143,0.15);color:var(--primary-color);border:1px solid rgba(99,171,143,0.3)}
    .status-hi{background:rgba(40,167,69,0.15);color:var(--success);border:1px solid rgba(40,167,69,0.3)}
    .status-supervisor{background:rgba(255,193,7,0.15);color:#d39e00;border:1px solid rgba(255,193,7,0.3)}
    .status-nologin{background:rgba(108,117,125,0.15);color:var(--text-light);border:1px solid rgba(108,117,125,0.3)}

    /* Tabs */
    .tabs{
      display:flex;border-bottom:2px solid var(--border-color);
      margin-bottom:24px;background:white;border-radius:8px 8px 0 0;
    }

    .tab{
      padding:16px 24px;background:none;border:none;
      border-bottom:2px solid transparent;font-size:15px;
      font-weight:600;color:var(--text-light);cursor:pointer;
      transition:all 0.3s;flex:1;text-align:center;
    }

    .tab:hover{color:var(--primary-color)}
    .tab.active{
      color:var(--primary-color);border-bottom-color:var(--primary-color);
      background:rgba(99,171,143,0.05);
    }

    .tab-content{display:none;animation:fadeIn 0.3s ease}
    .tab-content.active{display:block}

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    /* Loading */
    .loading-overlay{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.95);display:flex;
      flex-direction:column;justify-content:center;align-items:center;
      z-index:9999;display:none;
    }

    .loading-overlay.active{display:flex}
    .spinner{
      width:60px;height:60px;border:5px solid #f3f3f3;
      border-top:5px solid var(--primary-color);border-radius:50%;
      animation:spin 1s linear infinite;margin-bottom:20px;
    }

    @keyframes spin{to{transform:rotate(360deg)}}

    /* Progress Bar */
    .progress-container{
      width:100%;max-width:400px;margin:20px auto;
    }

    .progress-bar{
      height:8px;background:var(--light-bg);border-radius:4px;
      overflow:hidden;margin-top:10px;
    }

    .progress-fill{
      height:100%;background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));
      border-radius:4px;transition:width 0.3s ease;
      width:0%;
    }

    .progress-text{
      display:flex;justify-content:space-between;font-size:14px;
      color:var(--text-light);margin-bottom:5px;
    }

    /* Hour Bucket Display */
    .bucket-container{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:10px;margin-top:20px;
    }

    .bucket-card{
      background:white;border-radius:8px;padding:12px;
      border:1px solid var(--border-color);text-align:center;
    }

    .bucket-count{
      font-size:24px;font-weight:700;color:var(--primary-color);
    }

    .bucket-label{
      font-size:12px;color:var(--text-light);margin-top:5px;
    }

    /* Date Range Quick Select */
    .quick-select-buttons{
      display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px;
    }

    .quick-select-btn{
      padding:8px;background:var(--light-bg);border:1px solid var(--border-color);
      border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;
      transition:all 0.3s;text-align:center;
    }

    .quick-select-btn:hover{
      background:var(--pill);border-color:var(--primary-color);
    }

    @media(max-width:768px){
      body{margin:10px;padding:10px}
      .card{padding:16px}
      header{padding:16px}
      h1{font-size:24px}
      .btn-block{padding:10px 16px;font-size:14px}
      .stat-value{font-size:28px}
      .main-grid{grid-template-columns:1fr}
      .status-container{max-width:300px}
    }

    /* Auto-auth specific styles */
    .auto-auth-message {
      text-align: centre;
      padding: 20px;
      background: rgba(99, 171, 143, 0.1);
      border-radius: 8px;
      margin: 20px 0;
      border: 1px solid rgba(99, 171, 143, 0.3);
    }
  </style>
</head>
<body>
  <!-- Hidden Auth Container (Only shown during auth process) -->
  <div id="authContainer" style="display:none;">
    <div class="container" style="max-width:500px;margin:100px auto;">
      <div class="auth-card">
        <h3>üîê Genesys Cloud Authentication</h3>
        <div class="auto-auth-message">
          <div class="spinner" style="width:40px;height:40px;border-width:3px;"></div>
          <p style="margin-top:15px;font-size:14px;">Attempting automatic authentication...</p>
        </div>

        <!-- Kept in the DOM but never shown/used when auto-auth is enabled -->
        <div id="manualAuthSection" style="display:none;margin-top:20px;">
          <div class="form-group">
            <label for="environment">Environment</label>
            <select id="environment">
              <option value="https://api.euw2.pure.cloud">EU West (London) - euw2.pure.cloud</option>
              <option value="https://api.mypurecloud.ie">Ireland - mypurecloud.ie</option>
              <option value="https://api.mypurecloud.com">US East - mypurecloud.com</option>
              <option value="https://api.usw2.pure.cloud">US West - usw2.pure.cloud</option>
              <option value="https://api.cac1.pure.cloud">Canada - cac1.pure.cloud</option>
              <option value="https://api.apne2.pure.cloud">Australia - apne2.pure.cloud</option>
              <option value="https://api.euw2.pure.cloud">EU West (Frankfurt) - euw2.pure.cloud</option>
            </select>
          </div>

          <button id="btnAuthenticate" class="btn btn-block">
            <span>üîó Sign in to Genesys Cloud</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Messages Container -->
  <div class="status-container" id="statusContainer"></div>

  <!-- Main Content -->
  <div id="mainContent" style="display:none;">
    <div class="container">
      <header>
        <h1>üìä Genesys Cloud - Hourly Billing Calculator</h1>
        <p class="subtitle">Calculate optimal licence distribution based on user interaction data</p>
      </header>

      <div class="main-grid">
        <!-- Left Column: Controls -->
        <div class="left-column">
          <!-- Connection Status -->
          <div class="card" id="connectionCard">
            <h2>üîå Connection Status</h2>
            <div class="form-group">
              <label>Environment</label>
              <input type="text" id="envDisplay" value="EU West (London) - euw2.pure.cloud" readonly style="background:var(--filter-bg);">
            </div>
            <div class="form-group">
              <label>Status</label>
              <div style="display:flex;align-items:center;gap:10px;">
                <div id="statusIndicator" style="width:12px;height:12px;border-radius:50%;background:#6c757d;"></div>
                <span id="statusText">Not Connected</span>
              </div>
            </div>
            <button id="btnDisconnect" class="btn" style="margin-top:15px;background:var(--danger);">
              <span>üö™ Disconnect</span>
            </button>
          </div>

          <!-- Date Range -->
          <div class="card">
            <h2>üìÖ Analysis Period</h2>
            <div class="form-group">
              <label>From Date</label>
              <input type="date" id="dateFrom">
            </div>
            <div class="form-group">
              <label>To Date</label>
              <input type="date" id="dateTo">
            </div>
            <div class="quick-select-buttons">
              <button class="quick-select-btn" data-days="30">üìÖ Last 30 days</button>
              <button class="quick-select-btn" data-days="7">üìÖ Last 7 days</button>
              <button class="quick-select-btn" data-days="1">üìÖ Yesterday</button>
              <button class="quick-select-btn" data-days="0">üìÖ Today</button>
            </div>
          </div>

          <!-- Business Rules -->
          <div class="card">
            <h2>‚öôÔ∏è Business Rules</h2>
            <div class="form-group">
              <label for="thresholdHours">HI Threshold (hours/month)</label>
              <input type="number" id="thresholdHours" value="40" min="1" max="200">
              <div style="font-size:12px;color:var(--text-light);margin-top:5px;">
                Users below this threshold get HI licences
              </div>
            </div>
            <div class="form-group">
              <label for="includeNologin">Include NOLOGIN Users</label>
              <select id="includeNologin">
                <option value="true">Yes - Include in totals</option>
                <option value="false">No - Exclude from analysis</option>
              </select>
            </div>
            <div style="background:rgba(99,171,143,0.05);padding:12px;border-radius:6px;margin-top:10px;">
              <div style="font-size:12px;color:var(--primary-color);font-weight:600;margin-bottom:5px;">üìã Business Logic:</div>
              <div style="font-size:11px;color:var(--text-light);">
                ‚Ä¢ Interacting time &gt; 0 but &lt; threshold = HI Licence<br>
                ‚Ä¢ Interacting time ‚â• threshold = Named Licence<br>
                ‚Ä¢ Admins/Supervisors = Named (always)<br>
                ‚Ä¢ NOLOGIN = No licence consumption
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="card">
            <h2>üöÄ Actions</h2>
            <button id="btnFetchData" class="btn btn-block" disabled>
              <span>üì• Fetch User Data</span>
            </button>
            <div style="height:12px;"></div>
            <button id="btnAnalyze" class="btn btn-success btn-block" disabled>
              <span>üßÆ Analyse & Calculate</span>
            </button>
            <div style="height:12px;"></div>
            <button id="btnExport" class="btn btn-secondary btn-block" disabled>
              <span>üìä Export Report</span>
            </button>
            <div style="height:12px;"></div>
            <button id="btnReset" class="btn btn-block" style="background:var(--danger);">
              <span>üîÑ Reset Session</span>
            </button>
          </div>
        </div>

        <!-- Right Column: Results -->
        <div class="right-column">
          <!-- Tabs -->
          <div class="tabs">
            <button class="tab active" data-tab="dashboard">üìä Dashboard</button>
            <button class="tab" data-tab="users">üë• Users</button>
            <button class="tab" data-tab="analysis">üìà Analysis</button>
            <button class="tab" data-tab="logs">üìù Logs</button>
          </div>

          <!-- Dashboard Tab -->
          <div id="tab-dashboard" class="tab-content active">
            <!-- Summary Stats -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Total Users</div>
                <div class="stat-value" id="statTotalUsers">0</div>
                <div style="font-size:11px;color:var(--text-light);">Setup in org</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Active Users</div>
                <div class="stat-value" id="statActiveUsers">0</div>
                <div style="font-size:11px;color:var(--text-light);">Logged in period</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Named Users</div>
                <div class="stat-value" id="statNamedUsers">0</div>
                <div style="font-size:11px;color:var(--text-light);">Recommended</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">HI Users</div>
                <div class="stat-value" id="statHiUsers">0</div>
                <div style="font-size:11px;color:var(--text-light);">Hourly Interacting</div>
              </div>
            </div>

            <!-- User Type Distribution -->
            <div class="card" style="margin-top:20px;">
              <h2>üë• User Type Distribution</h2>
              <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(150px,1fr));">
                <div class="stat-card">
                  <div class="stat-label">Agents</div>
                  <div class="stat-value" id="statAgents">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Agent role users</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Supervisors</div>
                  <div class="stat-value" id="statSupervisors">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Supervisor role users</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Admins</div>
                  <div class="stat-value" id="statAdmins">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Admin role users</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Others</div>
                  <div class="stat-value" id="statOthers">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Other role users</div>
                </div>
              </div>
            </div>

            <!-- Hour Distribution -->
            <div class="card" style="margin-top:20px;">
              <h2>‚è±Ô∏è Hour Distribution</h2>
              <div class="bucket-container" id="hourBuckets"></div>
            </div>

            <!-- Progress Display -->
            <div class="card" style="margin-top:20px;">
              <h2>üìà Analysis Progress</h2>
              <div class="progress-container">
                <div class="progress-text">
                  <span id="progressLabel">Ready to analyse</span>
                  <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill"></div>
                </div>
              </div>
              <div style="text-align:center;margin-top:15px;">
                <button id="btnRunAnalysis" class="btn" style="width:200px;" disabled>
                  <span>‚ñ∂Ô∏è Run Analysis</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Users Tab -->
          <div id="tab-users" class="tab-content">
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">üë• User Details</h2>
                <div style="display:flex;gap:10px;align-items:center;">
                  <input type="text" id="userSearch" placeholder="üîç Search users..." style="width:250px;padding:10px;">
                  <select id="userFilter" style="width:150px;padding:10px;">
                    <option value="all">All Users</option>
                    <option value="agent">Agents Only</option>
                    <option value="supervisor">Supervisors Only</option>
                    <option value="admin">Admins Only</option>
                    <option value="other">Others Only</option>
                    <option value="named">Named Licence</option>
                    <option value="hi">HI Licence</option>
                    <option value="nologin">NOLOGIN</option>
                  </select>
                  <div style="font-size:12px;color:var(--text-light);">
                    <span id="visibleCount">0</span>/<span id="totalCount">0</span> users
                  </div>
                </div>
              </div>

              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>User Name</th>
                      <th>Email</th>
                      <th>Team</th>
                      <th>Role Type</th>
                      <th>Last Login</th>
                      <th>Hours</th>
                      <th>Licence</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="usersTableBody">
                    <tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-light);">
                      No data loaded. Connect and fetch data first.
                    </td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Analysis Tab -->
          <div id="tab-analysis" class="tab-content">
            <div class="card">
              <h2>üìä Licence Distribution</h2>
              <div style="height:300px;position:relative;margin-top:20px;">
                <canvas id="licenseChart"></canvas>
              </div>
            </div>

            <div class="stats-grid" style="margin-top:20px;">
              <div class="card">
                <h3 style="margin:0 0 15px;">üí∞ Cost Analysis</h3>
                <div style="text-align:center;padding:20px;">
                  <div style="font-size:32px;font-weight:700;color:var(--primary-color);" id="totalCost">$0</div>
                  <div style="font-size:14px;color:var(--text-light);">Monthly Cost</div>
                  <div style="margin-top:15px;font-size:12px;color:var(--success);" id="savings">0% savings</div>
                </div>
              </div>

              <div class="card">
                <h3 style="margin:0 0 15px;">üìã Recommendation</h3>
                <div style="text-align:center;padding:20px;">
                  <div style="font-size:24px;font-weight:700;color:var(--primary-color);margin:10px 0;" id="licenseModel">Hybrid</div>
                  <div style="font-size:14px;color:var(--text-light);">Optimal Model</div>
                  <div style="margin-top:15px;font-size:12px;color:var(--text-light);">
                    Based on hour distribution and business rules
                  </div>
                </div>
              </div>
            </div>

            <!-- Role-based Analysis -->
            <div class="card" style="margin-top:20px;">
              <h2>üéØ Role-based Analysis</h2>
              <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));">
                <div class="stat-card">
                  <div class="stat-label">Agent Named</div>
                  <div class="stat-value" id="statAgentNamed">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Agents with Named</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Agent HI</div>
                  <div class="stat-value" id="statAgentHI">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Agents with HI</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Supervisor Named</div>
                  <div class="stat-value" id="statSupervisorNamed">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Supervisors with Named</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Admin Named</div>
                  <div class="stat-value" id="statAdminNamed">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Admins with Named</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Logs Tab -->
          <div id="tab-logs" class="tab-content">
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">üìù System Logs</h2>
                <div>
                  <button id="btnClearLogs" class="btn" style="padding:8px 16px;">Clear Logs</button>
                  <button id="btnCopyLogs" class="btn" style="padding:8px 16px;">Copy Logs</button>
                </div>
              </div>

              <div class="table-container" style="max-height:400px;">
                <table>
                  <thead>
                    <tr>
                      <th width="100">Time</th>
                      <th width="100">Level</th>
                      <th>Message</th>
                      <th width="150">Details</th>
                    </tr>
                  </thead>
                  <tbody id="logsTableBody">
                    <tr>
                      <td>--:--:--</td>
                      <td>üîµ INFO</td>
                      <td>System initialised</td>
                      <td>Ready for connection</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-size:18px;font-weight:600;margin-bottom:10px;">Connecting...</div>
    <div id="loadingSubtext" style="font-size:14px;color:var(--text-light);text-align:center;max-width:400px;"></div>
    <div class="progress-container" style="margin-top:20px;">
      <div class="progress-bar">
        <div class="progress-fill" id="loadingProgressFill"></div>
      </div>
    </div>
  </div>

  <!-- Use a local version of Chart.js to avoid tracking prevention issues -->
  <script src="https://unpkg.com/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
    // ==============================================
    // OAuth Configuration
    // ==============================================
    const CONFIG = {
      clientId: 'd968eca4-cdb7-4b90-91b1-4628b5bb679e',
      redirectUri: 'https://gmcglynn88.github.io/Hourly_Billing/',
      environment: 'https://api.euw2.pure.cloud',  // Locked to London
      autoAuth: true  // Force auto-authentication
    };

    // Storage keys for auto-authentication
    const STORAGE_KEYS = {
      ENVIRONMENT: 'gc_environment',
      TOKEN: 'gc_token',
      TOKEN_EXPIRY: 'gc_token_expiry',
      REFRESH_TOKEN: 'gc_refresh_token',
      AUTO_AUTH_ATTEMPTED: 'gc_auto_auth_attempted'
    };

    let CURRENT_CONFIG = {
      environment: '',
      token: null,
      tokenExpiry: null,
      refreshToken: null
    };

    // ==============================================
    // APPLICATION STATE
    // ==============================================
    let appState = {
      isConnected: false,
      userData: [],
      analysisResults: null,
      isAnalyzing: false,
      currentTab: 'dashboard',
      logs: [],
      chartInstances: {}
    };

    // ==============================================
    // DOM ELEMENTS
    // ==============================================
    const el = {
      // Auth Elements
      authContainer: document.getElementById('authContainer'),
      environment: document.getElementById('environment'),
      btnAuthenticate: document.getElementById('btnAuthenticate'),
      manualAuthSection: document.getElementById('manualAuthSection'),
      btnDisconnect: document.getElementById('btnDisconnect'),
      envDisplay: document.getElementById('envDisplay'),

      // Connection
      statusIndicator: document.getElementById('statusIndicator'),
      statusText: document.getElementById('statusText'),
      mainContent: document.getElementById('mainContent'),

      // Actions
      btnFetchData: document.getElementById('btnFetchData'),
      btnAnalyze: document.getElementById('btnAnalyze'),
      btnExport: document.getElementById('btnExport'),
      btnReset: document.getElementById('btnReset'),
      btnRunAnalysis: document.getElementById('btnRunAnalysis'),

      // Date/Params
      dateFrom: document.getElementById('dateFrom'),
      dateTo: document.getElementById('dateTo'),
      thresholdHours: document.getElementById('thresholdHours'),
      includeNologin: document.getElementById('includeNologin'),

      // Stats Display
      statTotalUsers: document.getElementById('statTotalUsers'),
      statActiveUsers: document.getElementById('statActiveUsers'),
      statNamedUsers: document.getElementById('statNamedUsers'),
      statHiUsers: document.getElementById('statHiUsers'),
      statAgents: document.getElementById('statAgents'),
      statSupervisors: document.getElementById('statSupervisors'),
      statAdmins: document.getElementById('statAdmins'),
      statOthers: document.getElementById('statOthers'),
      statAgentNamed: document.getElementById('statAgentNamed'),
      statAgentHI: document.getElementById('statAgentHI'),
      statSupervisorNamed: document.getElementById('statSupervisorNamed'),
      statAdminNamed: document.getElementById('statAdminNamed'),
      totalCost: document.getElementById('totalCost'),
      savings: document.getElementById('savings'),
      licenseModel: document.getElementById('licenseModel'),

      // Tables
      usersTableBody: document.getElementById('usersTableBody'),
      userSearch: document.getElementById('userSearch'),
      userFilter: document.getElementById('userFilter'),
      visibleCount: document.getElementById('visibleCount'),
      totalCount: document.getElementById('totalCount'),
      logsTableBody: document.getElementById('logsTableBody'),
      btnClearLogs: document.getElementById('btnClearLogs'),
      btnCopyLogs: document.getElementById('btnCopyLogs'),

      // Progress
      progressLabel: document.getElementById('progressLabel'),
      progressPercent: document.getElementById('progressPercent'),
      progressFill: document.getElementById('progressFill'),
      hourBuckets: document.getElementById('hourBuckets'),

      // Loading
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingText: document.getElementById('loadingText'),
      loadingSubtext: document.getElementById('loadingSubtext'),
      loadingProgressFill: document.getElementById('loadingProgressFill'),

      // Status Container
      statusContainer: document.getElementById('statusContainer')
    };

    // ==============================================
    // AUTO-AUTHENTICATION SYSTEM
    // ==============================================
    function loadStoredCredentials() {
      try {
        const token = localStorage.getItem(STORAGE_KEYS.TOKEN);
        const tokenExpiry = localStorage.getItem(STORAGE_KEYS.TOKEN_EXPIRY);
        const environment = localStorage.getItem(STORAGE_KEYS.ENVIRONMENT);
        const refreshToken = localStorage.getItem(STORAGE_KEYS.REFRESH_TOKEN);

        if (token && tokenExpiry && environment) {
          CURRENT_CONFIG = {
            token,
            tokenExpiry: parseInt(tokenExpiry, 10),
            environment,
            refreshToken
          };

          // Check if token is still valid (with 5-minute buffer)
          if (Date.now() < CURRENT_CONFIG.tokenExpiry - (5 * 60 * 1000)) {
            return true;
          }

          // Token expired, try to refresh if we have refresh token
          if (refreshToken) {
            return false; // Will trigger refresh
          }
        }
      } catch (e) {
        console.warn('Failed to load stored credentials:', e);
      }

      return false;
    }

    function saveCredentials(token, expiresIn, environment, refreshToken = null) {
      try {
        const tokenExpiry = Date.now() + (parseInt(expiresIn, 10) * 1000);

        CURRENT_CONFIG = {
          token,
          tokenExpiry,
          environment,
          refreshToken
        };

        localStorage.setItem(STORAGE_KEYS.TOKEN, token);
        localStorage.setItem(STORAGE_KEYS.TOKEN_EXPIRY, tokenExpiry.toString());
        localStorage.setItem(STORAGE_KEYS.ENVIRONMENT, environment);

        if (refreshToken) {
          localStorage.setItem(STORAGE_KEYS.REFRESH_TOKEN, refreshToken);
        }

        return true;
      } catch (e) {
        console.error('Failed to save credentials:', e);
        return false;
      }
    }

    function clearCredentials() {
      try {
        localStorage.removeItem(STORAGE_KEYS.TOKEN);
        localStorage.removeItem(STORAGE_KEYS.TOKEN_EXPIRY);
        localStorage.removeItem(STORAGE_KEYS.ENVIRONMENT);
        localStorage.removeItem(STORAGE_KEYS.REFRESH_TOKEN);
        localStorage.removeItem(STORAGE_KEYS.AUTO_AUTH_ATTEMPTED);

        CURRENT_CONFIG = {
          environment: '',
          token: null,
          tokenExpiry: null,
          refreshToken: null
        };
      } catch (e) {
        console.error('Failed to clear credentials:', e);
      }
    }

    async function attemptTokenRefresh() {
      if (!CURRENT_CONFIG.refreshToken || !CURRENT_CONFIG.environment) {
        return false;
      }

      try {
        const loginHost = getLoginHost(CURRENT_CONFIG.environment);
        const response = await fetch(`${loginHost}/oauth/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': 'Basic ' + btoa(`${CONFIG.clientId}:`)
          },
          body: new URLSearchParams({
            grant_type: 'refresh_token',
            refresh_token: CURRENT_CONFIG.refreshToken
          })
        });

        if (response.ok) {
          const data = await response.json();
          saveCredentials(
            data.access_token,
            data.expires_in,
            CURRENT_CONFIG.environment,
            data.refresh_token || CURRENT_CONFIG.refreshToken
          );

          logMessage('SUCCESS', 'Token refreshed successfully');
          return true;
        }
      } catch (error) {
        console.warn('Token refresh failed:', error);
      }

      return false;
    }

    // ==============================================
    // AUTHENTICATION - OAuth Implicit Grant Flow
    // ==============================================
    function parseTokenFromHash() {
      const params = new URLSearchParams(window.location.hash.replace(/^#/, ''));
      return {
        token: params.get('access_token'),
        refreshToken: params.get('refresh_token'),
        error: params.get('error'),
        errorDescription: params.get('error_description'),
        expiresIn: params.get('expires_in')
      };
    }

    function getLoginHost(environment) {
      return environment.replace('api.', 'login.');
    }

    function authUrl(environment) {
      const loginHost = getLoginHost(environment);
      // Request offline_access scope to get refresh token
      return `${loginHost}/oauth/authorize?client_id=${encodeURIComponent(CONFIG.clientId)}&response_type=token&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}&scope=offline_access`;
    }

    // ‚úÖ UPDATED initAuth() (locked to London + auto-auth)
    async function initAuth() {
      // Show auth container while we check
      el.authContainer.style.display = 'block';

      // Check if we have a token in the URL hash (returning from OAuth)
      const { token, refreshToken, error, errorDescription, expiresIn } = parseTokenFromHash();

      // Clear hash from URL
      if (window.location.hash) {
        history.replaceState(null, '', window.location.pathname + window.location.search);
      }

      if (token) {
        // We just returned from OAuth with a token - always use London region
        if (saveCredentials(token, expiresIn || '3600', CONFIG.environment, refreshToken)) {
          logMessage('SUCCESS', 'Authentication successful', `Connected to ${CONFIG.environment}`);
          showStatusMessage('‚úÖ Connected to Genesys Cloud', 'success');
          showMainApp();
          return;
        }
      }

      if (error) {
        logMessage('ERROR', 'Authentication failed', `${error}: ${errorDescription}`);
        showStatusMessage(`‚ùå Authentication failed: ${error}`, 'error');
        // Auto-retry authentication after showing error
        setTimeout(() => {
          authenticate();
        }, 2000);
        return;
      }

      // Try to auto-authenticate with stored credentials
      const hasValidToken = loadStoredCredentials();

      if (hasValidToken) {
        // We have a valid stored token
        logMessage('INFO', 'Auto-authentication successful', 'Using stored credentials');
        setTimeout(() => {
          showMainApp();
        }, 500);
        return;
      }

      // Try to refresh token
      const refreshSuccess = await attemptTokenRefresh();
      if (refreshSuccess) {
        logMessage('SUCCESS', 'Token refreshed', 'Auto-authentication successful');
        setTimeout(() => {
          showMainApp();
        }, 500);
        return;
      }

      // No valid credentials - auto-redirect to OAuth
      logMessage('INFO', 'No valid credentials found', 'Redirecting to authentication...');
      setTimeout(() => {
        authenticate();
      }, 1500);
    }

    // ‚úÖ UPDATED showManualAuth() (never shows manual section)
    function showManualAuth() {
      // Don't show manual auth section - just auto-authenticate
      logMessage('INFO', 'Initiating automatic authentication', 'Redirecting to Genesys Cloud...');
      setTimeout(() => {
        authenticate();
      }, 1000);
    }

    // ‚úÖ UPDATED authenticate() (always London)
    function authenticate() {
      // Always use London region
      const environment = CONFIG.environment;

      // Store environment in localStorage
      localStorage.setItem(STORAGE_KEYS.ENVIRONMENT, environment);
      CURRENT_CONFIG.environment = environment;

      // Redirect to Genesys Cloud for authentication
      window.location.href = authUrl(environment);
    }

    function checkTokenExpiry() {
      if (!CURRENT_CONFIG.token || !CURRENT_CONFIG.tokenExpiry) {
        return false;
      }

      // Check if token expires in less than 5 minutes
      if (Date.now() > CURRENT_CONFIG.tokenExpiry - (5 * 60 * 1000)) {
        logMessage('WARN', 'Token expired or about to expire', 'Need to refresh authentication');
        return false;
      }

      return true;
    }

    function showMainApp() {
      el.authContainer.style.display = 'none';
      el.mainContent.style.display = 'block';

      // ‚úÖ UPDATED environment display (fixed to London)
      const envName = 'EU West (London) - euw2.pure.cloud';
      el.envDisplay.value = envName;

      updateConnectionStatus(true, 'Connected ‚úì');
      initializeApp();
    }

    function disconnect() {
      if (confirm('Disconnect from Genesys Cloud? This will clear all stored credentials.')) {
        // Clear all data
        clearCredentials();

        appState = {
          isConnected: false,
          userData: [],
          analysisResults: null,
          isAnalyzing: false,
          currentTab: 'dashboard',
          logs: [],
          chartInstances: {}
        };

        // Reset UI
        el.mainContent.style.display = 'none';
        el.authContainer.style.display = 'block';

        updateConnectionStatus(false, 'Not Connected');
        logMessage('INFO', 'Disconnected from Genesys Cloud');

        // Auto-start auth again
        setTimeout(() => {
          initAuth();
        }, 500);
      }
    }

    function getEnvironmentName(url) {
      const envMap = {
        'https://api.euw2.pure.cloud': 'EU West (London) - euw2.pure.cloud',
        'https://api.mypurecloud.ie': 'Ireland - mypurecloud.ie',
        'https://api.mypurecloud.com': 'US East - mypurecloud.com',
        'https://api.usw2.pure.cloud': 'US West - usw2.pure.cloud',
        'https://api.cac1.pure.cloud': 'Canada - cac1.pure.cloud',
        'https://api.apne2.pure.cloud': 'Australia - apne2.pure.cloud'
      };

      return envMap[url] || url;
    }

    function updateConnectionStatus(connected, message = '') {
      appState.isConnected = connected;

      if (connected) {
        el.statusIndicator.style.background = 'var(--success)';
        el.statusText.textContent = message || 'Connected ‚úì';
        el.statusText.style.color = 'var(--success)';
        el.btnFetchData.disabled = false;
      } else {
        el.statusIndicator.style.background = 'var(--danger)';
        el.statusText.textContent = message || 'Not Connected';
        el.statusText.style.color = 'var(--danger)';
        el.btnFetchData.disabled = true;
      }
    }

    // ==============================================
    // UTILITY FUNCTIONS
    // ==============================================
    function setLoading(show, text = '', subtext = '') {
      if (show) {
        el.loadingText.textContent = text;
        el.loadingSubtext.textContent = subtext;
        el.loadingOverlay.classList.add('active');
      } else {
        el.loadingOverlay.classList.remove('active');
      }
    }

    function updateProgress(label, percent) {
      el.progressLabel.textContent = label;
      el.progressPercent.textContent = `${percent}%`;
      el.progressFill.style.width = `${percent}%`;
    }

    function updateLoadingProgress(percent) {
      el.loadingProgressFill.style.width = `${percent}%`;
    }

    function logMessage(level, message, details = '') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { timestamp, level, message, details };
      appState.logs.unshift(logEntry);

      // Update logs table
      const row = document.createElement('tr');
      const levelIcon = level === 'ERROR' ? 'üî¥' :
                      level === 'WARN' ? 'üü°' :
                      level === 'SUCCESS' ? '‚úÖ' : 'üîµ';

      row.innerHTML = `
        <td>${timestamp}</td>
        <td>${levelIcon} ${level}</td>
        <td>${message}</td>
        <td>${details}</td>
      `;

      el.logsTableBody.prepend(row);

      // Keep only last 50 logs
      if (el.logsTableBody.children.length > 50) {
        el.logsTableBody.removeChild(el.logsTableBody.lastChild);
      }

      // Show important messages in status container
      if (level === 'ERROR' || level === 'SUCCESS' || level === 'WARN') {
        showStatusMessage(message, level.toLowerCase());
      }

      console.log(`[${level}] ${message}`, details);
    }

    function showStatusMessage(message, type = 'info') {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'status-message';

      const icon = type === 'success' ? '‚úÖ' :
                  type === 'error' ? '‚ùå' :
                  type === 'warn' ? '‚ö†Ô∏è' : 'üí°';
      const color = type === 'success' ? 'var(--success)' :
                   type === 'error' ? 'var(--danger)' :
                   type === 'warn' ? 'var(--warning)' : 'var(--info)';

      msgDiv.style.borderLeftColor = color;
      msgDiv.innerHTML = `
        <span style="font-size:20px;">${icon}</span>
        <div>
          <div style="font-weight:600;">${message}</div>
          <div style="font-size:12px;color:var(--text-light);">${new Date().toLocaleTimeString()}</div>
        </div>
      `;

      el.statusContainer.appendChild(msgDiv);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (msgDiv.parentNode) {
          msgDiv.style.opacity = '0';
          msgDiv.style.transform = 'translateX(100%)';
          setTimeout(() => msgDiv.remove(), 300);
        }
      }, 5000);
    }

    // ==============================================
    // API HELPER
    // ==============================================
    async function apiCall(path, options = {}) {
      // First check token validity
      if (!checkTokenExpiry()) {
        // Try to refresh token
        const refreshSuccess = await attemptTokenRefresh();
        if (!refreshSuccess) {
          throw new Error('Authentication token expired. Please reconnect.');
        }
      }

      if (!CURRENT_CONFIG.token) throw new Error('Not authenticated');

      const url = `${CURRENT_CONFIG.environment}${path}`;

      const response = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `Bearer ${CURRENT_CONFIG.token}`,
          'Content-Type': 'application/json',
          ...options.headers
        }
      });

      if (response.status === 401 || response.status === 403) {
        throw new Error(`Authentication error (${response.status}). Please reconnect.`);
      }

      if (response.status === 429) {
        const retryAfter = response.headers.get('Retry-After') || 5;
        logMessage('WARN', `Rate limit exceeded`, `Retrying after ${retryAfter} seconds`);
        await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
        return apiCall(path, options); // Retry
      }

      if (!response.ok) {
        const errorText = await response.text().catch(() => '');
        throw new Error(`API Error: ${response.status} ${response.statusText}${errorText ? ` - ${errorText.slice(0,200)}` : ''}`);
      }

      return response.json();
    }

    // ==============================================
    // USER ROLE DETECTION
    // ==============================================
    function detectUserRole(roles) {
      if (!roles || !Array.isArray(roles)) return 'other';

      const roleNames = roles.map(r => r.name.toLowerCase());

      // Check for admin roles first
      const adminKeywords = ['admin', 'administrator', 'system administrator', 'org admin'];
      if (roleNames.some(role => adminKeywords.some(keyword => role.includes(keyword)))) {
        return 'admin';
      }

      // Check for supervisor roles
      const supervisorKeywords = ['supervisor', 'team lead', 'manager', 'director', 'lead'];
      if (roleNames.some(role => supervisorKeywords.some(keyword => role.includes(keyword)))) {
        return 'supervisor';
      }

      // Check for agent roles
      const agentKeywords = ['agent', 'user', 'employee', 'representative', 'customer service'];
      if (roleNames.some(role => agentKeywords.some(keyword => role.includes(keyword)))) {
        return 'agent';
      }

      return 'other';
    }

    // ==============================================
    // DATA FETCHING
    // ==============================================
    async function fetchUserData() {
      setLoading(true, 'Fetching User Data', 'Retrieving user interaction data from Genesys Cloud...');
      updateLoadingProgress(10);

      try {
        const dateFrom = el.dateFrom.value;
        const dateTo = el.dateTo.value;

        if (!dateFrom || !dateTo) {
          throw new Error('Please select a date range');
        }

        // First, get all users with expanded fields including dateLastLogin
        updateLoadingProgress(20);
        logMessage('INFO', 'Fetching user list with expanded fields');

        let allUsers = [];
        let page = 1;
        const pageSize = 100;

        while (true) {
          // Updated API call with dateLastLogin in expand
          const usersData = await apiCall(`/api/v2/users?pageSize=${pageSize}&pageNumber=${page}&expand=dateLastLogin,organization,presence,conversationSummary,routingStatus,authorization,locations,groups,skills,profiles,employerInfo,biography`);
          const users = usersData?.entities || [];
          allUsers = allUsers.concat(users);

          if (!usersData?.nextUri || users.length < pageSize) break;
          page++;

          // Add delay to avoid rate limiting
          await new Promise(resolve => setTimeout(resolve, 200));
          updateLoadingProgress(20 + (page * 10));
        }

        updateLoadingProgress(40);
        logMessage('INFO', `Loaded ${allUsers.length} users from API`);

        // Process users with team information and role detection
        appState.userData = allUsers.map(user => {
          // Extract team information (first team name)
          const teamName = user.groups && user.groups.length > 0
            ? user.groups[0].name
            : 'Unassigned';

          // Get role names
          const roleNames = user.authorization?.roles
            ? user.authorization.roles.map(r => r.name).join(', ')
            : 'No role';

          // Detect user type based on roles
          const userType = detectUserRole(user.authorization?.roles);

          // Format last login date
          let lastLogin = 'Never';
          if (user.dateLastLogin) {
            const loginDate = new Date(user.dateLastLogin);
            lastLogin = loginDate.toLocaleDateString();
          }

          return {
            id: user.id,
            name: user.name || 'Unknown',
            email: user.email || 'No email',
            team: teamName,
            role: roleNames,
            userType: userType,
            lastLogin: lastLogin,
            rawLastLogin: user.dateLastLogin,
            interactingHours: 0, // Will be fetched separately
            isSupervisor: userType === 'supervisor' || userType === 'admin',
            status: user.presence?.presenceDefinition?.systemPresence || 'Unknown'
          };
        });

        // Now fetch interaction data
        updateLoadingProgress(50);
        logMessage('INFO', 'Fetching interaction data for all users');

        const interval = `${dateFrom}T00:00:00.000Z/${dateTo}T23:59:59.999Z`;
        const userIds = allUsers.map(u => u.id);

        // Create a single analytics job for all users
        try {
          const jobBody = {
            interval: interval,
            presenceFilters: [{
              type: "and",
              clauses: [{
                type: "or",
                predicates: [{
                  dimension: "systemPresence",
                  operator: "matches",
                  value: "AVAILABLE"
                }, {
                  dimension: "systemPresence",
                  operator: "matches",
                  value: "ON_QUEUE"
                }]
              }]
            }],
            routingStatusFilters: [{
              type: "and",
              predicates: [{
                dimension: "routingStatus",
                value: "INTERACTING"
              }]
            }],
            userFilters: [{
              type: "and",
              predicates: userIds.map(userId => ({
                dimension: "userId",
                operator: "matches",
                value: userId
              }))
            }]
          };

          updateLoadingProgress(60);
          const jobResponse = await apiCall('/api/v2/analytics/users/details/jobs', {
            method: 'POST',
            body: JSON.stringify(jobBody)
          });

          if (jobResponse.id) {
            // Poll for job completion
            let jobStatus = 'PENDING';
            let attempts = 0;
            const maxAttempts = 60; // 2 minutes max

            while (jobStatus !== 'COMPLETED' && attempts < maxAttempts) {
              await new Promise(resolve => setTimeout(resolve, 2000));
              const statusResponse = await apiCall(`/api/v2/analytics/users/details/jobs/${jobResponse.id}`);
              jobStatus = statusResponse.state;
              attempts++;

              updateLoadingProgress(60 + (attempts / maxAttempts * 30));

              if (jobStatus === 'FAILED') {
                throw new Error('Analytics job failed');
              }

              if (jobStatus === 'COMPLETED') {
                break;
              }
            }

            if (jobStatus === 'COMPLETED') {
              // Fetch results
              updateLoadingProgress(90);
              const resultsResponse = await apiCall(`/api/v2/analytics/users/details/jobs/${jobResponse.id}/results?pageSize=1000`);
              const results = resultsResponse.results || [];

              // Create a map of user hours
              const userHoursMap = {};
              results.forEach(record => {
                const userId = record.userId;
                const hours = (record.totalDuration || 0) / 3600000; // Convert ms to hours
                if (!userHoursMap[userId]) {
                  userHoursMap[userId] = 0;
                }
                userHoursMap[userId] += hours;
              });

              // Update user data with hours
              appState.userData.forEach(user => {
                user.interactingHours = parseFloat((userHoursMap[user.id] || 0).toFixed(2));
              });

              logMessage('INFO', 'Analytics job completed', `Processed ${results.length} interaction records`);
            }
          }
        } catch (analyticsError) {
          logMessage('WARN', 'Analytics job failed or timed out', 'Using fallback method - analysing user list only');
          // Continue with user list even if analytics fails
        }

        updateLoadingProgress(95);

        // Update user type statistics
        updateUserTypeStats();

        logMessage('SUCCESS', 'Data loaded successfully', `${appState.userData.length} users loaded`);

        // Update UI
        el.statTotalUsers.textContent = appState.userData.length;
        el.totalCount.textContent = appState.userData.length;
        el.visibleCount.textContent = appState.userData.length;
        el.btnAnalyze.disabled = false;
        el.btnRunAnalysis.disabled = false;

        // Display initial user table
        renderUserTable();
        updateHourBuckets();

        updateLoadingProgress(100);
        await new Promise(resolve => setTimeout(resolve, 500));

        setLoading(false);
        showStatusMessage(`‚úÖ Loaded ${appState.userData.length} users`, 'success');

      } catch (error) {
        setLoading(false);
        logMessage('ERROR', 'Failed to fetch data', error.message);
        showStatusMessage('‚ùå Failed to fetch data', 'error');
      }
    }

    function updateUserTypeStats() {
      const agents = appState.userData.filter(u => u.userType === 'agent').length;
      const supervisors = appState.userData.filter(u => u.userType === 'supervisor').length;
      const admins = appState.userData.filter(u => u.userType === 'admin').length;
      const others = appState.userData.filter(u => u.userType === 'other').length;

      el.statAgents.textContent = agents;
      el.statSupervisors.textContent = supervisors;
      el.statAdmins.textContent = admins;
      el.statOthers.textContent = others;
    }

    // ==============================================
    // ANALYSIS & CALCULATIONS
    // ==============================================
    async function runAnalysis() {
      if (appState.isAnalyzing) return;

      appState.isAnalyzing = true;
      el.btnRunAnalysis.disabled = true;
      el.btnRunAnalysis.innerHTML = '<span>‚è≥ Analysing...</span>';

      updateProgress('Starting analysis...', 10);

      try {
        const threshold = parseFloat(el.thresholdHours.value);
        const includeNologin = el.includeNologin.value === 'true';

        // Filter users
        updateProgress('Filtering users...', 30);
        let usersToAnalyze = appState.userData;
        if (!includeNologin) {
          usersToAnalyze = appState.userData.filter(u => u.interactingHours > 0 || u.rawLastLogin);
        }

        // Initialise recommendedLicence property for all users
        usersToAnalyze.forEach(user => {
          user.recommendedLicense = 'NOLOGIN'; // Default
          user.recommendedReason = 'No login activity';
        });

        // Analyse each user based on user type and hours
        updateProgress('Applying business rules...', 50);
        usersToAnalyze.forEach(user => {
          // Check if user has never logged in
          const hasNeverLoggedIn = !user.rawLastLogin && user.interactingHours === 0;

          if (hasNeverLoggedIn) {
            user.recommendedLicense = 'NOLOGIN';
            user.recommendedReason = 'Never logged in';
          } else if (user.userType === 'admin' || user.userType === 'supervisor') {
            // Admins and Supervisors always get Named licences
            user.recommendedLicense = 'Named';
            user.recommendedReason = `${user.userType === 'admin' ? 'Admin' : 'Supervisor'} role`;
          } else if (user.interactingHours > 0 && user.interactingHours < threshold) {
            // Agents with hours below threshold get HI
            user.recommendedLicense = 'HI';
            user.recommendedReason = `Under ${threshold} hours (${user.interactingHours}h)`;
          } else if (user.interactingHours >= threshold) {
            // Agents with hours above threshold get Named
            user.recommendedLicense = 'Named';
            user.recommendedReason = `Over ${threshold} hours (${user.interactingHours}h)`;
          } else if (user.interactingHours === 0 && user.rawLastLogin) {
            // Users who have logged in but have no interacting hours
            user.recommendedLicense = 'HI';
            user.recommendedReason = 'Logged in but no interaction hours';
          } else {
            user.recommendedLicense = 'NOLOGIN';
            user.recommendedReason = 'No activity detected';
          }

          // Cost calculation
          if (user.recommendedLicense === 'HI') {
            user.estimatedCost = user.interactingHours * 0.45;
          } else if (user.recommendedLicense === 'Named') {
            user.estimatedCost = 70;
          } else {
            user.estimatedCost = 0;
          }
        });

        // Calculate statistics
        updateProgress('Calculating statistics...', 70);
        const totalUsers = usersToAnalyze.length;
        const activeUsers = usersToAnalyze.filter(u => u.interactingHours > 0).length;
        const namedUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'Named').length;
        const hiUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'HI').length;
        const nologinUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'NOLOGIN').length;
        const totalHours = usersToAnalyze.reduce((sum, u) => sum + u.interactingHours, 0);

        // Role-based statistics
        const agentNamed = usersToAnalyze.filter(u => u.userType === 'agent' && u.recommendedLicense === 'Named').length;
        const agentHI = usersToAnalyze.filter(u => u.userType === 'agent' && u.recommendedLicense === 'HI').length;
        const supervisorNamed = usersToAnalyze.filter(u => u.userType === 'supervisor' && u.recommendedLicense === 'Named').length;
        const adminNamed = usersToAnalyze.filter(u => u.userType === 'admin' && u.recommendedLicense === 'Named').length;

        // Cost analysis
        const allNamedCost = totalUsers * 70;
        const hiHours = usersToAnalyze
          .filter(u => u.recommendedLicense === 'HI')
          .reduce((sum, u) => sum + u.interactingHours, 0);
        const hybridCost = (namedUsers * 70) + (hiHours * 0.45);
        const savings = allNamedCost > 0 ? ((allNamedCost - hybridCost) / allNamedCost * 100).toFixed(1) : 0;

        // Determine optimal model
        let optimalModel = 'Hybrid';
        if (hiUsers / totalUsers > 0.7) optimalModel = 'Mostly HI';
        else if (namedUsers / totalUsers > 0.7) optimalModel = 'Mostly Named';
        else if (hiUsers === 0) optimalModel = 'All Named';
        else if (namedUsers === 0) optimalModel = 'All HI';

        // Store results
        appState.analysisResults = {
          totalUsers,
          activeUsers,
          namedUsers,
          hiUsers,
          nologinUsers,
          totalHours: totalHours.toFixed(2),
          threshold,
          allNamedCost: allNamedCost.toFixed(0),
          hybridCost: hybridCost.toFixed(0),
          savings,
          optimalModel,
          agentNamed,
          agentHI,
          supervisorNamed,
          adminNamed,
          users: usersToAnalyze
        };

        // Update UI
        updateProgress('Updating display...', 90);
        el.statActiveUsers.textContent = activeUsers;
        el.statNamedUsers.textContent = namedUsers;
        el.statHiUsers.textContent = hiUsers;
        el.statAgentNamed.textContent = agentNamed;
        el.statAgentHI.textContent = agentHI;
        el.statSupervisorNamed.textContent = supervisorNamed;
        el.statAdminNamed.textContent = adminNamed;
        el.totalCost.textContent = `$${parseFloat(hybridCost).toFixed(0)}`;
        el.savings.textContent = `${savings}% savings`;
        el.licenseModel.textContent = optimalModel;

        // Update user table with recommendations
        renderUserTable();

        // Create chart
        updateProgress('Creating visualisation...', 95);
        createLicenseChart();

        updateProgress('Analysis complete!', 100);
        await new Promise(resolve => setTimeout(resolve, 1000));

        logMessage('SUCCESS', 'Analysis complete', `${namedUsers} Named, ${hiUsers} HI users`);
        showStatusMessage(`‚úÖ Analysis complete: ${savings}% cost savings`, 'success');

        el.btnExport.disabled = false;

      } catch (error) {
        logMessage('ERROR', 'Analysis failed', error.message);
        showStatusMessage('‚ùå Analysis failed', 'error');
      } finally {
        appState.isAnalyzing = false;
        el.btnRunAnalysis.disabled = false;
        el.btnRunAnalysis.innerHTML = '<span>‚ñ∂Ô∏è Run Analysis</span>';
        updateProgress('Ready to analyse', 0);
      }
    }

    // ==============================================
    // UI RENDERING
    // ==============================================
    function renderUserTable() {
      const tbody = el.usersTableBody;
      tbody.innerHTML = '';

      const searchTerm = el.userSearch.value.toLowerCase();
      const filterValue = el.userFilter.value;

      let usersToDisplay = appState.userData || [];

      // Apply search filter
      if (searchTerm) {
        usersToDisplay = usersToDisplay.filter(user =>
          (user.name && user.name.toLowerCase().includes(searchTerm)) ||
          (user.email && user.email.toLowerCase().includes(searchTerm)) ||
          (user.team && user.team.toLowerCase().includes(searchTerm)) ||
          (user.role && user.role.toLowerCase().includes(searchTerm)) ||
          (user.userType && user.userType.toLowerCase().includes(searchTerm)) ||
          (user.recommendedLicense && user.recommendedLicense.toLowerCase().includes(searchTerm))
        );
      }

      // Apply type filter
      if (filterValue !== 'all') {
        if (filterValue === 'named' || filterValue === 'hi' || filterValue === 'nologin') {
          usersToDisplay = usersToDisplay.filter(u => u.recommendedLicense === filterValue.toUpperCase());
        } else {
          usersToDisplay = usersToDisplay.filter(u => u.userType === filterValue);
        }
      }

      el.visibleCount.textContent = usersToDisplay.length;

      if (usersToDisplay.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="8" style="text-align:center;padding:40px;color:var(--text-light);">
            ${appState.userData.length === 0 ? 'No data loaded. Connect and fetch data first.' : 'No users match your search/filter.'}
          </td>
        `;
        tbody.appendChild(row);
        return;
      }

      usersToDisplay.forEach(user => {
        const row = document.createElement('tr');

        let licenseBadge = '';
        let badgeClass = '';

        if (user.recommendedLicense) {
          switch(user.recommendedLicense) {
            case 'Named':
              badgeClass = 'status-named';
              licenseBadge = `<span class="status-badge ${badgeClass}">Named</span>`;
              break;
            case 'HI':
              badgeClass = 'status-hi';
              licenseBadge = `<span class="status-badge ${badgeClass}">HI</span>`;
              break;
            case 'NOLOGIN':
              badgeClass = 'status-nologin';
              licenseBadge = `<span class="status-badge ${badgeClass}">NOLOGIN</span>`;
              break;
          }
        } else {
          // If no recommended licence yet, show based on hours
          if (user.interactingHours === 0) {
            licenseBadge = `<span class="status-badge status-nologin">NOLOGIN</span>`;
          } else {
            licenseBadge = `<span class="status-badge" style="background:rgba(108,117,125,0.15);color:var(--text-light);">Pending</span>`;
          }
        }

        // User type badge
        let userTypeBadge = '';
        switch(user.userType) {
          case 'agent':
            userTypeBadge = `<span class="status-badge" style="background:rgba(99,171,143,0.15);color:var(--primary-color);">Agent</span>`;
            break;
          case 'supervisor':
            userTypeBadge = `<span class="status-badge" style="background:rgba(255,193,7,0.15);color:#d39e00;">Supervisor</span>`;
            break;
          case 'admin':
            userTypeBadge = `<span class="status-badge" style="background:rgba(220,53,69,0.15);color:var(--danger);">Admin</span>`;
            break;
          default:
            userTypeBadge = `<span class="status-badge" style="background:rgba(108,117,125,0.15);color:var(--text-light);">Other</span>`;
        }

        row.innerHTML = `
          <td>
            <div style="font-weight:600;">${user.name || 'Unknown'}</div>
            <div style="font-size:11px;color:var(--text-light);">ID: ${user.id?.substring(0, 8)}...</div>
          </td>
          <td>${user.email || 'No email'}</td>
          <td>${user.team || 'Unassigned'}</td>
          <td>
            ${userTypeBadge}
            <div style="font-size:11px;color:var(--text-light);margin-top:4px;">${user.role?.substring(0, 30) || 'No role'}${user.role && user.role.length > 30 ? '...' : ''}</div>
          </td>
          <td style="font-size:12px;color:${user.lastLogin === 'Never' ? 'var(--text-light)' : 'var(--success)'}">
            ${user.lastLogin}
          </td>
          <td style="text-align:center;font-weight:600;">
            ${(user.interactingHours || 0).toFixed(1)}
          </td>
          <td>${licenseBadge}</td>
          <td>
            <span style="font-size:11px;color:${user.status === 'AVAILABLE' ? 'var(--success)' : 'var(--text-light)'}">
              ${user.status || 'Unknown'}
            </span>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function updateHourBuckets() {
      const buckets = {
        '0h': 0,
        '1-10h': 0,
        '11-20h': 0,
        '21-30h': 0,
        '31-40h': 0,
        '41-50h': 0,
        '51-60h': 0,
        '61-70h': 0,
        '71-80h': 0,
        '81-90h': 0,
        '91-100h': 0,
        '100+h': 0
      };

      (appState.userData || []).forEach(user => {
        const hours = user.interactingHours || 0;
        if (hours === 0) buckets['0h']++;
        else if (hours <= 10) buckets['1-10h']++;
        else if (hours <= 20) buckets['11-20h']++;
        else if (hours <= 30) buckets['21-30h']++;
        else if (hours <= 40) buckets['31-40h']++;
        else if (hours <= 50) buckets['41-50h']++;
        else if (hours <= 60) buckets['51-60h']++;
        else if (hours <= 70) buckets['61-70h']++;
        else if (hours <= 80) buckets['71-80h']++;
        else if (hours <= 90) buckets['81-90h']++;
        else if (hours <= 100) buckets['91-100h']++;
        else buckets['100+h']++;
      });

      el.hourBuckets.innerHTML = '';

      Object.entries(buckets).forEach(([label, count]) => {
        const card = document.createElement('div');
        card.className = 'bucket-card';
        card.innerHTML = `
          <div class="bucket-count">${count}</div>
          <div class="bucket-label">${label}</div>
        `;
        el.hourBuckets.appendChild(card);
      });
    }

    function createLicenseChart() {
      const ctx = document.getElementById('licenseChart').getContext('2d');

      // Destroy existing chart
      if (appState.chartInstances.license) {
        appState.chartInstances.license.destroy();
      }

      if (!appState.analysisResults) return;

      const data = {
        labels: ['Named Users', 'HI Users', 'NOLOGIN Users'],
        datasets: [{
          data: [
            appState.analysisResults.namedUsers,
            appState.analysisResults.hiUsers,
            appState.analysisResults.nologinUsers
          ],
          backgroundColor: [
            'rgba(99, 171, 143, 0.8)',
            'rgba(40, 167, 69, 0.8)',
            'rgba(108, 117, 125, 0.8)'
          ],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      };

      appState.chartInstances.license = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} users (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // ==============================================
    // EXPORT FUNCTIONALITY
    // ==============================================
    function exportReport() {
      if (!appState.analysisResults) {
        showStatusMessage('Please run analysis first', 'warn');
        return;
      }

      const results = appState.analysisResults;

      // Create CSV content
      let csv = 'Genesys Cloud Hourly Billing Analysis Report\n';
      csv += `Generated: ${new Date().toLocaleString()}\n`;
      csv += `Period: ${el.dateFrom.value} to ${el.dateTo.value}\n`;
      csv += `HI Threshold: ${results.threshold} hours\n\n`;

      csv += 'SUMMARY\n';
      csv += 'Metric,Value\n';
      csv += `Total Users,${results.totalUsers}\n`;
      csv += `Active Users,${results.activeUsers}\n`;
      csv += `Named Users,${results.namedUsers}\n`;
      csv += `HI Users,${results.hiUsers}\n`;
      csv += `NOLOGIN Users,${results.nologinUsers}\n`;
      csv += `Total Hours,${results.totalHours}\n`;
      csv += `All Named Cost,$${results.allNamedCost}\n`;
      csv += `Hybrid Cost,$${results.hybridCost}\n`;
      csv += `Cost Savings,${results.savings}%\n`;
      csv += `Optimal Model,${results.optimalModel}\n\n`;

      csv += 'ROLE-BASED ANALYSIS\n';
      csv += 'Role Type,Metric,Value\n';
      csv += `Agent,Named Users,${results.agentNamed}\n`;
      csv += `Agent,HI Users,${results.agentHI}\n`;
      csv += `Supervisor,Named Users,${results.supervisorNamed}\n`;
      csv += `Admin,Named Users,${results.adminNamed}\n\n`;

      csv += 'USER DETAILS\n';
      csv += 'Name,Email,Team,Role Type,Roles,Last Login,Hours,Recommended Licence,Reason,Estimated Cost\n';

      results.users.forEach(user => {
        csv += `"${user.name || ''}","${user.email || ''}","${user.team || ''}","${user.userType || ''}","${user.role || ''}","${user.lastLogin || 'Never'}",${user.interactingHours || 0},"${user.recommendedLicense || ''}","${user.recommendedReason || ''}",${(user.estimatedCost || 0).toFixed(2)}\n`;
      });

      // Download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];

      a.href = url;
      a.download = `genesys_billing_analysis_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      logMessage('SUCCESS', 'Report exported', 'CSV file downloaded');
      showStatusMessage('‚úÖ Report exported to CSV', 'success');
    }

    // ==============================================
    // RESET FUNCTIONALITY
    // ==============================================
    function resetApplication() {
      if (confirm('Reset the application? This will clear all data but keep the connection.')) {
        // Clear data but keep connection
        appState.userData = [];
        appState.analysisResults = null;

        // Reset UI
        el.statTotalUsers.textContent = '0';
        el.statActiveUsers.textContent = '0';
        el.statNamedUsers.textContent = '0';
        el.statHiUsers.textContent = '0';
        el.statAgents.textContent = '0';
        el.statSupervisors.textContent = '0';
        el.statAdmins.textContent = '0';
        el.statOthers.textContent = '0';
        el.statAgentNamed.textContent = '0';
        el.statAgentHI.textContent = '0';
        el.statSupervisorNamed.textContent = '0';
        el.statAdminNamed.textContent = '0';
        el.totalCost.textContent = '$0';
        el.savings.textContent = '0% savings';
        el.licenseModel.textContent = 'Hybrid';
        el.totalCount.textContent = '0';
        el.visibleCount.textContent = '0';
        el.btnAnalyze.disabled = true;
        el.btnRunAnalysis.disabled = true;
        el.btnExport.disabled = true;

        // Clear tables
        el.usersTableBody.innerHTML = `
          <tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-light);">
            No data loaded. Connect and fetch data first.
          </td></tr>
        `;

        // Clear hour buckets
        el.hourBuckets.innerHTML = '';

        // Destroy chart
        if (appState.chartInstances.license) {
          appState.chartInstances.license.destroy();
        }

        logMessage('INFO', 'Application reset', 'All data cleared');
        showStatusMessage('üîÑ Application reset', 'info');
      }
    }

    // ==============================================
    // INITIALISATION
    // ==============================================
    function initializeApp() {
      // Set default dates
      const today = new Date();
      const lastMonth = new Date();
      lastMonth.setMonth(today.getMonth() - 1);

      el.dateTo.valueAsDate = today;
      el.dateFrom.valueAsDate = lastMonth;

      // Set max dates
      const todayStr = today.toISOString().split('T')[0];
      el.dateTo.max = todayStr;
      el.dateFrom.max = todayStr;

      // Event Listeners
      // (Authenticate button is not used in auto-auth mode, but harmless if kept)
      if (el.btnAuthenticate) el.btnAuthenticate.addEventListener('click', authenticate);

      el.btnDisconnect.addEventListener('click', disconnect);
      el.btnFetchData.addEventListener('click', fetchUserData);
      el.btnRunAnalysis.addEventListener('click', runAnalysis);
      el.btnAnalyze.addEventListener('click', runAnalysis);
      el.btnExport.addEventListener('click', exportReport);
      el.btnReset.addEventListener('click', resetApplication);

      // Quick date buttons
      document.querySelectorAll('.quick-select-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const days = parseInt(this.dataset.days, 10);
          const toDate = new Date();
          const fromDate = new Date();

          if (days === 0) {
            el.dateTo.valueAsDate = toDate;
            el.dateFrom.valueAsDate = toDate;
          } else {
            fromDate.setDate(toDate.getDate() - days);
            el.dateTo.valueAsDate = toDate;
            el.dateFrom.valueAsDate = fromDate;
          }

          logMessage('INFO', 'Date range updated', `Last ${days === 0 ? 'today' : days + ' days'}`);
        });
      });

      // User search and filter
      el.userSearch.addEventListener('input', renderUserTable);
      el.userFilter.addEventListener('change', renderUserTable);

      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          appState.currentTab = tabId;

          // Update active tab
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');

          // Show active content
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            if (content.id === `tab-${tabId}`) {
              content.classList.add('active');
            }
          });

          logMessage('INFO', 'Tab switched', tabId);
        });
      });

      // Logs buttons
      el.btnClearLogs.addEventListener('click', () => {
        el.logsTableBody.innerHTML = '';
        appState.logs = [];
        logMessage('INFO', 'Logs cleared');
      });

      el.btnCopyLogs.addEventListener('click', () => {
        const logText = appState.logs.map(log =>
          `${log.timestamp} [${log.level}] ${log.message} ${log.details ? '- ' + log.details : ''}`
        ).join('\n');

        navigator.clipboard.writeText(logText).then(() => {
          showStatusMessage('Logs copied to clipboard', 'success');
        });
      });

      // Initial log
      logMessage('INFO', 'Hourly Billing Calculator initialised', 'Ready for authentication');
    }

    // ==============================================
    // START APPLICATION
    // ==============================================
    document.addEventListener('DOMContentLoaded', function() {
      initAuth();
    });
  </script>
</body>
</html>
