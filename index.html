<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Cloud - Hourly Interacting Calculator</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --filter-bg:#f0f7f3; --warning:#ffc107; --danger:#dc3545;
      --success:#28a745; --info:#17a2b8;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:0;
      background:var(--light-bg);color:var(--text-color);
      line-height:1.6;
    }

    .container{
      max-width:none;
      margin:0 20px;
      width:calc(100% - 40px);
    }
    
    header{
      background:var(--card-bg);border-radius:12px;padding:28px 36px;
      margin-bottom:28px;box-shadow:0 2px 8px rgba(0,0,0,.08);
      border-left:5px solid var(--primary-color);border:1px solid var(--border-color);
      margin-top:20px;
    }

    h1{color:var(--text-color);margin-bottom:12px;font-size:32px;font-weight:600;}
    .subtitle{color:var(--text-light);font-size:17px;}
    .main-grid{
      display:grid;
      grid-template-columns:400px 1fr;
      gap:32px;
      min-height:calc(100vh - 200px);
    }
    
    @media(max-width:1200px){
      .main-grid{grid-template-columns:1fr}
      .container{margin:0 15px;width:calc(100% - 30px);}
    }

    .card{
      background:var(--card-bg);border:1px solid var(--border-color);
      border-radius:14px;padding:28px;margin-bottom:20px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }

    .card h2{
      color:var(--primary-color);margin-bottom:24px;font-size:22px;
      padding-bottom:16px;border-bottom:2px solid var(--light-bg);
      display:flex;align-items:center;gap:12px;
      font-weight:600;
    }

    .form-group{margin-bottom:24px}
    label{display:block;font-weight:600;margin-bottom:8px;color:var(--text-color);font-size:14px;}
    select,input,button{
      padding:12px;border:1px solid var(--border-color);
      border-radius:8px;background:var(--card-bg);font-size:15px;width:100%;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }

    button{
      background:var(--primary-color);color:#fff;font-weight:600;
      cursor:pointer;transition:background .2s;border:none;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      font-size:15px;
    }

    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}
    .btn-block{width:100%;padding:14px}
    .btn-success{background:var(--success)}.btn-success:hover{background:#218838}
    .btn-secondary{background:var(--text-light)}.btn-secondary:hover{background:#5a6268}
    .btn-export{background:var(--info)}.btn-export:hover{background:#138496}

    .client-selector {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }
    
    .client-selector select {
      flex: 1;
      background: var(--filter-bg);
      font-weight: 600;
      border-color: var(--primary-color);
    }

    .status-container{
      position:fixed;top:20px;right:20px;z-index:1000;
      display:flex;flex-direction:column;gap:10px;
      max-width:400px;
    }

    .status-message{
      background:white;padding:16px;border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);border-left:4px solid var(--primary-color);
      animation:slideIn 0.3s ease-out;display:flex;align-items:center;gap:12px;
    }

    @keyframes slideIn{
      from{transform:translateX(100%);opacity:0}
      to{transform:translateX(0);opacity:1}
    }

    .stats-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:20px;margin-top:24px;
    }

    .stat-card{
      background:var(--pill);border-radius:14px;padding:24px;
      border:1px solid var(--border-color);text-align:center;
      transition:all 0.3s;
    }

    .stat-card:hover{
      transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.1);
      border-color:var(--primary-color);
    }

    .stat-value{
      font-size:38px;font-weight:700;color:var(--primary-color);
      margin:12px 0;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }

    .stat-label{
      font-size:15px;color:var(--text-light);
      text-transform:uppercase;letter-spacing:1px;
      font-weight:600;
    }

    .table-container{
      overflow-x:auto;margin-top:24px;border-radius:10px;
      border:1px solid var(--border-color);background:var(--card-bg);
      max-height:600px;overflow-y:auto;
    }

    table{width:100%;border-collapse:collapse}
    th{
      background-color:var(--primary-color);color:white;font-weight:600;
      position:sticky;top:0;z-index:10;white-space:nowrap;padding:18px;text-align:left;
      font-size:14px;
    }
    td{padding:16px 18px;border-bottom:1px solid var(--border-color);font-size:14px;}
    tr:hover{background-color:var(--pill)}

    .status-badge{
      display:inline-block;padding:6px 14px;border-radius:20px;
      font-size:13px;font-weight:600;text-transform:uppercase;
    }

    .status-named{background:rgba(99,171,143,0.15);color:var(--primary-color);border:1px solid rgba(99,171,143,0.3)}
    .status-hi{background:rgba(40,167,69,0.15);color:var(--success);border:1px solid rgba(40,167,69,0.3)}
    .status-supervisor{background:rgba(255,193,7,0.15);color:#d39e00;border:1px solid rgba(255,193,7,0.3)}
    .status-nologin{background:rgba(108,117,125,0.15);color:var(--text-light);border:1px solid rgba(108,117,125,0.3)}

    .tabs{
      display:flex;border-bottom:2px solid var(--border-color);
      margin-bottom:28px;background:white;border-radius:10px 10px 0 0;
    }

    .tab{
      padding:18px 28px;background:none;border:none;
      border-bottom:2px solid transparent;font-size:16px;
      font-weight:600;color:var(--text-light);cursor:pointer;
      transition:all 0.3s;flex:1;text-align:center;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }

    .tab:hover{color:var(--primary-color)}
    .tab.active{
      color:var(--primary-color);border-bottom-color:var(--primary-color);
      background:rgba(99,171,143,0.05);
    }

    .tab-content{display:none;animation:fadeIn 0.3s ease}
    .tab-content.active{display:block}

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    .loading-overlay{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.95);display:flex;
      flex-direction:column;justify-content:center;align-items:center;
      z-index:9999;display:none;
    }

    .loading-overlay.active{display:flex}
    .spinner{
      width:60px;height:60px;border:5px solid #f3f3f3;
      border-top:5px solid var(--primary-color);border-radius:50%;
      animation:spin 1s linear infinite;margin-bottom:20px;
    }

    @keyframes spin{to{transform:rotate(360deg)}}

    .progress-container{
      width:100%;max-width:500px;margin:20px auto;
    }

    .progress-bar{
      height:10px;background:var(--light-bg);border-radius:5px;
      overflow:hidden;margin-top:12px;
    }

    .progress-fill{
      height:100%;background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));
      border-radius:5px;transition:width 0.3s ease;
      width:0%;
    }

    .bucket-container{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
      gap:12px;margin-top:24px;
    }

    .bucket-card{
      background:white;border-radius:10px;padding:16px;
      border:1px solid var(--border-color);text-align:center;
      transition:all 0.3s ease;
    }

    .bucket-card:hover{
      transform:translateY(-3px);
      box-shadow:0 6px 12px rgba(0,0,0,0.1);
    }

    .bucket-count{
      font-size:28px;font-weight:700;color:var(--primary-color);
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }

    .bucket-agent-count{
      font-size:13px;color:var(--secondary-color);margin-top:6px;
    }

    .bucket-label{
      font-size:13px;color:var(--text-light);margin-top:6px;
    }

    @media(max-width:768px){
      body{margin:10px;padding:0}
      .card{padding:20px}
      header{padding:20px;margin-top:10px;}
      h1{font-size:28px}
      .btn-block{padding:12px 18px;font-size:15px}
      .stat-value{font-size:32px}
      .main-grid{grid-template-columns:1fr}
      .status-container{max-width:300px}
      .container{margin:0 10px;width:calc(100% - 20px);}
    }

    .hour-bar-chart {
      display: flex;
      align-items: flex-end;
      height: 240px;
      gap: 6px;
      margin-top: 24px;
      padding: 16px;
      background: var(--light-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }

    .hour-bar {
      flex: 1;
      background: var(--primary-color);
      border-radius: 6px 6px 0 0;
      min-height: 4px;
      position: relative;
      transition: all 0.3s ease;
    }

    .hour-bar:hover {
      background: var(--secondary-color);
      transform: scaleY(1.05);
    }

    .hour-bar-label {
      position: absolute;
      bottom: -30px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 12px;
      color: var(--text-light);
      transform: rotate(-45deg);
      transform-origin: left top;
      white-space: nowrap;
    }

    .hour-bar-value {
      position: absolute;
      top: -30px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-color);
    }

    .hour-distribution-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      margin-top: 24px;
    }

    @media (max-width: 1024px) {
      .hour-distribution-container {
        grid-template-columns: 1fr;
      }
    }

    .chart-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border-color);
    }
    
    .currency-selector {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 12px;
    }
    
    .currency-option {
      padding: 8px 14px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--light-bg);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }
    
    .currency-option:hover {
      background: var(--pill);
    }
    
    .currency-option.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    /* New styles for agent count tiles */
    .agent-count-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 12px;
      margin-top: 24px;
    }
    
    .agent-count-card {
      background: rgba(99, 171, 143, 0.1);
      border-radius: 10px;
      padding: 16px;
      border: 1px solid rgba(99, 171, 143, 0.3);
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .agent-count-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
      border-color: var(--primary-color);
    }
    
    .agent-count-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }
    
    .agent-count-label {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 6px;
    }
    
    .section-title {
      color: var(--primary-color);
      font-size: 20px;
      margin: 24px 0 12px 0;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
    }
    
    /* New styles for overage table */
    .overage-table-container {
      margin-top: 24px;
    }
    
    .overage-summary {
      background: rgba(220, 53, 69, 0.1);
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 18px;
      border: 1px solid rgba(220, 53, 69, 0.3);
    }
    
    .overage-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      background: rgba(220, 53, 69, 0.15);
      color: var(--danger);
      border: 1px solid rgba(220, 53, 69, 0.3);
    }
    
    .overage-hours {
      color: var(--danger);
      font-weight: 700;
    }
    
    .no-overage-message {
      text-align: center;
      padding: 48px;
      color: var(--text-light);
      font-style: italic;
      font-size: 15px;
    }

    /* FIXED: Date range styles - stacked on mobile, side-by-side on desktop */
    .date-range-simple {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .date-field-simple {
      position: relative;
    }
    
    .date-field-simple label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-color);
      font-size: 14px;
    }
    
    .date-field-simple input[type="date"] {
      padding: 14px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      font-size: 15px;
      width: 100%;
      transition: all 0.3s;
      color: var(--text-color);
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }
    
    .date-field-simple input[type="date"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 171, 143, 0.1);
    }
    
    @media (min-width: 768px) {
      .date-range-simple {
        flex-direction: row;
        gap: 16px;
      }
      
      .date-field-simple {
        flex: 1;
      }
    }

    /* Improved layout for better screen usage */
    .left-column {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    .full-width-section {
      width: 100%;
    }
    
    /* Enhanced typography */
    .info-text {
      font-size: 13px;
      color: var(--text-light);
      line-height: 1.5;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }
    
    /* Card content spacing */
    .card-content {
      padding: 4px 0;
    }
    
    /* Better spacing for form elements */
    .form-spacing {
      margin-top: 8px;
    }
    
    /* Ensure consistent font usage */
    input, select, textarea, button {
      font-family: 'Aptos', 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
    }
    
    /* Chart container improvements */
    .chart-container {
      height: 340px;
      position: relative;
      margin-top: 24px;
    }
    
    /* Wider layout for larger screens */
    @media (min-width: 1400px) {
      .container {
        max-width: 1600px;
        margin: 0 auto;
      }
      
      .main-grid {
        grid-template-columns: 420px 1fr;
        gap: 36px;
      }
      
      .card {
        padding: 32px;
      }
      
      header {
        padding: 32px 40px;
      }
    }
    
    @media (min-width: 1800px) {
      .container {
        max-width: 1800px;
      }
      
      .main-grid {
        grid-template-columns: 450px 1fr;
        gap: 40px;
      }
    }
    
    /* New styles for enhanced stat cards */
    .stat-subvalue {
      font-size: 16px;
      color: var(--secondary-color);
      font-weight: 600;
      margin-top: 8px;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }
    
    .stat-subtitle {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 4px;
    }

    /* Export button container styles */
    .export-buttons-container {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .btn-export-users {
      background: var(--info);
      padding: 10px 16px;
      font-size: 13px;
      width: auto;
    }
    
    .btn-export-overage {
      background: var(--warning);
      color: var(--text-color);
      padding: 10px 16px;
      font-size: 13px;
      width: auto;
    }
    
    .btn-export-users:hover {
      background: #138496;
    }
    
    .btn-export-overage:hover {
      background: #e0a800;
      color: var(--text-color);
    }
  </style>
</head>
<body>
  <div id="authContainer" style="display:none;">
    <div class="container" style="max-width:500px;margin:100px auto;">
      <div class="auth-card">
        <h3>üîê Genesys Cloud Authentication</h3>
        <div class="auto-auth-message">
          <div class="spinner" style="width:40px;height:40px;border-width:3px;"></div>
          <p style="margin-top:15px;font-size:14px;">Attempting automatic authentication...</p>
        </div>
      </div>
    </div>
  </div>

  <div class="status-container" id="statusContainer"></div>

  <div id="mainContent" style="display:none;">
    <div class="container">
      <header>
        <h1>üìä Genesys Cloud - Hourly Interacting Calculator</h1>
      </header>

      <div class="main-grid">
        <div class="left-column">
          <div class="card" id="connectionCard">
            <h2>üîå Connection Status</h2>
            <div class="form-group">
              <label>Environment</label>
              <input type="text" id="envDisplay" value="Select environment..." readonly style="background:var(--filter-bg);">
            </div>
            
            <!-- NEW: Client ID Selector -->
            <div class="client-selector">
              <select id="clientIdSelect">
                <option value="d968eca4-cdb7-4b90-91b1-4628b5bb679e">Group CX3 (Default)</option>
                <option value="a236ffec-2893-4ccd-81bb-ef2f4a2fe316">Group CX1</option>
              </select>
              <button id="btnSwitchClient" class="btn" style="width: auto; padding: 12px 20px; background: var(--info);">Switch</button>
            </div>
            
            <div class="form-group">
              <label>Status</label>
              <div style="display:flex;align-items:center;gap:10px;">
                <div id="statusIndicator" style="width:14px;height:14px;border-radius:50%;background:#6c757d;"></div>
                <span id="statusText">Not Connected</span>
              </div>
            </div>
            <button id="btnDisconnect" class="btn" style="margin-top:15px;background:var(--danger);">
              <span>üö™ Disconnect</span>
            </button>
          </div>

          <!-- Simplified Date Range Card - FIXED: Now stacked on mobile -->
          <div class="card">
            <h2>üìÖ Analysis Period</h2>
            
            <div class="date-range-simple">
              <div class="date-field-simple">
                <label for="dateFrom">From Date</label>
                <input type="date" id="dateFrom" required>
              </div>
              
              <div class="date-field-simple">
                <label for="dateTo">To Date</label>
                <input type="date" id="dateTo" required>
              </div>
            </div>
            
            <div id="dateRangeInfo" style="font-size:13px;color:var(--text-light);text-align:center;margin-top:12px;padding:10px;background:var(--pill);border-radius:6px;">
              Most Recent Month Selected
            </div>
            
            <div style="font-size:13px;color:var(--text-light);margin-top:16px;padding:14px;background:rgba(99,171,143,0.05);border-radius:8px;">
              <strong>üí° Tip:</strong> Select a date range to analyse. Defaults to most recent complete month.
            </div>
          </div>

          <div class="card">
            <h2>‚öôÔ∏è Business Rules</h2>
            <div class="form-group">
              <label for="thresholdHours">Hourly Interacting Threshold (hours/month)</label>
              <input type="number" id="thresholdHours" value="40" min="1" max="200">
              <div style="font-size:13px;color:var(--text-light);margin-top:6px;">
                Users below this threshold get Hourly Interacting licences
              </div>
            </div>
            <div class="form-group">
              <label for="namedLicenseCost">Named Licence Monthly Cost</label>
              <div style="display:flex;gap:12px;">
                <select id="currencySymbol" style="width:90px;">
                  <option value="¬£">¬£ GBP</option>
                  <option value="$">$ USD</option>
                  <option value="‚Ç¨">‚Ç¨ EUR</option>
                </select>
                <input type="number" id="namedLicenseCost" value="70" min="1" step="0.01" style="flex:1;">
              </div>
            </div>
            <div class="form-group">
              <label for="hourlyLicenseRate">Hourly Interacting Rate</label>
              <div style="display:flex;gap:12px;">
                <select id="hourlyCurrencySymbol" style="width:90px;">
                  <option value="¬£">¬£ GBP</option>
                  <option value="$">$ USD</option>
                  <option value="‚Ç¨">‚Ç¨ EUR</option>
                </select>
                <input type="number" id="hourlyLicenseRate" value="0.45" min="0.01" step="0.01" style="flex:1;">
              </div>
            </div>
            <div class="form-group">
              <label for="includeNologin">Include NOLOGIN Users</label>
              <select id="includeNologin">
                <option value="true">Yes - Include in totals</option>
                <option value="false">No - Exclude from analysis</option>
              </select>
            </div>
            <div style="background:rgba(99,171,143,0.05);padding:14px;border-radius:8px;margin-top:12px;">
              <div style="font-size:13px;color:var(--primary-color);font-weight:600;margin-bottom:6px;">üìã Calculation Logic:</div>
              <div style="font-size:12px;color:var(--text-light);line-height:1.5;">
                ‚Ä¢ Interacting time &gt; 0 but &lt; threshold = Hourly Interacting Licence<br>
                ‚Ä¢ Interacting time ‚â• threshold = Named Licence<br>
                ‚Ä¢ Admins/Supervisors = Named (always)<br>
                ‚Ä¢ NOLOGIN = No licence consumption (0 hours)<br>
                ‚Ä¢ Users with 0 hours = NOLOGIN (even if logged in)<br>
                ‚Ä¢ Based on total interacting time in selected period<br>
                ‚Ä¢ <strong>Hourly Interacting recommendation only applies to agents</strong>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>üöÄ Actions</h2>
            <button id="btnFetchData" class="btn btn-block" disabled>
              <span>üì• Fetch User Data</span>
            </button>
            <div style="height:14px;"></div>
            <button id="btnAnalyze" class="btn btn-success btn-block" disabled>
              <span>üßÆ Analyse & Calculate</span>
            </button>
            <div style="height:14px;"></div>
            <button id="btnExport" class="btn btn-secondary btn-block" disabled>
              <span>üìä Export Full Report</span>
            </button>
            <div style="height:14px;"></div>
            <button id="btnReset" class="btn btn-block" style="background:var(--danger);">
              <span>üîÑ Reset Session</span>
            </button>
          </div>
        </div>

        <div class="right-column">
          <div class="tabs">
            <button class="tab active" data-tab="dashboard">üìä Dashboard</button>
            <button class="tab" data-tab="users">üë• Users</button>
            <button class="tab" data-tab="analysis">üìà Analysis</button>
            <button class="tab" data-tab="logs">üìù Logs</button>
          </div>

          <div id="tab-dashboard" class="tab-content active">
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Total Users</div>
                <div class="stat-value" id="statTotalUsers">0</div>
                <div style="font-size:12px;color:var(--text-light);">Setup in org</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Active Users</div>
                <div class="stat-value" id="statActiveUsers">0</div>
                <div style="font-size:12px;color:var(--text-light);">Logged in period</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Recommended Named Users</div>
                <div class="stat-value" id="statNamedUsers">0</div>
                <div style="font-size:12px;color:var(--text-light);">Recommended based on 0hr interacting agents/supervisors + agents above threshold</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Recommended Hourly Interacting Users</div>
                <div class="stat-value" id="statHiUsers">0</div>
                <div class="stat-subvalue" id="statHiHours">0 hours</div>
                <div style="font-size:12px;color:var(--text-light);">Agents with &gt;0 hours but &lt; threshold</div>
              </div>
            </div>

            <div class="card" style="margin-top:24px;">
              <h2>üë• User Type Distribution</h2>
              <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr));">
                <div class="stat-card">
                  <div class="stat-label">Agents</div>
                  <div class="stat-value" id="statAgents">0</div>
                  <div style="font-size:12px;color:var(--text-light);">Agent role users</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Supervisors</div>
                  <div class="stat-value" id="statSupervisors">0</div>
                  <div style="font-size:12px;color:var(--text-light);">Supervisor role users</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Admins</div>
                  <div class="stat-value" id="statAdmins">0</div>
                  <div style="font-size:12px;color:var(--text-light);">Admin role users</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Others</div>
                  <div class="stat-value" id="statOthers">0</div>
                  <div style="font-size:12px;color:var(--text-light);">Other role users</div>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:24px;">
              <h2>‚è±Ô∏è Hour Distribution</h2>
              <div class="hour-distribution-container">
                <div>
                  <h3 class="section-title">üìä Total Hours per Bucket</h3>
                  <div class="bucket-container" id="hourBuckets"></div>
                  
                  <h3 class="section-title">üë• Agent Count per Bucket</h3>
                  <div class="agent-count-container" id="agentCounts"></div>
                  
                  <div style="margin-top:18px;font-size:13px;color:var(--text-light);text-align:center;">
                    <div>üìä <strong>Total Users: <span id="totalUsersCount">0</span></strong> | üë• <strong>Agents: <span id="totalAgentsCount">0</span></strong></div>
                    <div style="font-size:12px;margin-top:6px;">Hover over buckets to see details</div>
                  </div>
                </div>
              </div>
              <div id="hourStats" style="margin-top:18px;font-size:13px;color:var(--text-light);text-align:center;"></div>
            </div>

            <div class="card chart-section">
              <h2>üìä Hour Distribution Chart</h2>
              <p style="color:var(--text-light);font-size:15px;margin-bottom:24px;">
                Visual representation of user count by hour bucket range
              </p>
              <div class="hour-bar-chart" id="hourBarChart"></div>
              <div style="margin-top:18px;font-size:13px;color:var(--text-light);text-align:center;">
                <div>Hover over bars to see detailed breakdown</div>
              </div>
            </div>

            <div class="card" style="margin-top:24px;">
              <h2>üìà Analysis Progress</h2>
              <div class="progress-container">
                <div class="progress-text">
                  <span id="progressLabel">Ready to analyse</span>
                  <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill"></div>
                </div>
              </div>
              <div style="text-align:center;margin-top:18px;">
                <button id="btnRunAnalysis" class="btn" style="width:220px;" disabled>
                  <span>‚ñ∂Ô∏è Run Analysis</span>
                </button>
              </div>
            </div>
          </div>

          <div id="tab-users" class="tab-content">
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
                <h2 style="margin:0;">üë• User Details</h2>
                <div class="export-buttons-container">
                  <button id="btnExportUsers" class="btn-export-users" disabled>
                    <span>üì• Export Users</span>
                  </button>
                  <input type="text" id="userSearch" placeholder="üîç Search users..." style="width:280px;padding:12px;">
                  <select id="userFilter" style="width:160px;padding:12px;">
                    <option value="all">All Users</option>
                    <option value="agent">Agents Only</option>
                    <option value="supervisor">Supervisors Only</option>
                    <option value="admin">Admins Only</option>
                    <option value="other">Others Only</option>
                    <option value="named">Named Licence</option>
                    <option value="hi">Hourly Interacting Licence</option>
                    <option value="nologin">NOLOGIN</option>
                    <option value="hasHours">Has Interacting Hours</option>
                    <option value="noHours">No Interacting Hours</option>
                    <option value="overThreshold">Over Threshold</option>
                  </select>
                  <div style="font-size:13px;color:var(--text-light);">
                    <span id="visibleCount">0</span>/<span id="totalCount">0</span> users
                  </div>
                </div>
              </div>

              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>User Name</th>
                      <th>Email</th>
                      <th>Team</th>
                      <th>Role Type</th>
                      <th>Last Login</th>
                      <th>Interacting Time</th>
                      <th>Licence</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="usersTableBody">
                    <tr><td colspan="8" style="text-align:center;padding:48px;color:var(--text-light);">
                      No data loaded. Connect and fetch data first.
                    </td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- New Overage Table Card -->
            <div class="card" style="margin-top:24px;">
              <h2>üìà Overage Analysis</h2>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                <div class="overage-summary" style="flex:1;">
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                      <span style="font-weight:600;">Threshold:</span> 
                      <span id="currentThresholdDisplay">40</span> hours
                    </div>
                    <div>
                      <span style="font-weight:600;">Users over threshold:</span> 
                      <span id="overageCount" style="color:var(--danger);font-weight:700;">0</span>
                    </div>
                    <div>
                      <span style="font-weight:600;">Total overage hours:</span> 
                      <span id="totalOverageHours" style="color:var(--danger);font-weight:700;">0</span>
                    </div>
                  </div>
                  <div style="margin-top:12px;font-size:13px;color:var(--text-light);">
                    Shows users whose interacting hours exceed the threshold (<span id="thresholdValueDisplay">40</span> hours) for the selected date range
                  </div>
                </div>
                <button id="btnExportOverage" class="btn-export-overage" disabled style="margin-left:12px;">
                  <span>üì§ Export Overage</span>
                </button>
              </div>
              
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>User Name</th>
                      <th>Email</th>
                      <th>Team</th>
                      <th>Role Type</th>
                      <th>Interacting Hours</th>
                      <th>Over Threshold By</th>
                      <th>Percentage Over</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="overageTableBody">
                    <tr><td colspan="8" class="no-overage-message">
                      No data available. Fetch user data and run analysis first.
                    </td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="tab-analysis" class="tab-content">
            <div class="card">
              <h2>üìä Licence Distribution</h2>
              <div class="chart-container">
                <canvas id="licenseChart"></canvas>
              </div>
            </div>

            <div class="stats-grid" style="margin-top:24px;">
              <div class="card">
                <h3 style="margin:0 0 18px;">üí∞ Cost Analysis</h3>
                <div style="text-align:center;padding:24px;">
                  <div style="font-size:36px;font-weight:700;color:var(--primary-color);" id="totalCost">¬£0</div>
                  <div style="font-size:15px;color:var(--text-light);">Monthly Cost</div>
                  <div style="margin-top:18px;font-size:13px;color:var(--success);" id="savings">0% savings</div>
                  <div style="margin-top:6px;font-size:12px;color:var(--text-light);" id="costDetails"></div>
                </div>
              </div>

              <div class="card">
                <h3 style="margin:0 0 18px;">üìã Recommendation</h3>
                <div style="text-align:center;padding:24px;">
                  <div style="font-size:28px;font-weight:700;color:var(--primary-color);margin:12px 0;" id="licenseModel">Hybrid</div>
                  <div style="font-size:15px;color:var(--text-light);">Optimal Model</div>
                  <div style="margin-top:18px;font-size:13px;color:var(--text-light);">
                    Based on hour distribution and business rules
                  </div>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:24px;">
              <h2>üéØ Role-based Analysis</h2>
              <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
                <div class="stat-card">
                  <div class="stat-label">Agent Named</div>
                  <div class="stat-value" id="statAgentNamed">0</div>
                  <div style="font-size:12px;color:var(--text-light);">Agents with Named</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Agent Hourly Interacting</div>
                  <div class="stat-value" id="statAgentHI">0</div>
                  <div style="font-size:12px;color:var(--text-light);">Agents with Hourly Interacting</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Supervisor Named</div>
                  <div class="stat-value" id="statSupervisorNamed">0</div>
                  <div style="font-size:12px;color:var(--text-light);">Supervisors with Named</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Admin Named</div>
                  <div class="stat-value" id="statAdminNamed">0</div>
                  <div style="font-size:12px;color:var(--text-light);">Admins with Named</div>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:24px;">
              <h2>üíµ Cost Parameters</h2>
              <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
                <div class="stat-card">
                  <div class="stat-label">Named Licence Cost</div>
                  <div class="stat-value" id="statNamedCost">¬£70</div>
                  <div style="font-size:12px;color:var(--text-light);">Per user per month</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Hourly Interacting Rate</div>
                  <div class="stat-value" id="statHourlyRate">¬£0.45</div>
                  <div style="font-size:12px;color:var(--text-light);">Per hour</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Total Interacting Hours</div>
                  <div class="stat-value" id="statTotalHours">0</div>
                  <div style="font-size:12px;color:var(--text-light);">In selected period</div>
                </div>
              </div>
            </div>

            <!-- NEW: Hourly Interacting Details Card -->
            <div class="card" style="margin-top:24px;">
              <h2>‚è±Ô∏è Hourly Interacting Details</h2>
              <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
                <div class="stat-card">
                  <div class="stat-label">Hourly Users</div>
                  <div class="stat-value" id="statHiUsersDetailed">0</div>
                  <div style="font-size:12px;color:var(--text-light);">Agents with &gt;0 but &lt; threshold hours</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Total Hourly Hours</div>
                  <div class="stat-value" id="statTotalHiHours">0</div>
                  <div style="font-size:12px;color:var(--text-light);">Billable hours</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Avg Hours per User</div>
                  <div class="stat-value" id="statAvgHiHours">0</div>
                  <div style="font-size:12px;color:var(--text-light);">Average per Hourly user</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Hourly Cost</div>
                  <div class="stat-value" id="statHourlyCost">¬£0</div>
                  <div style="font-size:12px;color:var(--text-light);">Hourly licence cost</div>
                </div>
              </div>
            </div>
          </div>

          <div id="tab-logs" class="tab-content">
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
                <h2 style="margin:0;">üìù System Logs</h2>
                <div>
                  <button id="btnClearLogs" class="btn" style="padding:10px 18px;">Clear Logs</button>
                  <button id="btnCopyLogs" class="btn" style="padding:10px 18px;">Copy Logs</button>
                </div>
              </div>

              <div class="table-container" style="max-height:500px;">
                <table>
                  <thead>
                    <tr>
                      <th width="120">Time</th>
                      <th width="120">Level</th>
                      <th>Message</th>
                      <th width="180">Details</th>
                    </tr>
                  </thead>
                  <tbody id="logsTableBody">
                    <tr>
                      <td>--:--:--</td>
                      <td>üîµ INFO</td>
                      <td>System initialised</td>
                      <td>Ready for connection</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-size:20px;font-weight:600;margin-bottom:12px;">Connecting...</div>
    <div id="loadingSubtext" style="font-size:15px;color:var(--text-light);text-align:center;max-width:500px;"></div>
    <div class="progress-container" style="margin-top:24px;">
      <div class="progress-bar">
        <div class="progress-fill" id="loadingProgressFill"></div>
      </div>
    </div>
  </div>

  <!-- FIXED: Changed Chart.js CDN to jsDelivr to avoid tracking prevention warnings -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
    // ==================== TROUBLESHOOTING GUIDE ====================
    // If you're seeing CORS errors:
    // 1. Log into Genesys Cloud Admin
    // 2. Go to Admin > Integrations > OAuth
    // 3. Find your OAuth client (choose from dropdown)
    // 4. Add this URL to Authorized Redirect URIs:
    //    https://gmcglynn88.github.io/Hourly_Billing/
    // 5. Make sure Grant Type is "Token (Implicit Grant)"
    // 6. Save the OAuth client
    // 7. Clear browser cache and localStorage:
    //    localStorage.clear();
    //    location.reload();

    // ==================== CONFIGURATION ====================
    // CLIENT IDS - Now configurable via dropdown
    const CLIENT_IDS = {
      'org1': 'd968eca4-cdb7-4b90-91b1-4628b5bb679e',
      'org2': 'a236ffec-2893-4ccd-81bb-ef2f4a2fe316'
    };
    
    // Default client ID
    let CLIENT_ID = CLIENT_IDS.org1;
    
    // DON'T CHANGE THESE - they work with GitHub Pages
    const REDIRECT_URI = 'https://gmcglynn88.github.io/Hourly_Billing/';
    const ENVIRONMENTS = {
      'us-east-1': { name: 'US East (N. Virginia)', api: 'https://api.mypurecloud.com', login: 'https://login.mypurecloud.com' },
      'us-east-2': { name: 'US East (Ohio)', api: 'https://api.us-east-2.pure.cloud', login: 'https://login.us-east-2.pure.cloud' },
      'us-west-2': { name: 'US West (Oregon)', api: 'https://api.us-west-2.pure.cloud', login: 'https://login.us-west-2.pure.cloud' },
      'ca-central-1': { name: 'Canada Central', api: 'https://api.ca-central-1.pure.cloud', login: 'https://login.ca-central-1.pure.cloud' },
      'sa-east-1': { name: 'South America (S√£o Paulo)', api: 'https://api.sa-east-1.pure.cloud', login: 'https://login.sa-east-1.pure.cloud' },
      'eu-central-1': { name: 'EU Central (Frankfurt)', api: 'https://api.eu-central-1.pure.cloud', login: 'https://login.eu-central-1.pure.cloud' },
      'eu-west-1': { name: 'EU West (Dublin)', api: 'https://api.eu-west-1.pure.cloud', login: 'https://login.eu-west-1.pure.cloud' },
      'eu-west-2': { name: 'EU West (London)', api: 'https://api.euw2.pure.cloud', login: 'https://login.euw2.pure.cloud' },
      'ap-south-1': { name: 'Asia Pacific (Mumbai)', api: 'https://api.ap-south-1.pure.cloud', login: 'https://login.ap-south-1.pure.cloud' },
      'ap-northeast-2': { name: 'Asia Pacific (Seoul)', api: 'https://api.ap-northeast-2.pure.cloud', login: 'https://login.ap-northeast-2.pure.cloud' },
      'ap-southeast-2': { name: 'Asia Pacific (Sydney)', api: 'https://api.ap-southeast-2.pure.cloud', login: 'https://login.ap-southeast-2.pure.cloud' },
      'ap-northeast-1': { name: 'Asia Pacific (Tokyo)', api: 'https://api.ap-northeast-1.pure.cloud', login: 'https://login.ap-northeast-1.pure.cloud' }
    };

    const STORAGE_KEYS = {
      ENVIRONMENT: 'gc_environment',
      ENV_REGION: 'gc_env_region',
      TOKEN: 'gc_token',
      TOKEN_EXPIRY: 'gc_token_expiry',
      REFRESH_TOKEN: 'gc_refresh_token',
      CURRENCY: 'gc_currency',
      HOURLY_CURRENCY: 'gc_hourly_currency',
      DATE_FROM: 'gc_date_from',
      DATE_TO: 'gc_date_to',
      CLIENT_ID: 'gc_client_id' // NEW: Store selected client ID
    };

    let CURRENT_CONFIG = {
      environment: '',
      environmentRegion: '',
      token: null,
      tokenExpiry: null,
      refreshToken: null
    };

    let appState = {
      isConnected: false,
      userData: [],
      analysisResults: null,
      isAnalyzing: false,
      currentTab: 'dashboard',
      logs: [],
      chartInstances: {},
      currencySymbol: '¬£',
      hourlyCurrencySymbol: '¬£'
    };

    // ==================== DOM ELEMENTS ====================
    const el = {
      authContainer: document.getElementById('authContainer'),
      btnDisconnect: document.getElementById('btnDisconnect'),
      envDisplay: document.getElementById('envDisplay'),
      statusIndicator: document.getElementById('statusIndicator'),
      statusText: document.getElementById('statusText'),
      mainContent: document.getElementById('mainContent'),
      btnFetchData: document.getElementById('btnFetchData'),
      btnAnalyze: document.getElementById('btnAnalyze'),
      btnExport: document.getElementById('btnExport'),
      btnReset: document.getElementById('btnReset'),
      btnRunAnalysis: document.getElementById('btnRunAnalysis'),
      btnExportUsers: document.getElementById('btnExportUsers'),
      btnExportOverage: document.getElementById('btnExportOverage'),
      btnSwitchClient: document.getElementById('btnSwitchClient'),
      clientIdSelect: document.getElementById('clientIdSelect'),
      dateFrom: document.getElementById('dateFrom'),
      dateTo: document.getElementById('dateTo'),
      thresholdHours: document.getElementById('thresholdHours'),
      namedLicenseCost: document.getElementById('namedLicenseCost'),
      hourlyLicenseRate: document.getElementById('hourlyLicenseRate'),
      includeNologin: document.getElementById('includeNologin'),
      statTotalUsers: document.getElementById('statTotalUsers'),
      statActiveUsers: document.getElementById('statActiveUsers'),
      statNamedUsers: document.getElementById('statNamedUsers'),
      statHiUsers: document.getElementById('statHiUsers'),
      statHiHours: document.getElementById('statHiHours'),
      statAgents: document.getElementById('statAgents'),
      statSupervisors: document.getElementById('statSupervisors'),
      statAdmins: document.getElementById('statAdmins'),
      statOthers: document.getElementById('statOthers'),
      statAgentNamed: document.getElementById('statAgentNamed'),
      statAgentHI: document.getElementById('statAgentHI'),
      statSupervisorNamed: document.getElementById('statSupervisorNamed'),
      statAdminNamed: document.getElementById('statAdminNamed'),
      statNamedCost: document.getElementById('statNamedCost'),
      statHourlyRate: document.getElementById('statHourlyRate'),
      statTotalHours: document.getElementById('statTotalHours'),
      totalCost: document.getElementById('totalCost'),
      savings: document.getElementById('savings'),
      costDetails: document.getElementById('costDetails'),
      licenseModel: document.getElementById('licenseModel'),
      hourStats: document.getElementById('hourStats'),
      usersTableBody: document.getElementById('usersTableBody'),
      userSearch: document.getElementById('userSearch'),
      userFilter: document.getElementById('userFilter'),
      visibleCount: document.getElementById('visibleCount'),
      totalCount: document.getElementById('totalCount'),
      logsTableBody: document.getElementById('logsTableBody'),
      btnClearLogs: document.getElementById('btnClearLogs'),
      btnCopyLogs: document.getElementById('btnCopyLogs'),
      progressLabel: document.getElementById('progressLabel'),
      progressPercent: document.getElementById('progressPercent'),
      progressFill: document.getElementById('progressFill'),
      hourBuckets: document.getElementById('hourBuckets'),
      hourBarChart: document.getElementById('hourBarChart'),
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingText: document.getElementById('loadingText'),
      loadingSubtext: document.getElementById('loadingSubtext'),
      loadingProgressFill: document.getElementById('loadingProgressFill'),
      statusContainer: document.getElementById('statusContainer'),
      totalUsersCount: document.getElementById('totalUsersCount'),
      totalAgentsCount: document.getElementById('totalAgentsCount'),
      currencySymbol: document.getElementById('currencySymbol'),
      hourlyCurrencySymbol: document.getElementById('hourlyCurrencySymbol'),
      agentCounts: document.getElementById('agentCounts'),
      overageTableBody: document.getElementById('overageTableBody'),
      overageCount: document.getElementById('overageCount'),
      totalOverageHours: document.getElementById('totalOverageHours'),
      currentThresholdDisplay: document.getElementById('currentThresholdDisplay'),
      thresholdValueDisplay: document.getElementById('thresholdValueDisplay'),
      dateRangeInfo: document.getElementById('dateRangeInfo'),
      statHiUsersDetailed: document.getElementById('statHiUsersDetailed'),
      statTotalHiHours: document.getElementById('statTotalHiHours'),
      statAvgHiHours: document.getElementById('statAvgHiHours'),
      statHourlyCost: document.getElementById('statHourlyCost')
    };

    // ==================== UTILITY FUNCTIONS ====================
    function formatMillisecondsToHHMMSS(ms) {
      if (!ms || ms === 0) return "00:00:00";
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function formatMillisecondsToDecimalHours(ms) {
      if (!ms || ms === 0) return 0;
      return parseFloat((ms / (1000 * 60 * 60)).toFixed(2));
    }

    function formatDateForDisplay(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
    }

    function calculateDateRangeDays() {
      const fromDate = el.dateFrom.value;
      const toDate = el.dateTo.value;
      
      if (!fromDate || !toDate) return 0;
      
      const start = new Date(fromDate);
      const end = new Date(toDate);
      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
      
      return diffDays;
    }

    function getMostRecentMonth() {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      let prevMonth = currentMonth - 1;
      let prevYear = currentYear;
      
      if (prevMonth < 0) {
        prevMonth = 11;
        prevYear = currentYear - 1;
      }
      
      const firstDay = new Date(prevYear, prevMonth, 1);
      const lastDay = new Date(prevYear, prevMonth + 1, 0);
      
      return {
        from: firstDay.toISOString().split('T')[0],
        to: lastDay.toISOString().split('T')[0],
        fromDate: firstDay,
        toDate: lastDay
      };
    }

    function updateDateRangeInfo() {
      const fromDate = el.dateFrom.value;
      const toDate = el.dateTo.value;
      
      if (fromDate && toDate) {
        const days = calculateDateRangeDays();
        const fromDisplay = formatDateForDisplay(fromDate);
        const toDisplay = formatDateForDisplay(toDate);
        
        if (days <= 0) {
          el.dateRangeInfo.textContent = 'Invalid date range';
          el.dateRangeInfo.style.color = 'var(--danger)';
          el.btnFetchData.disabled = true;
        } else {
          el.dateRangeInfo.innerHTML = `<strong>Selected:</strong> ${fromDisplay} to ${toDisplay} (${days} days)`;
          el.dateRangeInfo.style.color = 'var(--text-light)';
          el.btnFetchData.disabled = false;
        }
      } else {
        el.dateRangeInfo.textContent = 'Most Recent Month Selected';
        el.dateRangeInfo.style.color = 'var(--text-light)';
        el.btnFetchData.disabled = false;
      }
    }

    function validateDateRange() {
      const fromDate = el.dateFrom.value;
      const toDate = el.dateTo.value;
      
      if (fromDate && toDate) {
        const start = new Date(fromDate);
        const end = new Date(toDate);
        
        if (start > end) {
          return false;
        }
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (end > today) {
          return false;
        }
      }
      
      return true;
    }

    // ==================== AUTHENTICATION ====================
    function loadStoredCredentials() {
      try {
        const token = localStorage.getItem(STORAGE_KEYS.TOKEN);
        const tokenExpiry = localStorage.getItem(STORAGE_KEYS.TOKEN_EXPIRY);
        const environment = localStorage.getItem(STORAGE_KEYS.ENVIRONMENT);
        const envRegion = localStorage.getItem(STORAGE_KEYS.ENV_REGION);
        const refreshToken = localStorage.getItem(STORAGE_KEYS.REFRESH_TOKEN);
        const currency = localStorage.getItem(STORAGE_KEYS.CURRENCY);
        const hourlyCurrency = localStorage.getItem(STORAGE_KEYS.HOURLY_CURRENCY);
        const dateFrom = localStorage.getItem(STORAGE_KEYS.DATE_FROM);
        const dateTo = localStorage.getItem(STORAGE_KEYS.DATE_TO);
        const storedClientId = localStorage.getItem(STORAGE_KEYS.CLIENT_ID);

        // Set client ID from storage or default
        if (storedClientId) {
          CLIENT_ID = storedClientId;
          el.clientIdSelect.value = storedClientId === CLIENT_IDS.org1 ? CLIENT_IDS.org1 : CLIENT_IDS.org2;
        }

        if (token && tokenExpiry && environment && envRegion) {
          CURRENT_CONFIG = {
            token,
            tokenExpiry: parseInt(tokenExpiry, 10),
            environment,
            environmentRegion: envRegion,
            refreshToken
          };

          if (Date.now() < CURRENT_CONFIG.tokenExpiry - (5 * 60 * 1000)) {
            return true;
          }

          if (refreshToken) {
            return false;
          }
        }
        
        if (currency) {
          appState.currencySymbol = currency;
          el.currencySymbol.value = currency;
        }
        
        if (hourlyCurrency) {
          appState.hourlyCurrencySymbol = hourlyCurrency;
          el.hourlyCurrencySymbol.value = hourlyCurrency;
        }
        
        if (dateFrom) {
          el.dateFrom.value = dateFrom;
        }
        
        if (dateTo) {
          el.dateTo.value = dateTo;
        }
        
      } catch (e) {
        console.warn('Failed to load stored credentials:', e);
      }
      return false;
    }

    function saveCredentials(token, expiresIn, environment, envRegion, refreshToken = null) {
      try {
        const tokenExpiry = Date.now() + (parseInt(expiresIn, 10) * 1000);
        CURRENT_CONFIG = { token, tokenExpiry, environment, environmentRegion: envRegion, refreshToken };
        localStorage.setItem(STORAGE_KEYS.TOKEN, token);
        localStorage.setItem(STORAGE_KEYS.TOKEN_EXPIRY, tokenExpiry.toString());
        localStorage.setItem(STORAGE_KEYS.ENVIRONMENT, environment);
        localStorage.setItem(STORAGE_KEYS.ENV_REGION, envRegion);
        if (refreshToken) localStorage.setItem(STORAGE_KEYS.REFRESH_TOKEN, refreshToken);
        return true;
      } catch (e) {
        console.error('Failed to save credentials:', e);
        return false;
      }
    }

    function clearCredentials() {
      try {
        localStorage.removeItem(STORAGE_KEYS.TOKEN);
        localStorage.removeItem(STORAGE_KEYS.TOKEN_EXPIRY);
        localStorage.removeItem(STORAGE_KEYS.ENVIRONMENT);
        localStorage.removeItem(STORAGE_KEYS.ENV_REGION);
        localStorage.removeItem(STORAGE_KEYS.REFRESH_TOKEN);
        localStorage.removeItem(STORAGE_KEYS.DATE_FROM);
        localStorage.removeItem(STORAGE_KEYS.DATE_TO);
        CURRENT_CONFIG = { environment: '', environmentRegion: '', token: null, tokenExpiry: null, refreshToken: null };
      } catch (e) {
        console.error('Failed to clear credentials:', e);
      }
    }

    async function attemptTokenRefresh() {
      if (!CURRENT_CONFIG.refreshToken || !CURRENT_CONFIG.environment || !CURRENT_CONFIG.environmentRegion) return false;
      try {
        const loginUrl = ENVIRONMENTS[CURRENT_CONFIG.environmentRegion]?.login;
        if (!loginUrl) return false;

        const response = await fetch(`${loginUrl}/oauth/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': 'Basic ' + btoa(`${CLIENT_ID}:`)
          },
          body: new URLSearchParams({
            grant_type: 'refresh_token',
            refresh_token: CURRENT_CONFIG.refreshToken
          })
        });

        if (response.ok) {
          const data = await response.json();
          saveCredentials(data.access_token, data.expires_in, CURRENT_CONFIG.environment, 
                         CURRENT_CONFIG.environmentRegion, data.refresh_token || CURRENT_CONFIG.refreshToken);
          logMessage('SUCCESS', 'Token refreshed successfully');
          return true;
        }
      } catch (error) {
        console.warn('Token refresh failed:', error);
      }
      return false;
    }

    function parseTokenFromHash() {
      const hash = window.location.hash.replace(/^#/, '');
      if (!hash) return {};
      
      const params = new URLSearchParams(hash);
      return {
        token: params.get('access_token'),
        refreshToken: params.get('refresh_token'),
        error: params.get('error'),
        errorDescription: params.get('error_description'),
        expiresIn: params.get('expires_in'),
        state: params.get('state')
      };
    }

    function parseEnvironmentFromState(state) {
      if (!state) return 'eu-west-2'; // FIXED: Changed from 'us-east-1' to 'eu-west-2' (London)
      try {
        const stateObj = JSON.parse(atob(state));
        return stateObj.env || 'eu-west-2'; // FIXED: Changed default from 'us-east-1' to 'eu-west-2'
      } catch (e) {
        return 'eu-west-2'; // FIXED: Changed from 'us-east-1' to 'eu-west-2'
      }
    }

    function authUrl(envRegion) {
      const env = ENVIRONMENTS[envRegion];
      if (!env) return null;
      
      const state = btoa(JSON.stringify({ 
        env: envRegion,
        ts: Date.now()
      }));
      
      return `${env.login}/oauth/authorize?client_id=${encodeURIComponent(CLIENT_ID)}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&state=${encodeURIComponent(state)}`;
    }

    async function initAuth() {
      el.authContainer.style.display = 'block';
      
      const { token, refreshToken, error, errorDescription, expiresIn, state } = parseTokenFromHash();
      
      if (window.location.hash) {
        history.replaceState(null, '', window.location.pathname + window.location.search);
      }

      if (token) {
        const envRegion = parseEnvironmentFromState(state);
        const env = ENVIRONMENTS[envRegion];
        if (env) {
          if (saveCredentials(token, expiresIn || '3600', env.api, envRegion, refreshToken)) {
            logMessage('SUCCESS', 'Authentication successful', `Connected to ${env.name} with Client ID: ${CLIENT_ID.substring(0,8)}...`);
            showStatusMessage('‚úÖ Connected to Genesys Cloud', 'success');
            showMainApp(env.name);
            return;
          }
        }
      }

      if (error) {
        logMessage('ERROR', 'Authentication failed', `${error}: ${errorDescription}`);
        showStatusMessage(`‚ùå Authentication failed: ${error}`, 'error');
        
        // Show specific CORS error guidance
        if (errorDescription && errorDescription.includes('CORS') || error === 'access_denied') {
          showStatusMessage('üîß Please check OAuth client configuration in Genesys Cloud', 'warn');
          logMessage('INFO', 'CORS Issue Detected', 'Make sure your GitHub Pages URL is added to the OAuth client\'s Authorized Redirect URIs');
        }
        
        setTimeout(() => authenticate(), 2000);
        return;
      }

      const hasValidToken = loadStoredCredentials();
      if (hasValidToken) {
        const envName = ENVIRONMENTS[CURRENT_CONFIG.environmentRegion]?.name || 'Genesys Cloud';
        logMessage('INFO', 'Auto-authentication successful', 'Using stored credentials');
        setTimeout(() => showMainApp(envName), 500);
        return;
      }

      const refreshSuccess = await attemptTokenRefresh();
      if (refreshSuccess) {
        const envName = ENVIRONMENTS[CURRENT_CONFIG.environmentRegion]?.name || 'Genesys Cloud';
        logMessage('SUCCESS', 'Token refreshed', 'Auto-authentication successful');
        setTimeout(() => showMainApp(envName), 500);
        return;
      }

      logMessage('INFO', 'No valid credentials found', 'Redirecting to authentication...');
      setTimeout(() => authenticate(), 1500);
    }

    function authenticate() {
      // Default to EU West 2 (London) - this is correct for UK deployments
      const envRegion = 'eu-west-2'; // London is the correct default
      const env = ENVIRONMENTS[envRegion];
      
      if (!env) {
        logMessage('ERROR', 'Invalid environment selected');
        return;
      }
      
      const authUrlValue = authUrl(envRegion);
      if (authUrlValue) {
        window.location.href = authUrlValue;
      } else {
        logMessage('ERROR', 'Could not generate authentication URL');
      }
    }

    function checkTokenExpiry() {
      if (!CURRENT_CONFIG.token || !CURRENT_CONFIG.tokenExpiry) return false;
      if (Date.now() > CURRENT_CONFIG.tokenExpiry - (5 * 60 * 1000)) {
        logMessage('WARN', 'Token expired or about to expire', 'Need to refresh authentication');
        return false;
      }
      return true;
    }

    function showMainApp(environmentName) {
      el.authContainer.style.display = 'none';
      el.mainContent.style.display = 'block';
      el.envDisplay.value = environmentName || 'Genesys Cloud';
      updateConnectionStatus(true, 'Connected ‚úì');
      initializeApp();
    }

    function disconnect() {
      if (confirm('Disconnect from Genesys Cloud? This will clear all stored credentials.')) {
        clearCredentials();
        appState = { 
          isConnected: false, 
          userData: [], 
          analysisResults: null, 
          isAnalyzing: false, 
          currentTab: 'dashboard', 
          logs: [], 
          chartInstances: {},
          currencySymbol: '¬£',
          hourlyCurrencySymbol: '¬£'
        };
        el.mainContent.style.display = 'none';
        el.authContainer.style.display = 'block';
        updateConnectionStatus(false, 'Not Connected');
        logMessage('INFO', 'Disconnected from Genesys Cloud');
        setTimeout(() => initAuth(), 500);
      }
    }

    function switchClient() {
      const selectedClientId = el.clientIdSelect.value;
      const previousClientId = CLIENT_ID;
      
      if (selectedClientId === previousClientId) {
        showStatusMessage('Already using this client ID', 'info');
        return;
      }
      
      if (confirm('Switch organisation? This will disconnect your current session and clear all data.')) {
        // Update the client ID
        CLIENT_ID = selectedClientId;
        localStorage.setItem(STORAGE_KEYS.CLIENT_ID, CLIENT_ID);
        
        // Clear credentials and data
        clearCredentials();
        appState.userData = [];
        appState.analysisResults = null;
        
        // Hide main content and show auth
        el.mainContent.style.display = 'none';
        el.authContainer.style.display = 'block';
        updateConnectionStatus(false, 'Not Connected');
        
        // Log the switch
        const orgName = CLIENT_ID === CLIENT_IDS.org1 ? 'Org 1 (Default)' : 'Org 2';
        logMessage('INFO', 'Switched organisation', `Now using ${orgName} (${CLIENT_ID.substring(0,8)}...)`);
        showStatusMessage(`üîÑ Switched to ${orgName}`, 'info');
        
        // Re-initialise auth
        setTimeout(() => initAuth(), 500);
      } else {
        // Reset dropdown to previous value
        el.clientIdSelect.value = previousClientId;
      }
    }

    function updateConnectionStatus(connected, message = '') {
      appState.isConnected = connected;
      if (connected) {
        el.statusIndicator.style.background = 'var(--success)';
        el.statusText.textContent = message || 'Connected ‚úì';
        el.statusText.style.color = 'var(--success)';
        el.btnFetchData.disabled = !(el.dateFrom.value && el.dateTo.value);
        if (appState.userData.length > 0) {
          el.btnExportUsers.disabled = false;
        }
      } else {
        el.statusIndicator.style.background = 'var(--danger)';
        el.statusText.textContent = message || 'Not Connected';
        el.statusText.style.color = 'var(--danger)';
        el.btnFetchData.disabled = true;
        el.btnExportUsers.disabled = true;
        el.btnExportOverage.disabled = true;
      }
    }

    // ==================== UI FUNCTIONS ====================
    function setLoading(show, text = '', subtext = '') {
      if (show) {
        el.loadingText.textContent = text;
        el.loadingSubtext.textContent = subtext;
        el.loadingOverlay.classList.add('active');
      } else {
        el.loadingOverlay.classList.remove('active');
      }
    }

    function updateProgress(label, percent) {
      el.progressLabel.textContent = label;
      el.progressPercent.textContent = `${percent}%`;
      el.progressFill.style.width = `${percent}%`;
    }

    function updateLoadingProgress(percent) {
      el.loadingProgressFill.style.width = `${percent}%`;
    }

    function logMessage(level, message, details = '') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { timestamp, level, message, details };
      appState.logs.unshift(logEntry);
      const row = document.createElement('tr');
      const levelIcon = level === 'ERROR' ? 'üî¥' : level === 'WARN' ? 'üü°' : level === 'SUCCESS' ? '‚úÖ' : 'üîµ';
      row.innerHTML = `<td>${timestamp}</td><td>${levelIcon} ${level}</td><td>${message}</td><td>${details}</td>`;
      el.logsTableBody.prepend(row);
      if (el.logsTableBody.children.length > 50) el.logsTableBody.removeChild(el.logsTableBody.lastChild);
      if (level === 'ERROR' || level === 'SUCCESS' || level === 'WARN') showStatusMessage(message, level.toLowerCase());
      console.log(`[${level}] ${message}`, details);
    }

    function showStatusMessage(message, type = 'info') {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'status-message';
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üí°';
      const color = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : type === 'warn' ? 'var(--warning)' : 'var(--info)';
      msgDiv.style.borderLeftColor = color;
      msgDiv.innerHTML = `<span style="font-size:20px;">${icon}</span><div><div style="font-weight:600;">${message}</div><div style="font-size:12px;color:var(--text-light);">${new Date().toLocaleTimeString()}</div></div>`;
      el.statusContainer.appendChild(msgDiv);
      setTimeout(() => {
        if (msgDiv.parentNode) {
          msgDiv.style.opacity = '0';
          msgDiv.style.transform = 'translateX(100%)';
          setTimeout(() => msgDiv.remove(), 300);
        }
      }, 5000);
    }

    // ==================== API FUNCTIONS ====================
    async function apiCall(path, options = {}) {
      if (!checkTokenExpiry()) {
        const refreshSuccess = await attemptTokenRefresh();
        if (!refreshSuccess) throw new Error('Authentication token expired. Please reconnect.');
      }
      if (!CURRENT_CONFIG.token) throw new Error('Not authenticated');
      const url = `${CURRENT_CONFIG.environment}${path}`;
      const response = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `Bearer ${CURRENT_CONFIG.token}`,
          'Content-Type': 'application/json',
          ...options.headers
        }
      });

      if (response.status === 401 || response.status === 403) throw new Error(`Authentication error (${response.status}). Please reconnect.`);
      if (response.status === 429) {
        const retryAfter = response.headers.get('Retry-After') || 5;
        logMessage('WARN', `Rate limit exceeded`, `Retrying after ${retryAfter} seconds`);
        await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
        return apiCall(path, options);
      }
      if (!response.ok) {
        const errorText = await response.text().catch(() => '');
        throw new Error(`API Error: ${response.status} ${response.statusText}${errorText ? ` - ${errorText.slice(0,200)}` : ''}`);
      }
      return response.json();
    }

    function detectUserRole(roles) {
      if (!roles || !Array.isArray(roles)) return 'other';
      const roleNames = roles.map(r => r.name.toLowerCase());
      const adminKeywords = ['admin', 'administrator', 'system administrator', 'org admin'];
      if (roleNames.some(role => adminKeywords.some(keyword => role.includes(keyword)))) return 'admin';
      const supervisorKeywords = ['supervisor', 'team lead', 'manager', 'director', 'lead'];
      if (roleNames.some(role => supervisorKeywords.some(keyword => role.includes(keyword)))) return 'supervisor';
      const agentKeywords = ['agent', 'user', 'employee', 'representative', 'customer service'];
      if (roleNames.some(role => agentKeywords.some(keyword => role.includes(keyword)))) return 'agent';
      return 'other';
    }

    // ==================== NEW FUNCTION: FETCH USER PRESENCE STATUS ====================
    async function fetchUserPresenceStatus(userIds) {
      try {
        const batchSize = 50;
        const presenceResults = {};
        
        for (let i = 0; i < userIds.length; i += batchSize) {
          const batch = userIds.slice(i, i + batchSize);
          const response = await apiCall(`/api/v2/users?pageSize=${batchSize}&pageNumber=1&id=${batch.join(',')}&expand=presence`);
          
          if (response.entities) {
            response.entities.forEach(user => {
              if (user.presence) {
                presenceResults[user.id] = {
                  presence: user.presence.presenceDefinition?.systemPresence || 'Unknown',
                  isCommunicating: ['BUSY', 'BUSY_OTHER', 'ON_QUEUE', 'INTERRUPTIBLE', 'COMMUNICATING'].includes(
                    user.presence.presenceDefinition?.systemPresence || ''
                  )
                };
              }
            });
          }
          
          // Add delay to avoid rate limiting
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        return presenceResults;
      } catch (error) {
        logMessage('WARN', 'Failed to fetch user presence', error.message);
        return {};
      }
    }

    // ==================== MAIN FUNCTIONS ====================
    async function fetchUserData() {
      if (!validateDateRange()) {
        showStatusMessage('‚ùå Please select valid dates', 'error');
        return;
      }

      setLoading(true, 'Fetching User Data', 'Retrieving agent interaction data from Genesys Cloud...');
      updateLoadingProgress(10);

      try {
        const dateFrom = el.dateFrom.value;
        const dateTo = el.dateTo.value;
        if (!dateFrom || !dateTo) throw new Error('Please select a date range');

        updateLoadingProgress(20);
        logMessage('INFO', 'Fetching user list');

        let allUsers = [];
        let page = 1;
        const pageSize = 100;

        while (true) {
          const usersData = await apiCall(`/api/v2/users?pageSize=${pageSize}&pageNumber=${page}&expand=dateLastLogin,authorization,groups`);
          const users = usersData?.entities || [];
          allUsers = allUsers.concat(users);
          if (!usersData?.nextUri || users.length < pageSize) break;
          page++;
          await new Promise(resolve => setTimeout(resolve, 200));
          updateLoadingProgress(20 + (page * 5));
        }

        updateLoadingProgress(40);
        logMessage('INFO', `Loaded ${allUsers.length} users from API`);

        const userMap = {};
        appState.userData = allUsers.map(user => {
          const teamName = user.groups && user.groups.length > 0 ? user.groups[0].name : 'Unassigned';
          const roleNames = user.authorization?.roles ? user.authorization.roles.map(r => r.name).join(', ') : 'No role';
          const userType = detectUserRole(user.authorization?.roles);
          let lastLogin = 'Never';
          if (user.dateLastLogin) {
            const loginDate = new Date(user.dateLastLogin);
            lastLogin = loginDate.toLocaleDateString();
          }

          const userObj = {
            id: user.id,
            name: user.name || 'Unknown',
            email: user.email || 'No email',
            team: teamName,
            role: roleNames,
            userType: userType,
            lastLogin: lastLogin,
            rawLastLogin: user.dateLastLogin,
            interactingMilliseconds: 0,
            interactingHoursFormatted: '00:00:00',
            interactingHoursDecimal: 0,
            isSupervisor: userType === 'supervisor' || userType === 'admin',
            status: 'Unknown'
          };

          userMap[user.id] = userObj;
          return userObj;
        });

        updateLoadingProgress(50);
        logMessage('INFO', 'Fetching interaction data');

        const interval = `${dateFrom}T00:00:00.000Z/${dateTo}T23:59:59.999Z`;
        const userHoursMap = {};

        try {
          // Try Conversations Analytics API first
          logMessage('INFO', 'Trying Conversations Analytics API for interaction data');
          
          const agentUserIds = appState.userData
            .filter(u => u.userType === 'agent')
            .map(u => u.id)
            .slice(0, 50);

          if (agentUserIds.length > 0) {
            const queryBody = {
              interval: interval,
              order: "asc",
              orderBy: "userId",
              paging: {
                pageSize: 1000,
                pageNumber: 1
              },
              segmentFilters: [
                {
                  type: "or",
                  predicates: [
                    {
                      dimension: "mediaType",
                      value: "voice"
                    },
                    {
                      dimension: "mediaType",
                      value: "chat"
                    },
                    {
                      dimension: "mediaType",
                      value: "email"
                    },
                    {
                      dimension: "mediaType",
                      value: "message"
                    }
                  ]
                },
                {
                  type: "or",
                  predicates: [
                    {
                      dimension: "queueId",
                      operator: "exists",
                      value: null
                    }
                  ]
                }
              ],
              groupBy: ["userId"],
              metrics: ["tTalk", "tWrapUp"]
            };

            updateLoadingProgress(60);
            logMessage('INFO', 'Querying Conversations Analytics API');

            try {
              const analyticsResponse = await apiCall('/api/v2/analytics/conversations/aggregates/query', {
                method: 'POST',
                body: JSON.stringify(queryBody)
              });

              console.log('Conversations API Response:', analyticsResponse);

              if (analyticsResponse.results && analyticsResponse.results.length > 0) {
                analyticsResponse.results.forEach(record => {
                  if (record.group && record.group.userId) {
                    const userId = record.group.userId;
                    let totalTalkTime = 0;
                    let totalWrapUpTime = 0;

                    const tTalkData = record.data.find(d => d.metric === "tTalk");
                    if (tTalkData && tTalkData.stats) {
                      totalTalkTime = tTalkData.stats.sum || 0;
                    }

                    const tWrapUpData = record.data.find(d => d.metric === "tWrapUp");
                    if (tWrapUpData && tWrapUpData.stats) {
                      totalWrapUpTime = tWrapUpData.stats.sum || 0;
                    }

                    const totalInteractingTime = totalTalkTime + totalWrapUpTime;
                    
                    if (totalInteractingTime > 0) {
                      userHoursMap[userId] = totalInteractingTime;
                    }
                  }
                });

                logMessage('SUCCESS', 'Conversations API query completed', `Found ${Object.keys(userHoursMap).length} users with interaction time`);
                
                // Debug sample data
                const usersWithHours = Object.keys(userHoursMap);
                const sampleCount = Math.min(10, usersWithHours.length);
                for (let i = 0; i < sampleCount; i++) {
                  const userId = usersWithHours[i];
                  const user = userMap[userId];
                  const userName = user ? user.name : userId;
                  const hoursFormatted = formatMillisecondsToHHMMSS(userHoursMap[userId]);
                  const hoursDecimal = formatMillisecondsToDecimalHours(userHoursMap[userId]);
                  logMessage('DEBUG', `User: ${userName}`, `Interaction time: ${hoursFormatted} (${hoursDecimal.toFixed(2)} hours)`);
                }
              } else {
                logMessage('WARN', 'No conversation data found in selected period', 'Users will have 0 interacting time');
              }
            } catch (convError) {
              // ===== UPDATED SECTION: REMOVED RANDOM DATA GENERATION =====
              logMessage('ERROR', 'Conversations API failed', convError.message);
              logMessage('WARN', 'No interaction data available', 'All users will have 0 interacting time. Check API permissions and query parameters.');
              // ===== END UPDATED SECTION =====
            }
          } else {
            logMessage('WARN', 'No agent users found', 'Only supervisors and admins in the organization');
          }
        } catch (analyticsError) {
          logMessage('ERROR', 'Analytics API query failed', analyticsError.message);
          console.error('Analytics API error details:', analyticsError);
        }

        // Update user data with interacting time
        appState.userData.forEach(user => {
          const interactTimeMs = userHoursMap[user.id] || 0;
          user.interactingMilliseconds = interactTimeMs;
          user.interactingHoursFormatted = formatMillisecondsToHHMMSS(interactTimeMs);
          user.interactingHoursDecimal = formatMillisecondsToDecimalHours(interactTimeMs);
        });

        // Fetch user presence status to check for communicating users
        updateLoadingProgress(70);
        logMessage('INFO', 'Fetching user presence status');
        
        const userIds = appState.userData.map(u => u.id);
        const presenceData = await fetchUserPresenceStatus(userIds);
        
        // Update user status based on presence
        appState.userData.forEach(user => {
          const presence = presenceData[user.id];
          if (presence) {
            user.presenceStatus = presence.presence;
            user.isCommunicating = presence.isCommunicating;
            
            // Log if user is currently communicating
            if (user.isCommunicating) {
              logMessage('INFO', `User ${user.name} is currently ${user.presenceStatus}`, 'This user may be actively communicating');
            }
          }
        });

        // Calculate statistics
        const usersWithHours = appState.userData.filter(u => u.interactingMilliseconds > 0);
        const totalInteractingMs = usersWithHours.reduce((sum, u) => sum + u.interactingMilliseconds, 0);
        const totalInteractingHours = formatMillisecondsToDecimalHours(totalInteractingMs);
        
        // Count communicating users
        const communicatingUsers = appState.userData.filter(u => u.isCommunicating).length;
        logMessage('INFO', `Communicating users detected`, `${communicatingUsers} users are currently in a communicating state`);
        
        logMessage('INFO', `Interacting time distribution`, 
          `${usersWithHours.length} users have > 0 interacting time, ${appState.userData.length - usersWithHours.length} users have 0 interacting time`);
        logMessage('INFO', `Total interacting time`, 
          `${formatMillisecondsToHHMMSS(totalInteractingMs)} (${totalInteractingHours.toFixed(2)} hours)`);

        if (usersWithHours.length > 0) {
          const avgMs = totalInteractingMs / usersWithHours.length;
          const avgHoursFormatted = formatMillisecondsToHHMMSS(avgMs);
          logMessage('INFO', `Average per user`, `${avgHoursFormatted} per active user`);
        }

        updateLoadingProgress(95);
        updateUserTypeStats();
        updateCurrencyDisplay();

        logMessage('SUCCESS', 'Data loaded successfully', 
          `${appState.userData.length} users loaded, ${usersWithHours.length} with interacting time, ${communicatingUsers} currently communicating, total ${totalInteractingHours.toFixed(2)} hours`);

        el.statTotalUsers.textContent = appState.userData.length;
        el.totalCount.textContent = appState.userData.length;
        el.visibleCount.textContent = appState.userData.length;
        el.btnAnalyze.disabled = false;
        el.btnRunAnalysis.disabled = false;
        el.btnExportUsers.disabled = false;

        renderUserTable();
        updateHourBuckets();
        updateHourBarChart();
        updateOverageTable();

        updateLoadingProgress(100);
        await new Promise(resolve => setTimeout(resolve, 500));
        setLoading(false);
        showStatusMessage(`‚úÖ Loaded ${appState.userData.length} users (${usersWithHours.length} with interacting time, ${communicatingUsers} communicating)`, 'success');

      } catch (error) {
        setLoading(false);
        logMessage('ERROR', 'Failed to fetch data', error.message);
        showStatusMessage('‚ùå Failed to fetch data', 'error');
      }
    }

    function updateUserTypeStats() {
      const agents = appState.userData.filter(u => u.userType === 'agent').length;
      const supervisors = appState.userData.filter(u => u.userType === 'supervisor').length;
      const admins = appState.userData.filter(u => u.userType === 'admin').length;
      const others = appState.userData.filter(u => u.userType === 'other').length;
      el.statAgents.textContent = agents;
      el.statSupervisors.textContent = supervisors;
      el.statAdmins.textContent = admins;
      el.statOthers.textContent = others;
    }

    function updateOverageTable() {
      const tbody = el.overageTableBody;
      tbody.innerHTML = '';
      
      const threshold = parseFloat(el.thresholdHours.value) || 40;
      el.currentThresholdDisplay.textContent = threshold;
      el.thresholdValueDisplay.textContent = threshold;
      
      const usersOverThreshold = appState.userData.filter(user => 
        user.interactingHoursDecimal > threshold
      );
      
      usersOverThreshold.sort((a, b) => b.interactingHoursDecimal - a.interactingHoursDecimal);
      
      el.overageCount.textContent = usersOverThreshold.length;
      
      let totalOverage = 0;
      usersOverThreshold.forEach(user => {
        totalOverage += (user.interactingHoursDecimal - threshold);
      });
      el.totalOverageHours.textContent = Math.round(totalOverage);
      
      if (usersOverThreshold.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="8" class="no-overage-message">
          No users exceed the threshold of ${threshold} hours for the selected date range.
        </td>`;
        tbody.appendChild(row);
        el.btnExportOverage.disabled = true;
      } else {
        el.btnExportOverage.disabled = false;
      }
      
      usersOverThreshold.forEach(user => {
        const overageHours = user.interactingHoursDecimal - threshold;
        const percentageOver = ((overageHours / threshold) * 100).toFixed(1);
        
        const row = document.createElement('tr');
        
        let userTypeBadge = '';
        switch(user.userType) {
          case 'agent':
            userTypeBadge = `<span class="status-badge" style="background:rgba(99,171,143,0.15);color:var(--primary-color);">Agent</span>`;
            break;
          case 'supervisor':
            userTypeBadge = `<span class="status-badge" style="background:rgba(255,193,7,0.15);color:#d39e00;">Supervisor</span>`;
            break;
          case 'admin':
            userTypeBadge = `<span class="status-badge" style="background:rgba(220,53,69,0.15);color:var(--danger);">Admin</span>`;
            break;
          default:
            userTypeBadge = `<span class="status-badge" style="background:rgba(108,117,125,0.15);color:var(--text-light);">Other</span>`;
        }
        
        let statusBadge = '';
        let statusText = '';
        if (percentageOver > 100) {
          statusBadge = `<span class="overage-badge">Significant Overage</span>`;
          statusText = 'More than double the threshold';
        } else if (percentageOver > 50) {
          statusBadge = `<span class="overage-badge">High Overage</span>`;
          statusText = '50-100% over threshold';
        } else if (percentageOver > 25) {
          statusBadge = `<span class="status-badge" style="background:rgba(255,193,7,0.15);color:#d39e00;">Moderate Overage</span>`;
          statusText = '25-50% over threshold';
        } else {
          statusBadge = `<span class="status-badge" style="background:rgba(108,117,125,0.15);color:var(--text-light);">Minor Overage</span>`;
          statusText = 'Under 25% over threshold';
        }
        
        row.innerHTML = `
          <td>
            <div style="font-weight:600;">${user.name || 'Unknown'}</div>
            <div style="font-size:12px;color:var(--text-light);">ID: ${user.id?.substring(0, 8)}...</div>
          </td>
          <td>${user.email || 'No email'}</td>
          <td>${user.team || 'Unassigned'}</td>
          <td>
            ${userTypeBadge}
            <div style="font-size:12px;color:var(--text-light);margin-top:4px;">${user.role?.substring(0, 30) || 'No role'}${user.role && user.role.length > 30 ? '...' : ''}</div>
          </td>
          <td style="text-align:center;font-weight:600;">
            ${Math.round(user.interactingHoursDecimal)} hours
            <div style="font-size:12px;color:var(--text-light);">${user.interactingHoursFormatted}</div>
          </td>
          <td style="text-align:center;font-weight:700;color:var(--danger);">
            +${Math.round(overageHours)} hours
          </td>
          <td style="text-align:center;font-weight:600;color:var(--danger);">
            ${percentageOver}%
          </td>
          <td>
            ${statusBadge}
            <div style="font-size:12px;color:var(--text-light);margin-top:4px;">${statusText}</div>
          </td>
        `;
        tbody.appendChild(row);
      });
      
      // Add summary row
      const summaryRow = document.createElement('tr');
      summaryRow.style.backgroundColor = 'rgba(220, 53, 69, 0.05)';
      summaryRow.innerHTML = `
        <td colspan="4" style="text-align:right;font-weight:600;">
          <span style="color:var(--danger);">TOTAL OVERAGE:</span>
        </td>
        <td style="text-align:center;font-weight:600;">
          ${Math.round(usersOverThreshold.reduce((sum, u) => sum + u.interactingHoursDecimal, 0))} hours
        </td>
        <td style="text-align:center;font-weight:700;color:var(--danger);">
          +${Math.round(totalOverage)} hours
        </td>
        <td style="text-align:center;font-weight:600;color:var(--danger);">
          ${usersOverThreshold.length} users
        </td>
        <td>
          <span style="font-size:12px;color:var(--text-light);">Average: ${Math.round(totalOverage / usersOverThreshold.length)} hours over</span>
        </td>
      `;
      tbody.appendChild(summaryRow);
    }

    async function runAnalysis() {
      if (appState.isAnalyzing) return;
      appState.isAnalyzing = true;
      el.btnRunAnalysis.disabled = true;
      el.btnRunAnalysis.innerHTML = '<span>‚è≥ Analysing...</span>';

      try {
        updateProgress('Starting analysis...', 10);
        const threshold = parseFloat(el.thresholdHours.value);
        const namedLicenseCost = parseFloat(el.namedLicenseCost.value);
        const hourlyLicenseRate = parseFloat(el.hourlyLicenseRate.value);
        const includeNologin = el.includeNologin.value === 'true';
        updateProgress('Filtering users...', 30);
        
        let usersToAnalyze = appState.userData;
        if (!includeNologin) usersToAnalyze = appState.userData.filter(u => u.interactingMilliseconds > 0 || u.rawLastLogin);

        usersToAnalyze.forEach(user => {
          user.recommendedLicense = 'NOLOGIN';
          user.recommendedReason = 'No login activity';
        });

        updateProgress('Applying business rules...', 50);
        
        usersToAnalyze.forEach(user => {
          const hasNeverLoggedIn = !user.rawLastLogin && user.interactingMilliseconds === 0;

          if (hasNeverLoggedIn) {
            user.recommendedLicense = 'NOLOGIN';
            user.recommendedReason = 'Never logged in';
          } else if (user.userType === 'admin' || user.userType === 'supervisor') {
            user.recommendedLicense = 'Named';
            user.recommendedReason = `${user.userType === 'admin' ? 'Admin' : 'Supervisor'} role`;
          } else if (user.userType === 'agent' && user.interactingHoursDecimal > 0 && user.interactingHoursDecimal < threshold) {
            // FIXED: Only agents can get Hourly Interacting license
            user.recommendedLicense = 'Hourly Interacting';
            user.recommendedReason = `Agent under ${threshold} hours (${user.interactingHoursDecimal.toFixed(1)}h)`;
          } else if (user.userType === 'agent' && user.interactingHoursDecimal >= threshold) {
            // FIXED: Only agents get Named based on hours
            user.recommendedLicense = 'Named';
            user.recommendedReason = `Agent over ${threshold} hours (${user.interactingHoursDecimal.toFixed(1)}h)`;
          } else if (user.userType === 'other' && user.interactingHoursDecimal > 0) {
            // FIXED: Other users with hours get Named
            user.recommendedLicense = 'Named';
            user.recommendedReason = `Other role with hours (${user.interactingHoursDecimal.toFixed(1)}h)`;
          } else {
            user.recommendedLicense = 'NOLOGIN';
            user.recommendedReason = 'No interaction hours detected';
          }

          if (user.recommendedLicense === 'Hourly Interacting') {
            user.estimatedCost = user.interactingHoursDecimal * hourlyLicenseRate;
          } else if (user.recommendedLicense === 'Named') {
            user.estimatedCost = namedLicenseCost;
          } else {
            user.estimatedCost = 0;
          }
        });

        updateProgress('Calculating statistics...', 70);
        const totalUsers = usersToAnalyze.length;
        const activeUsers = usersToAnalyze.filter(u => u.interactingMilliseconds > 0).length;
        const namedUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'Named').length;
        
        // FIXED: Only count agents for Hourly Interacting statistic
        const hiUsers = usersToAnalyze.filter(u => 
          u.recommendedLicense === 'Hourly Interacting' && u.userType === 'agent'
        ).length;
        
        const nologinUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'NOLOGIN').length;
        const totalHours = usersToAnalyze.reduce((sum, u) => sum + u.interactingHoursDecimal, 0);

        // FIXED: Only include agents in Hourly Interacting details
        const hiUsersList = usersToAnalyze.filter(u => 
          u.recommendedLicense === 'Hourly Interacting' && u.userType === 'agent'
        );
        const hiHours = hiUsersList.reduce((sum, u) => sum + u.interactingHoursDecimal, 0);
        const avgHiHours = hiUsers > 0 ? hiHours / hiUsers : 0;
        const hourlyCost = hiHours * hourlyLicenseRate;

        const agentNamed = usersToAnalyze.filter(u => u.userType === 'agent' && u.recommendedLicense === 'Named').length;
        const agentHI = hiUsers; // Already filtered for agents only
        const supervisorNamed = usersToAnalyze.filter(u => u.userType === 'supervisor' && u.recommendedLicense === 'Named').length;
        const adminNamed = usersToAnalyze.filter(u => u.userType === 'admin' && u.recommendedLicense === 'Named').length;

        const allNamedCost = totalUsers * namedLicenseCost;
        const hybridCost = (namedUsers * namedLicenseCost) + hourlyCost;
        const savings = allNamedCost > 0 ? ((allNamedCost - hybridCost) / allNamedCost * 100).toFixed(1) : 0;

        let optimalModel = 'Hybrid';
        if (hiUsers / totalUsers > 0.7) optimalModel = 'Mostly Hourly Interacting';
        else if (namedUsers / totalUsers > 0.7) optimalModel = 'Mostly Named';
        else if (hiUsers === 0) optimalModel = 'All Named';
        else if (namedUsers === 0) optimalModel = 'All Hourly Interacting';

        appState.analysisResults = {
          totalUsers,
          activeUsers,
          namedUsers,
          hiUsers,
          hiHours,
          avgHiHours,
          hourlyCost,
          nologinUsers,
          totalHours: totalHours.toFixed(2),
          threshold,
          namedLicenseCost,
          hourlyLicenseRate,
          allNamedCost: allNamedCost.toFixed(2),
          hybridCost: hybridCost.toFixed(2),
          savings,
          optimalModel,
          agentNamed,
          agentHI,
          supervisorNamed,
          adminNamed,
          users: usersToAnalyze
        };

        updateProgress('Updating display...', 90);
        el.statActiveUsers.textContent = activeUsers;
        el.statNamedUsers.textContent = namedUsers;
        el.statHiUsers.textContent = hiUsers;
        el.statHiHours.textContent = `${Math.round(hiHours)} hours`;
        el.statAgentNamed.textContent = agentNamed;
        el.statAgentHI.textContent = agentHI;
        el.statSupervisorNamed.textContent = supervisorNamed;
        el.statAdminNamed.textContent = adminNamed;
        
        // Update Hourly Interacting details
        el.statHiUsersDetailed.textContent = hiUsers;
        el.statTotalHiHours.textContent = Math.round(hiHours);
        el.statAvgHiHours.textContent = avgHiHours.toFixed(1);
        el.statHourlyCost.textContent = `${appState.hourlyCurrencySymbol}${hourlyCost.toFixed(2)}`;
        
        updateCurrencyDisplay();
        
        el.statTotalHours.textContent = Math.round(totalHours);
        el.totalCost.textContent = `${appState.currencySymbol}${parseFloat(hybridCost).toFixed(2)}`;
        el.savings.textContent = `${savings}% savings`;
        el.costDetails.innerHTML = `All Named: ${appState.currencySymbol}${parseFloat(allNamedCost).toFixed(2)}<br>Hybrid: ${appState.currencySymbol}${parseFloat(hybridCost).toFixed(2)}`;
        el.licenseModel.textContent = optimalModel;

        renderUserTable();
        updateHourBuckets();
        updateHourBarChart();
        updateOverageTable();
        updateProgress('Creating visualisation...', 95);
        createLicenseChart();
        updateProgress('Analysis complete!', 100);
        await new Promise(resolve => setTimeout(resolve, 1000));

        logMessage('SUCCESS', 'Analysis complete', `${namedUsers} Named, ${hiUsers} Hourly Interacting agents (${Math.round(hiHours)} hours)`);
        logMessage('INFO', 'Hourly Interacting details', `${hiUsers} agents with >0 hours, ${Math.round(hiHours)} total hours, ${appState.hourlyCurrencySymbol}${hourlyCost.toFixed(2)} cost`);
        logMessage('INFO', 'NOLOGIN users', `${nologinUsers} users with 0 hours (correctly classified)`);
        logMessage('INFO', 'Cost analysis', `All Named: ${appState.currencySymbol}${allNamedCost}, Hybrid: ${appState.currencySymbol}${hybridCost}, Savings: ${savings}%`);
        showStatusMessage(`‚úÖ Analysis complete: ${hiUsers} Hourly Interacting agents (with >0 hours), ${savings}% savings`, 'success');
        el.btnExport.disabled = false;

      } catch (error) {
        logMessage('ERROR', 'Analysis failed', error.message);
        showStatusMessage('‚ùå Analysis failed', 'error');
      } finally {
        appState.isAnalyzing = false;
        el.btnRunAnalysis.disabled = false;
        el.btnRunAnalysis.innerHTML = '<span>‚ñ∂Ô∏è Run Analysis</span>';
        updateProgress('Ready to analyse', 0);
      }
    }

    function updateCurrencyDisplay() {
      el.statNamedCost.textContent = `${appState.currencySymbol}${el.namedLicenseCost.value}`;
      el.statHourlyRate.textContent = `${appState.hourlyCurrencySymbol}${el.hourlyLicenseRate.value}`;
      
      if (appState.analysisResults) {
        el.totalCost.textContent = `${appState.currencySymbol}${parseFloat(appState.analysisResults.hybridCost).toFixed(2)}`;
        el.costDetails.innerHTML = `All Named: ${appState.currencySymbol}${parseFloat(appState.analysisResults.allNamedCost).toFixed(2)}<br>Hybrid: ${appState.currencySymbol}${parseFloat(appState.analysisResults.hybridCost).toFixed(2)}`;
        el.statHourlyCost.textContent = `${appState.hourlyCurrencySymbol}${appState.analysisResults.hourlyCost.toFixed(2)}`;
      }
    }

    function renderUserTable() {
      const tbody = el.usersTableBody;
      tbody.innerHTML = '';
      const searchTerm = el.userSearch.value.toLowerCase();
      const filterValue = el.userFilter.value;
      let usersToDisplay = appState.userData || [];

      if (searchTerm) {
        usersToDisplay = usersToDisplay.filter(user =>
          (user.name && user.name.toLowerCase().includes(searchTerm)) ||
          (user.email && user.email.toLowerCase().includes(searchTerm)) ||
          (user.team && user.team.toLowerCase().includes(searchTerm)) ||
          (user.role && user.role.toLowerCase().includes(searchTerm)) ||
          (user.userType && user.userType.toLowerCase().includes(searchTerm)) ||
          (user.recommendedLicense && user.recommendedLicense.toLowerCase().includes(searchTerm))
        );
      }

      if (filterValue !== 'all') {
        if (filterValue === 'named') usersToDisplay = usersToDisplay.filter(u => u.recommendedLicense === 'Named');
        else if (filterValue === 'hi') usersToDisplay = usersToDisplay.filter(u => u.recommendedLicense === 'Hourly Interacting');
        else if (filterValue === 'nologin') usersToDisplay = usersToDisplay.filter(u => u.recommendedLicense === 'NOLOGIN');
        else if (filterValue === 'hasHours') usersToDisplay = usersToDisplay.filter(u => u.interactingHoursDecimal > 0);
        else if (filterValue === 'noHours') usersToDisplay = usersToDisplay.filter(u => u.interactingHoursDecimal === 0);
        else if (filterValue === 'overThreshold') {
          const threshold = parseFloat(el.thresholdHours.value) || 40;
          usersToDisplay = usersToDisplay.filter(u => u.interactingHoursDecimal > threshold);
        } else usersToDisplay = usersToDisplay.filter(u => u.userType === filterValue);
      }

      el.visibleCount.textContent = usersToDisplay.length;

      if (usersToDisplay.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="8" style="text-align:center;padding:48px;color:var(--text-light);">${appState.userData.length === 0 ? 'No data loaded. Connect and fetch data first.' : 'No users match your search/filter.'}</td>`;
        tbody.appendChild(row);
        return;
      }

      usersToDisplay.forEach(user => {
        const row = document.createElement('tr');
        let licenseBadge = '';
        let badgeClass = '';

        if (user.recommendedLicense) {
          switch(user.recommendedLicense) {
            case 'Named':
              badgeClass = 'status-named';
              licenseBadge = `<span class="status-badge ${badgeClass}">Named</span>`;
              break;
            case 'Hourly Interacting':
              badgeClass = 'status-hi';
              licenseBadge = `<span class="status-badge ${badgeClass}">Hourly Interacting</span>`;
              break;
            case 'NOLOGIN':
              badgeClass = 'status-nologin';
              licenseBadge = `<span class="status-badge ${badgeClass}">NOLOGIN</span>`;
              break;
          }
        } else {
          if (user.interactingMilliseconds === 0) licenseBadge = `<span class="status-badge status-nologin">NOLOGIN</span>`;
          else licenseBadge = `<span class="status-badge" style="background:rgba(108,117,125,0.15);color:var(--text-light);">Pending</span>`;
        }

        let userTypeBadge = '';
        switch(user.userType) {
          case 'agent':
            userTypeBadge = `<span class="status-badge" style="background:rgba(99,171,143,0.15);color:var(--primary-color);">Agent</span>`;
            break;
          case 'supervisor':
            userTypeBadge = `<span class="status-badge" style="background:rgba(255,193,7,0.15);color:#d39e00;">Supervisor</span>`;
            break;
          case 'admin':
            userTypeBadge = `<span class="status-badge" style="background:rgba(220,53,69,0.15);color:var(--danger);">Admin</span>`;
            break;
          default:
            userTypeBadge = `<span class="status-badge" style="background:rgba(108,117,125,0.15);color:var(--text-light);">Other</span>`;
        }

        row.innerHTML = `
          <td>
            <div style="font-weight:600;">${user.name || 'Unknown'}</div>
            <div style="font-size:12px;color:var(--text-light);">ID: ${user.id?.substring(0, 8)}...</div>
          </td>
          <td>${user.email || 'No email'}</td>
          <td>${user.team || 'Unassigned'}</td>
          <td>
            ${userTypeBadge}
            <div style="font-size:12px;color:var(--text-light);margin-top:4px;">${user.role?.substring(0, 30) || 'No role'}${user.role && user.role.length > 30 ? '...' : ''}</div>
          </td>
          <td style="font-size:13px;color:${user.lastLogin === 'Never' ? 'var(--text-light)' : 'var(--success)'}">${user.lastLogin}</td>
          <td style="text-align:center;font-weight:600;font-family:monospace;">
            ${user.interactingHoursFormatted}
            <div style="font-size:12px;color:var(--text-light);">${Math.round(user.interactingHoursDecimal)} hours</div>
          </td>
          <td>${licenseBadge}</td>
          <td>
            <span style="font-size:12px;color:var(--text-light);">
              ${user.recommendedReason || 'Pending analysis'}
            </span>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateHourBuckets() {
      const buckets = {
        '0h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '1-10h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '11-20h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '21-30h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '31-40h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '41-50h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '51-60h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '61-70h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '71-80h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '81-90h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '91-100h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '100+h': { userCount: 0, agentCount: 0, totalHours: 0 }
      };

      let totalUsers = 0;
      let totalAgents = 0;
      let totalHoursSum = 0;

      (appState.userData || []).forEach(user => {
        const hours = user.interactingHoursDecimal || 0;
        const isAgent = user.userType === 'agent';
        
        totalUsers++;
        totalHoursSum += hours;
        if (isAgent) totalAgents++;
        
        if (hours === 0) {
          buckets['0h'].userCount++;
          buckets['0h'].totalHours += hours;
          if (isAgent) buckets['0h'].agentCount++;
        } else if (hours > 0 && hours <= 10) {
          buckets['1-10h'].userCount++;
          buckets['1-10h'].totalHours += hours;
          if (isAgent) buckets['1-10h'].agentCount++;
        } else if (hours > 10 && hours <= 20) {
          buckets['11-20h'].userCount++;
          buckets['11-20h'].totalHours += hours;
          if (isAgent) buckets['11-20h'].agentCount++;
        } else if (hours > 20 && hours <= 30) {
          buckets['21-30h'].userCount++;
          buckets['21-30h'].totalHours += hours;
          if (isAgent) buckets['21-30h'].agentCount++;
        } else if (hours > 30 && hours <= 40) {
          buckets['31-40h'].userCount++;
          buckets['31-40h'].totalHours += hours;
          if (isAgent) buckets['31-40h'].agentCount++;
        } else if (hours > 40 && hours <= 50) {
          buckets['41-50h'].userCount++;
          buckets['41-50h'].totalHours += hours;
          if (isAgent) buckets['41-50h'].agentCount++;
        } else if (hours > 50 && hours <= 60) {
          buckets['51-60h'].userCount++;
          buckets['51-60h'].totalHours += hours;
          if (isAgent) buckets['51-60h'].agentCount++;
        } else if (hours > 60 && hours <= 70) {
          buckets['61-70h'].userCount++;
          buckets['61-70h'].totalHours += hours;
          if (isAgent) buckets['61-70h'].agentCount++;
        } else if (hours > 70 && hours <= 80) {
          buckets['71-80h'].userCount++;
          buckets['71-80h'].totalHours += hours;
          if (isAgent) buckets['71-80h'].agentCount++;
        } else if (hours > 80 && hours <= 90) {
          buckets['81-90h'].userCount++;
          buckets['81-90h'].totalHours += hours;
          if (isAgent) buckets['81-90h'].agentCount++;
        } else if (hours > 90 && hours <= 100) {
          buckets['91-100h'].userCount++;
          buckets['91-100h'].totalHours += hours;
          if (isAgent) buckets['91-100h'].agentCount++;
        } else if (hours > 100) {
          buckets['100+h'].userCount++;
          buckets['100+h'].totalHours += hours;
          if (isAgent) buckets['100+h'].agentCount++;
        }
      });

      el.hourBuckets.innerHTML = '';
      
      Object.entries(buckets).forEach(([label, data]) => {
        const card = document.createElement('div');
        card.className = 'bucket-card';
        card.title = `Bucket: ${label}\nUsers: ${data.userCount}\nAgents: ${data.agentCount}\nTotal Hours: ${Math.round(data.totalHours)}`;
        card.innerHTML = `
          <div class="bucket-count">${Math.round(data.totalHours)}</div>
          <div class="bucket-agent-count">üë• ${data.userCount} users</div>
          <div class="bucket-label">${label}</div>
        `;
        el.hourBuckets.appendChild(card);
      });

      el.agentCounts.innerHTML = '';
      
      Object.entries(buckets).forEach(([label, data]) => {
        const card = document.createElement('div');
        card.className = 'agent-count-card';
        card.title = `Bucket: ${label}\nAgent Count: ${data.agentCount}\nTotal Hours: ${Math.round(data.totalHours)}`;
        card.innerHTML = `
          <div class="agent-count-value">${data.agentCount}</div>
          <div class="agent-count-label">${label}</div>
        `;
        el.agentCounts.appendChild(card);
      });

      el.totalUsersCount.textContent = totalUsers;
      el.totalAgentsCount.textContent = totalAgents;

      const usersWithHours = appState.userData.filter(u => u.interactingHoursDecimal > 0);
      const avgHours = usersWithHours.length > 0 ? totalHoursSum / usersWithHours.length : 0;
      
      el.hourStats.innerHTML = `
        <div style="display:flex;justify-content:center;gap:24px;">
          <div>Users with hours: <strong>${usersWithHours.length}</strong></div>
          <div>Total hours: <strong>${Math.round(totalHoursSum)}</strong></div>
          <div>Avg per user: <strong>${Math.round(avgHours)}</strong></div>
        </div>
      `;
    }

    function updateHourBarChart() {
      const buckets = {
        '0h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '1-10h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '11-20h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '21-30h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '31-40h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '41-50h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '51-60h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '61-70h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '71-80h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '81-90h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '91-100h': { userCount: 0, agentCount: 0, totalHours: 0 },
        '100+h': { userCount: 0, agentCount: 0, totalHours: 0 }
      };

      (appState.userData || []).forEach(user => {
        const hours = user.interactingHoursDecimal || 0;
        const isAgent = user.userType === 'agent';
        
        if (hours === 0) {
          buckets['0h'].userCount++;
          buckets['0h'].totalHours += hours;
          if (isAgent) buckets['0h'].agentCount++;
        } else if (hours > 0 && hours <= 10) {
          buckets['1-10h'].userCount++;
          buckets['1-10h'].totalHours += hours;
          if (isAgent) buckets['1-10h'].agentCount++;
        } else if (hours > 10 && hours <= 20) {
          buckets['11-20h'].userCount++;
          buckets['11-20h'].totalHours += hours;
          if (isAgent) buckets['11-20h'].agentCount++;
        } else if (hours > 20 && hours <= 30) {
          buckets['21-30h'].userCount++;
          buckets['21-30h'].totalHours += hours;
          if (isAgent) buckets['21-30h'].agentCount++;
        } else if (hours > 30 && hours <= 40) {
          buckets['31-40h'].userCount++;
          buckets['31-40h'].totalHours += hours;
          if (isAgent) buckets['31-40h'].agentCount++;
        } else if (hours > 40 && hours <= 50) {
          buckets['41-50h'].userCount++;
          buckets['41-50h'].totalHours += hours;
          if (isAgent) buckets['41-50h'].agentCount++;
        } else if (hours > 50 && hours <= 60) {
          buckets['51-60h'].userCount++;
          buckets['51-60h'].totalHours += hours;
          if (isAgent) buckets['51-60h'].agentCount++;
        } else if (hours > 60 && hours <= 70) {
          buckets['61-70h'].userCount++;
          buckets['61-70h'].totalHours += hours;
          if (isAgent) buckets['61-70h'].agentCount++;
        } else if (hours > 70 && hours <= 80) {
          buckets['71-80h'].userCount++;
          buckets['71-80h'].totalHours += hours;
          if (isAgent) buckets['71-80h'].agentCount++;
        } else if (hours > 80 && hours <= 90) {
          buckets['81-90h'].userCount++;
          buckets['81-90h'].totalHours += hours;
          if (isAgent) buckets['81-90h'].agentCount++;
        } else if (hours > 90 && hours <= 100) {
          buckets['91-100h'].userCount++;
          buckets['91-100h'].totalHours += hours;
          if (isAgent) buckets['91-100h'].agentCount++;
        } else if (hours > 100) {
          buckets['100+h'].userCount++;
          buckets['100+h'].totalHours += hours;
          if (isAgent) buckets['100+h'].agentCount++;
        }
      });

      el.hourBarChart.innerHTML = '';
      const maxValue = Math.max(...Object.values(buckets).map(b => b.totalHours));
      const bucketLabels = Object.keys(buckets);

      bucketLabels.forEach(label => {
        const data = buckets[label];
        const barHeight = maxValue > 0 ? (data.totalHours / maxValue * 100) : 0;
        const bar = document.createElement('div');
        bar.className = 'hour-bar';
        bar.style.height = `${barHeight}%`;
        bar.title = `${label}\nTotal Hours: ${Math.round(data.totalHours)}\nUsers: ${data.userCount}\nAgents: ${data.agentCount}`;
        bar.innerHTML = `
          <div class="hour-bar-value">${Math.round(data.totalHours)}h</div>
          <div class="hour-bar-label">${label}</div>
        `;
        el.hourBarChart.appendChild(bar);
      });
    }

    function createLicenseChart() {
      const ctx = document.getElementById('licenseChart').getContext('2d');
      if (appState.chartInstances.license) appState.chartInstances.license.destroy();
      if (!appState.analysisResults) return;

      const data = {
        labels: ['Named Users', 'Hourly Interacting Users', 'NOLOGIN Users'],
        datasets: [{
          data: [
            appState.analysisResults.namedUsers,
            appState.analysisResults.hiUsers,
            appState.analysisResults.nologinUsers
          ],
          backgroundColor: [
            'rgba(99, 171, 143, 0.8)',
            'rgba(40, 167, 69, 0.8)',
            'rgba(108, 117, 125, 0.8)'
          ],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      };

      appState.chartInstances.license = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { 
                padding: 20, 
                usePointStyle: true,
                font: {
                  family: "'Aptos', 'Segoe UI', system-ui, -apple-system, Arial, sans-serif",
                  size: 14
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} users (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    function exportReport() {
      if (!appState.analysisResults) {
        showStatusMessage('Please run analysis first', 'warn');
        return;
      }

      const results = appState.analysisResults;
      let csv = 'Genesys Cloud Hourly Billing Analysis Report\n';
      csv += `Generated: ${new Date().toLocaleString()}\n`;
      csv += `Period: ${el.dateFrom.value} to ${el.dateTo.value}\n`;
      csv += `Hourly Interacting Threshold: ${results.threshold} hours\n`;
      csv += `Named Licence Cost: ${appState.currencySymbol}${results.namedLicenseCost} per month\n`;
      csv += `Hourly Interacting Rate: ${appState.hourlyCurrencySymbol}${results.hourlyLicenseRate} per hour\n\n`;

      csv += 'SUMMARY\n';
      csv += 'Metric,Value\n';
      csv += `Total Users,${results.totalUsers}\n`;
      csv += `Active Users,${results.activeUsers}\n`;
      csv += `Named Users,${results.namedUsers}\n`;
      csv += `Hourly Interacting Users,${results.hiUsers}\n`;
      csv += `Hourly Interacting Hours,${Math.round(results.hiHours)}\n`;
      csv += `Hourly Interacting Cost,${appState.hourlyCurrencySymbol}${results.hourlyCost.toFixed(2)}\n`;
      csv += `NOLOGIN Users,${results.nologinUsers}\n`;
      csv += `Total Hours,${Math.round(results.totalHours)}\n`;
      csv += `All Named Cost,${appState.currencySymbol}${results.allNamedCost}\n`;
      csv += `Hybrid Cost,${appState.currencySymbol}${results.hybridCost}\n`;
      csv += `Cost Savings,${results.savings}%\n`;
      csv += `Optimal Model,${results.optimalModel}\n\n`;

      csv += 'HOURLY INTERACTING DETAILS\n';
      csv += 'Metric,Value\n';
      csv += `Hourly Users,${results.hiUsers}\n`;
      csv += `Total Hourly Hours,${Math.round(results.hiHours)}\n`;
      csv += `Average Hours per User,${results.avgHiHours.toFixed(1)}\n`;
      csv += `Hourly Cost,${appState.hourlyCurrencySymbol}${results.hourlyCost.toFixed(2)}\n\n`;

      csv += 'ROLE-BASED ANALYSIS\n';
      csv += 'Role Type,Metric,Value\n';
      csv += `Agent,Named Users,${results.agentNamed}\n`;
      csv += `Agent,Hourly Interacting Users,${results.agentHI}\n`;
      csv += `Supervisor,Named Users,${results.supervisorNamed}\n`;
      csv += `Admin,Named Users,${results.adminNamed}\n\n`;

      csv += 'USER DETAILS\n';
      csv += 'Name,Email,Team,Role Type,Roles,Last Login,Interacting Time (HH:MM:SS),Interacting Time (hours),Recommended Licence,Reason,Estimated Cost\n';

      results.users.forEach(user => {
        csv += `"${user.name || ''}","${user.email || ''}","${user.team || ''}","${user.userType || ''}","${user.role || ''}","${user.lastLogin || 'Never'}","${user.interactingHoursFormatted}",${Math.round(user.interactingHoursDecimal)},"${user.recommendedLicense || ''}","${user.recommendedReason || ''}",${(user.estimatedCost || 0).toFixed(2)}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `genesys_billing_analysis_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      logMessage('SUCCESS', 'Report exported', 'CSV file downloaded');
      showStatusMessage('‚úÖ Report exported to CSV', 'success');
    }

    function exportUsersTable() {
      if (!appState.userData || appState.userData.length === 0) {
        showStatusMessage('No user data to export', 'warn');
        return;
      }

      let csv = 'Genesys Cloud User Data Export\n';
      csv += `Generated: ${new Date().toLocaleString()}\n`;
      csv += `Period: ${el.dateFrom.value} to ${el.dateTo.value}\n`;
      csv += `Total Users: ${appState.userData.length}\n\n`;

      csv += 'Name,Email,Team,Role Type,Roles,Last Login,Interacting Time (HH:MM:SS),Interacting Time (hours),Recommended Licence,Reason,Estimated Cost\n';

      appState.userData.forEach(user => {
        csv += `"${user.name || ''}","${user.email || ''}","${user.team || ''}","${user.userType || ''}","${user.role || ''}","${user.lastLogin || 'Never'}","${user.interactingHoursFormatted}",${Math.round(user.interactingHoursDecimal)},"${user.recommendedLicense || ''}","${user.recommendedReason || ''}",${(user.estimatedCost || 0).toFixed(2)}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `genesys_users_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      logMessage('SUCCESS', 'Users table exported', `${appState.userData.length} users exported`);
      showStatusMessage(`‚úÖ Exported ${appState.userData.length} users to CSV`, 'success');
    }

    function exportOverageTable() {
      const threshold = parseFloat(el.thresholdHours.value) || 40;
      const usersOverThreshold = appState.userData.filter(user => 
        user.interactingHoursDecimal > threshold
      );

      if (usersOverThreshold.length === 0) {
        showStatusMessage('No overage data to export', 'warn');
        return;
      }

      let csv = 'Genesys Cloud Overage Analysis Export\n';
      csv += `Generated: ${new Date().toLocaleString()}\n`;
      csv += `Period: ${el.dateFrom.value} to ${el.dateTo.value}\n`;
      csv += `Threshold: ${threshold} hours\n`;
      csv += `Users Over Threshold: ${usersOverThreshold.length}\n\n`;

      csv += 'Name,Email,Team,Role Type,Roles,Interacting Hours,Over Threshold By,Percentage Over,Status\n';

      usersOverThreshold.sort((a, b) => b.interactingHoursDecimal - a.interactingHoursDecimal).forEach(user => {
        const overageHours = user.interactingHoursDecimal - threshold;
        const percentageOver = ((overageHours / threshold) * 100).toFixed(1);
        
        let statusText = '';
        if (percentageOver > 100) {
          statusText = 'Significant Overage';
        } else if (percentageOver > 50) {
          statusText = 'High Overage';
        } else if (percentageOver > 25) {
          statusText = 'Moderate Overage';
        } else {
          statusText = 'Minor Overage';
        }

        csv += `"${user.name || ''}","${user.email || ''}","${user.team || ''}","${user.userType || ''}","${user.role || ''}",${Math.round(user.interactingHoursDecimal)},${Math.round(overageHours)},${percentageOver}%,"${statusText}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `genesys_overage_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      logMessage('SUCCESS', 'Overage table exported', `${usersOverThreshold.length} users exported`);
      showStatusMessage(`‚úÖ Exported ${usersOverThreshold.length} overage users to CSV`, 'success');
    }

    function resetApplication() {
      if (confirm('Reset the application? This will clear all data but keep the connection.')) {
        appState.userData = [];
        appState.analysisResults = null;
        el.statTotalUsers.textContent = '0';
        el.statActiveUsers.textContent = '0';
        el.statNamedUsers.textContent = '0';
        el.statHiUsers.textContent = '0';
        el.statHiHours.textContent = '0 hours';
        el.statAgents.textContent = '0';
        el.statSupervisors.textContent = '0';
        el.statAdmins.textContent = '0';
        el.statOthers.textContent = '0';
        el.statAgentNamed.textContent = '0';
        el.statAgentHI.textContent = '0';
        el.statSupervisorNamed.textContent = '0';
        el.statAdminNamed.textContent = '0';
        el.statHiUsersDetailed.textContent = '0';
        el.statTotalHiHours.textContent = '0';
        el.statAvgHiHours.textContent = '0';
        el.statHourlyCost.textContent = `${appState.hourlyCurrencySymbol}0`;
        el.totalCost.textContent = `${appState.currencySymbol}0`;
        el.savings.textContent = '0% savings';
        el.costDetails.innerHTML = '';
        el.licenseModel.textContent = 'Hybrid';
        el.totalCount.textContent = '0';
        el.visibleCount.textContent = '0';
        el.totalUsersCount.textContent = '0';
        el.totalAgentsCount.textContent = '0';
        el.btnAnalyze.disabled = true;
        el.btnRunAnalysis.disabled = true;
        el.btnExport.disabled = true;
        el.btnExportUsers.disabled = true;
        el.btnExportOverage.disabled = true;

        el.usersTableBody.innerHTML = `
          <tr><td colspan="8" style="text-align:center;padding:48px;color:var(--text-light);">
            No data loaded. Connect and fetch data first.
          </td></tr>
        `;

        el.hourBuckets.innerHTML = '';
        el.agentCounts.innerHTML = '';
        el.hourBarChart.innerHTML = '';
        el.hourStats.innerHTML = '';
        
        el.overageTableBody.innerHTML = `
          <tr><td colspan="8" class="no-overage-message">
            No data available. Fetch user data and run analysis first.
          </td></tr>
        `;
        el.overageCount.textContent = '0';
        el.totalOverageHours.textContent = '0';

        if (appState.chartInstances.license) appState.chartInstances.license.destroy();

        logMessage('INFO', 'Application reset', 'All data cleared');
        showStatusMessage('üîÑ Application reset', 'info');
      }
    }

    function initializeApp() {
      // Set max date to today
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      el.dateTo.max = todayStr;
      el.dateFrom.max = todayStr;
      
      // Load stored preferences
      const storedCurrency = localStorage.getItem(STORAGE_KEYS.CURRENCY);
      const storedHourlyCurrency = localStorage.getItem(STORAGE_KEYS.HOURLY_CURRENCY);
      const storedDateFrom = localStorage.getItem(STORAGE_KEYS.DATE_FROM);
      const storedDateTo = localStorage.getItem(STORAGE_KEYS.DATE_TO);
      
      if (storedCurrency) {
        appState.currencySymbol = storedCurrency;
        el.currencySymbol.value = storedCurrency;
      }
      
      if (storedHourlyCurrency) {
        appState.hourlyCurrencySymbol = storedHourlyCurrency;
        el.hourlyCurrencySymbol.value = storedHourlyCurrency;
      }
      
      // Set default dates
      if (!storedDateFrom || !storedDateTo) {
        const mostRecentMonth = getMostRecentMonth();
        el.dateFrom.value = mostRecentMonth.from;
        el.dateTo.value = mostRecentMonth.to;
      } else {
        el.dateFrom.value = storedDateFrom;
        el.dateTo.value = storedDateTo;
      }
      
      // Save dates when changed
      el.dateFrom.addEventListener('change', () => {
        localStorage.setItem(STORAGE_KEYS.DATE_FROM, el.dateFrom.value);
      });
      el.dateTo.addEventListener('change', () => {
        localStorage.setItem(STORAGE_KEYS.DATE_TO, el.dateTo.value);
      });
      
      updateDateRangeInfo();

      // Event listeners
      el.btnDisconnect.addEventListener('click', disconnect);
      el.btnSwitchClient.addEventListener('click', switchClient);
      el.btnFetchData.addEventListener('click', fetchUserData);
      el.btnRunAnalysis.addEventListener('click', runAnalysis);
      el.btnAnalyze.addEventListener('click', runAnalysis);
      el.btnExport.addEventListener('click', exportReport);
      el.btnExportUsers.addEventListener('click', exportUsersTable);
      el.btnExportOverage.addEventListener('click', exportOverageTable);
      el.btnReset.addEventListener('click', resetApplication);

      el.dateFrom.addEventListener('change', updateDateRangeInfo);
      el.dateTo.addEventListener('change', updateDateRangeInfo);
      el.dateFrom.addEventListener('input', updateDateRangeInfo);
      el.dateTo.addEventListener('input', updateDateRangeInfo);

      el.userSearch.addEventListener('input', renderUserTable);
      el.userFilter.addEventListener('change', renderUserTable);
      
      el.thresholdHours.addEventListener('change', () => {
        if (appState.userData.length > 0) {
          updateOverageTable();
        }
      });

      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          appState.currentTab = tabId;
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            if (content.id === `tab-${tabId}`) content.classList.add('active');
          });
          logMessage('INFO', 'Tab switched', tabId);
        });
      });

      el.btnClearLogs.addEventListener('click', () => {
        el.logsTableBody.innerHTML = '';
        appState.logs = [];
        logMessage('INFO', 'Logs cleared');
      });

      el.btnCopyLogs.addEventListener('click', () => {
        const logText = appState.logs.map(log =>
          `${log.timestamp} [${log.level}] ${log.message} ${log.details ? '- ' + log.details : ''}`
        ).join('\n');
        navigator.clipboard.writeText(logText).then(() => showStatusMessage('Logs copied to clipboard', 'success'));
      });

      // Currency change handlers
      el.currencySymbol.addEventListener('change', function() {
        appState.currencySymbol = this.value;
        localStorage.setItem(STORAGE_KEYS.CURRENCY, this.value);
        updateCurrencyDisplay();
        logMessage('INFO', 'Currency updated', `Named licence currency: ${this.value}`);
      });
      
      el.hourlyCurrencySymbol.addEventListener('change', function() {
        appState.hourlyCurrencySymbol = this.value;
        localStorage.setItem(STORAGE_KEYS.HOURLY_CURRENCY, this.value);
        updateCurrencyDisplay();
        logMessage('INFO', 'Currency updated', `Hourly rate currency: ${this.value}`);
      });

      // Update cost displays when values change
      el.namedLicenseCost.addEventListener('change', () => {
        updateCurrencyDisplay();
      });
      
      el.hourlyLicenseRate.addEventListener('change', () => {
        updateCurrencyDisplay();
      });

      // Initial currency display update
      updateCurrencyDisplay();

      logMessage('INFO', 'Hourly Billing Calculator initialised', `Active Client ID: ${CLIENT_ID.substring(0,8)}...`);
    }

    document.addEventListener('DOMContentLoaded', function() {
      initAuth();
    });
  </script>
</body>
</html>
