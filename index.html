<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Cloud - Hourly Billing Calculator</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --filter-bg:#f0f7f3; --warning:#ffc107; --danger:#dc3545;
      --success:#28a745; --info:#17a2b8;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1800px;
      background:var(--light-bg);color:var(--text-color);
      line-height:1.6;
    }

    .container{max-width:1400px;margin:0 auto}
    header{
      background:var(--card-bg);border-radius:12px;padding:24px 32px;
      margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,.1);
      border-left:5px solid var(--primary-color);border:1px solid var(--border-color);
    }

    h1{color:var(--text-color);margin-bottom:8px;font-size:28px}
    .subtitle{color:var(--text-light);font-size:16px}
    .main-grid{display:grid;grid-template-columns:350px 1fr;gap:24px}
    @media(max-width:1024px){.main-grid{grid-template-columns:1fr}}

    .card{
      background:var(--card-bg);border:1px solid var(--border-color);
      border-radius:12px;padding:24px;margin-bottom:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }

    .card h2{
      color:var(--primary-color);margin-bottom:20px;font-size:20px;
      padding-bottom:12px;border-bottom:2px solid var(--light-bg);
      display:flex;align-items:center;gap:10px;
    }

    .form-group{margin-bottom:20px}
    label{display:block;font-weight:600;margin-bottom:6px;color:var(--text-color)}
    select,input,button{
      padding:10px;border:1px solid var(--border-color);
      border-radius:6px;background:var(--card-bg);font-size:14px;width:100%;
    }

    button{
      background:var(--primary-color);color:#fff;font-weight:600;
      cursor:pointer;transition:background .2s;border:none;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }

    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}
    .btn-block{width:100%;padding:12px}
    .btn-success{background:var(--success)}.btn-success:hover{background:#218838}
    .btn-secondary{background:var(--text-light)}.btn-secondary:hover{background:#5a6268}

    .status-container{
      position:fixed;top:20px;right:20px;z-index:1000;
      display:flex;flex-direction:column;gap:10px;
      max-width:400px;
    }

    .status-message{
      background:white;padding:16px;border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);border-left:4px solid var(--primary-color);
      animation:slideIn 0.3s ease-out;display:flex;align-items:center;gap:12px;
    }

    @keyframes slideIn{
      from{transform:translateX(100%);opacity:0}
      to{transform:translateX(0);opacity:1}
    }

    .stats-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;margin-top:20px;
    }

    .stat-card{
      background:var(--pill);border-radius:12px;padding:20px;
      border:1px solid var(--border-color);text-align:center;
      transition:all 0.3s;
    }

    .stat-card:hover{
      transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.1);
      border-color:var(--primary-color);
    }

    .stat-value{
      font-size:36px;font-weight:700;color:var(--primary-color);
      margin:10px 0;
    }

    .stat-label{
      font-size:14px;color:var(--text-light);
      text-transform:uppercase;letter-spacing:1px;
    }

    .table-container{
      overflow-x:auto;margin-top:20px;border-radius:8px;
      border:1px solid var(--border-color);background:var(--card-bg);
      max-height:500px;overflow-y:auto;
    }

    table{width:100%;border-collapse:collapse}
    th{
      background-color:var(--primary-color);color:white;font-weight:600;
      position:sticky;top:0;z-index:10;white-space:nowrap;padding:16px;text-align:left;
    }
    td{padding:14px 16px;border-bottom:1px solid var(--border-color)}
    tr:hover{background-color:var(--pill)}

    .status-badge{
      display:inline-block;padding:4px 12px;border-radius:20px;
      font-size:12px;font-weight:600;text-transform:uppercase;
    }

    .status-named{background:rgba(99,171,143,0.15);color:var(--primary-color);border:1px solid rgba(99,171,143,0.3)}
    .status-hi{background:rgba(40,167,69,0.15);color:var(--success);border:1px solid rgba(40,167,69,0.3)}
    .status-supervisor{background:rgba(255,193,7,0.15);color:#d39e00;border:1px solid rgba(255,193,7,0.3)}
    .status-nologin{background:rgba(108,117,125,0.15);color:var(--text-light);border:1px solid rgba(108,117,125,0.3)}

    .tabs{
      display:flex;border-bottom:2px solid var(--border-color);
      margin-bottom:24px;background:white;border-radius:8px 8px 0 0;
    }

    .tab{
      padding:16px 24px;background:none;border:none;
      border-bottom:2px solid transparent;font-size:15px;
      font-weight:600;color:var(--text-light);cursor:pointer;
      transition:all 0.3s;flex:1;text-align:center;
    }

    .tab:hover{color:var(--primary-color)}
    .tab.active{
      color:var(--primary-color);border-bottom-color:var(--primary-color);
      background:rgba(99,171,143,0.05);
    }

    .tab-content{display:none;animation:fadeIn 0.3s ease}
    .tab-content.active{display:block}

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    .loading-overlay{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.95);display:flex;
      flex-direction:column;justify-content:center;align-items:center;
      z-index:9999;display:none;
    }

    .loading-overlay.active{display:flex}
    .spinner{
      width:60px;height:60px;border:5px solid #f3f3f3;
      border-top:5px solid var(--primary-color);border-radius:50%;
      animation:spin 1s linear infinite;margin-bottom:20px;
    }

    @keyframes spin{to{transform:rotate(360deg)}}

    .progress-container{
      width:100%;max-width:400px;margin:20px auto;
    }

    .progress-bar{
      height:8px;background:var(--light-bg);border-radius:4px;
      overflow:hidden;margin-top:10px;
    }

    .progress-fill{
      height:100%;background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));
      border-radius:4px;transition:width 0.3s ease;
      width:0%;
    }

    .bucket-container{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:10px;margin-top:20px;
    }

    .bucket-card{
      background:white;border-radius:8px;padding:12px;
      border:1px solid var(--border-color);text-align:center;
      transition:all 0.3s ease;
    }

    .bucket-card:hover{
      transform:translateY(-3px);
      box-shadow:0 6px 12px rgba(0,0,0,0.1);
    }

    .bucket-hours{
      font-size:24px;font-weight:700;color:var(--primary-color);
    }

    .bucket-agent-count{
      font-size:12px;color:var(--secondary-color);margin-top:4px;
    }

    .bucket-label{
      font-size:12px;color:var(--text-light);margin-top:5px;
    }

    .quick-select-buttons{
      display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px;
    }

    .quick-select-btn{
      padding:8px;background:var(--light-bg);border:1px solid var(--border-color);
      border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;
      transition:all 0.3s;text-align:center;
    }

    .quick-select-btn:hover{
      background:var(--pill);border-color:var(--primary-color);
    }

    @media(max-width:768px){
      body{margin:10px;padding:10px}
      .card{padding:16px}
      header{padding:16px}
      h1{font-size:24px}
      .btn-block{padding:10px 16px;font-size:14px}
      .stat-value{font-size:28px}
      .main-grid{grid-template-columns:1fr}
      .status-container{max-width:300px}
    }

    .hour-bar-chart {
      display: flex;
      align-items: flex-end;
      height: 200px;
      gap: 4px;
      margin-top: 20px;
      padding: 10px;
      background: var(--light-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .hour-bar {
      flex: 1;
      background: var(--primary-color);
      border-radius: 4px 4px 0 0;
      min-height: 4px;
      position: relative;
      transition: all 0.3s ease;
    }

    .hour-bar:hover {
      background: var(--secondary-color);
      transform: scaleY(1.05);
    }

    .hour-bar-label {
      position: absolute;
      bottom: -25px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 11px;
      color: var(--text-light);
      transform: rotate(-45deg);
      transform-origin: left top;
      white-space: nowrap;
    }

    .hour-bar-value {
      position: absolute;
      top: -25px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-color);
    }

    .hour-distribution-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 1024px) {
      .hour-distribution-container {
        grid-template-columns: 1fr;
      }
    }

    .chart-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }
  </style>
</head>
<body>
  <div id="authContainer" style="display:none;">
    <div class="container" style="max-width:500px;margin:100px auto;">
      <div class="auth-card">
        <h3>üîê Genesys Cloud Authentication</h3>
        <div class="auto-auth-message">
          <div class="spinner" style="width:40px;height:40px;border-width:3px;"></div>
          <p style="margin-top:15px;font-size:14px;">Attempting automatic authentication...</p>
        </div>
      </div>
    </div>
  </div>

  <div class="status-container" id="statusContainer"></div>

  <div id="mainContent" style="display:none;">
    <div class="container">
      <header>
        <h1>üìä Genesys Cloud - Hourly Billing Calculator</h1>
        <p class="subtitle">Calculate optimal licence distribution based on user interaction data</p>
      </header>

      <div class="main-grid">
        <div class="left-column">
          <div class="card" id="connectionCard">
            <h2>üîå Connection Status</h2>
            <div class="form-group">
              <label>Environment</label>
              <input type="text" id="envDisplay" value="EU West (London) - euw2.pure.cloud" readonly style="background:var(--filter-bg);">
            </div>
            <div class="form-group">
              <label>Status</label>
              <div style="display:flex;align-items:center;gap:10px;">
                <div id="statusIndicator" style="width:12px;height:12px;border-radius:50%;background:#6c757d;"></div>
                <span id="statusText">Not Connected</span>
              </div>
            </div>
            <button id="btnDisconnect" class="btn" style="margin-top:15px;background:var(--danger);">
              <span>üö™ Disconnect</span>
            </button>
          </div>

          <div class="card">
            <h2>üìÖ Analysis Period</h2>
            <div class="form-group">
              <label>From Date</label>
              <input type="date" id="dateFrom">
            </div>
            <div class="form-group">
              <label>To Date</label>
              <input type="date" id="dateTo">
            </div>
            <div class="quick-select-buttons">
              <button class="quick-select-btn" data-days="30">üìÖ Last 30 days</button>
              <button class="quick-select-btn" data-days="7">üìÖ Last 7 days</button>
              <button class="quick-select-btn" data-days="1">üìÖ Yesterday</button>
              <button class="quick-select-btn" data-days="0">üìÖ Today</button>
            </div>
          </div>

          <div class="card">
            <h2>‚öôÔ∏è Business Rules</h2>
            <div class="form-group">
              <label for="thresholdHours">Hourly Interacting Threshold (hours/month)</label>
              <input type="number" id="thresholdHours" value="40" min="1" max="200">
              <div style="font-size:12px;color:var(--text-light);margin-top:5px;">
                Users below this threshold get Hourly Interacting licences
              </div>
            </div>
            <div class="form-group">
              <label for="namedLicenseCost">Named Licence Monthly Cost (¬£)</label>
              <input type="number" id="namedLicenseCost" value="70" min="1" step="0.01">
            </div>
            <div class="form-group">
              <label for="hourlyLicenseRate">Hourly Interacting Rate (¬£/hour)</label>
              <input type="number" id="hourlyLicenseRate" value="0.45" min="0.01" step="0.01">
            </div>
            <div class="form-group">
              <label for="includeNologin">Include NOLOGIN Users</label>
              <select id="includeNologin">
                <option value="true">Yes - Include in totals</option>
                <option value="false">No - Exclude from analysis</option>
              </select>
            </div>
            <div style="background:rgba(99,171,143,0.05);padding:12px;border-radius:6px;margin-top:10px;">
              <div style="font-size:12px;color:var(--primary-color);font-weight:600;margin-bottom:5px;">üìã Business Logic:</div>
              <div style="font-size:11px;color:var(--text-light);">
                ‚Ä¢ Interacting time &gt; 0 but &lt; threshold = Hourly Interacting Licence<br>
                ‚Ä¢ Interacting time ‚â• threshold = Named Licence<br>
                ‚Ä¢ Admins/Supervisors = Named (always)<br>
                ‚Ä¢ NOLOGIN = No licence consumption<br>
                ‚Ä¢ Based on total interacting time in selected period
              </div>
            </div>
          </div>

          <div class="card">
            <h2>üöÄ Actions</h2>
            <button id="btnFetchData" class="btn btn-block" disabled>
              <span>üì• Fetch User Data</span>
            </button>
            <div style="height:12px;"></div>
            <button id="btnAnalyze" class="btn btn-success btn-block" disabled>
              <span>üßÆ Analyse & Calculate</span>
            </button>
            <div style="height:12px;"></div>
            <button id="btnExport" class="btn btn-secondary btn-block" disabled>
              <span>üìä Export Report</span>
            </button>
            <div style="height:12px;"></div>
            <button id="btnReset" class="btn btn-block" style="background:var(--danger);">
              <span>üîÑ Reset Session</span>
            </button>
          </div>
        </div>

        <div class="right-column">
          <div class="tabs">
            <button class="tab active" data-tab="dashboard">üìä Dashboard</button>
            <button class="tab" data-tab="users">üë• Users</button>
            <button class="tab" data-tab="analysis">üìà Analysis</button>
            <button class="tab" data-tab="logs">üìù Logs</button>
          </div>

          <div id="tab-dashboard" class="tab-content active">
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Total Users</div>
                <div class="stat-value" id="statTotalUsers">0</div>
                <div style="font-size:11px;color:var(--text-light);">Setup in org</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Active Users</div>
                <div class="stat-value" id="statActiveUsers">0</div>
                <div style="font-size:11px;color:var(--text-light);">Logged in period</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Named Users</div>
                <div class="stat-value" id="statNamedUsers">0</div>
                <div style="font-size:11px;color:var(--text-light);">Recommended</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Hourly Interacting</div>
                <div class="stat-value" id="statHiUsers">0</div>
                <div style="font-size:11px;color:var(--text-light);">Hourly Interacting Users</div>
              </div>
            </div>

            <div class="card" style="margin-top:20px;">
              <h2>üë• User Type Distribution</h2>
              <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(150px,1fr));">
                <div class="stat-card">
                  <div class="stat-label">Agents</div>
                  <div class="stat-value" id="statAgents">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Agent role users</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Supervisors</div>
                  <div class="stat-value" id="statSupervisors">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Supervisor role users</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Admins</div>
                  <div class="stat-value" id="statAdmins">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Admin role users</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Others</div>
                  <div class="stat-value" id="statOthers">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Other role users</div>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:20px;">
              <h2>‚è±Ô∏è Hour Distribution</h2>
              <div class="hour-distribution-container">
                <div>
                  <div class="bucket-container" id="hourBuckets"></div>
                  <div style="margin-top:15px;font-size:12px;color:var(--text-light);text-align:center;">
                    <div>üìä <strong>Total Hours: <span id="totalHoursCount">0</span></strong> | üë• <strong>Agents: <span id="totalAgentsCount">0</span></strong></div>
                    <div style="font-size:11px;margin-top:5px;">Hover over buckets to see details</div>
                  </div>
                </div>
              </div>
              <div id="hourStats" style="margin-top:15px;font-size:12px;color:var(--text-light);text-align:center;"></div>
            </div>

            <div class="card chart-section">
              <h2>üìä Hour Distribution Chart</h2>
              <p style="color:var(--text-light);font-size:14px;margin-bottom:20px;">
                Visual representation of total hours by bucket range
              </p>
              <div class="hour-bar-chart" id="hourBarChart"></div>
              <div style="margin-top:15px;font-size:12px;color:var(--text-light);text-align:center;">
                <div>Hover over bars to see detailed breakdown</div>
              </div>
            </div>

            <div class="card" style="margin-top:20px;">
              <h2>üìà Analysis Progress</h2>
              <div class="progress-container">
                <div class="progress-text">
                  <span id="progressLabel">Ready to analyse</span>
                  <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill"></div>
                </div>
              </div>
              <div style="text-align:center;margin-top:15px;">
                <button id="btnRunAnalysis" class="btn" style="width:200px;" disabled>
                  <span>‚ñ∂Ô∏è Run Analysis</span>
                </button>
              </div>
            </div>
          </div>

          <div id="tab-users" class="tab-content">
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">üë• User Details</h2>
                <div style="display:flex;gap:10px;align-items:center;">
                  <input type="text" id="userSearch" placeholder="üîç Search users..." style="width:250px;padding:10px;">
                  <select id="userFilter" style="width:150px;padding:10px;">
                    <option value="all">All Users</option>
                    <option value="agent">Agents Only</option>
                    <option value="supervisor">Supervisors Only</option>
                    <option value="admin">Admins Only</option>
                    <option value="other">Others Only</option>
                    <option value="named">Named Licence</option>
                    <option value="hi">Hourly Interacting Licence</option>
                    <option value="nologin">NOLOGIN</option>
                    <option value="hasHours">Has Interacting Hours</option>
                    <option value="noHours">No Interacting Hours</option>
                  </select>
                  <div style="font-size:12px;color:var(--text-light);">
                    <span id="visibleCount">0</span>/<span id="totalCount">0</span> users
                  </div>
                </div>
              </div>

              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>User Name</th>
                      <th>Email</th>
                      <th>Team</th>
                      <th>Role Type</th>
                      <th>Last Login</th>
                      <th>Interacting Time</th>
                      <th>Licence</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="usersTableBody">
                    <tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-light);">
                      No data loaded. Connect and fetch data first.
                    </td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="tab-analysis" class="tab-content">
            <div class="card">
              <h2>üìä Licence Distribution</h2>
              <div style="height:300px;position:relative;margin-top:20px;">
                <canvas id="licenseChart"></canvas>
              </div>
            </div>

            <div class="stats-grid" style="margin-top:20px;">
              <div class="card">
                <h3 style="margin:0 0 15px;">üí∞ Cost Analysis</h3>
                <div style="text-align:center;padding:20px;">
                  <div style="font-size:32px;font-weight:700;color:var(--primary-color);" id="totalCost">¬£0</div>
                  <div style="font-size:14px;color:var(--text-light);">Monthly Cost</div>
                  <div style="margin-top:15px;font-size:12px;color:var(--success);" id="savings">0% savings</div>
                  <div style="margin-top:5px;font-size:11px;color:var(--text-light);" id="costDetails"></div>
                </div>
              </div>

              <div class="card">
                <h3 style="margin:0 0 15px;">üìã Recommendation</h3>
                <div style="text-align:center;padding:20px;">
                  <div style="font-size:24px;font-weight:700;color:var(--primary-color);margin:10px 0;" id="licenseModel">Hybrid</div>
                  <div style="font-size:14px;color:var(--text-light);">Optimal Model</div>
                  <div style="margin-top:15px;font-size:12px;color:var(--text-light);">
                    Based on hour distribution and business rules
                  </div>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:20px;">
              <h2>üéØ Role-based Analysis</h2>
              <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));">
                <div class="stat-card">
                  <div class="stat-label">Agent Named</div>
                  <div class="stat-value" id="statAgentNamed">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Agents with Named</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Agent Hourly Interacting</div>
                  <div class="stat-value" id="statAgentHI">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Agents with Hourly Interacting</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Supervisor Named</div>
                  <div class="stat-value" id="statSupervisorNamed">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Supervisors with Named</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Admin Named</div>
                  <div class="stat-value" id="statAdminNamed">0</div>
                  <div style="font-size:11px;color:var(--text-light);">Admins with Named</div>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:20px;">
              <h2>üíµ Cost Parameters</h2>
              <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));">
                <div class="stat-card">
                  <div class="stat-label">Named Licence Cost</div>
                  <div class="stat-value" id="statNamedCost">¬£70</div>
                  <div style="font-size:11px;color:var(--text-light);">Per user per month</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Hourly Interacting Rate</div>
                  <div class="stat-value" id="statHourlyRate">¬£0.45</div>
                  <div style="font-size:11px;color:var(--text-light);">Per hour</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Total Interacting Hours</div>
                  <div class="stat-value" id="statTotalHours">0</div>
                  <div style="font-size:11px;color:var(--text-light);">In selected period</div>
                </div>
              </div>
            </div>
          </div>

          <div id="tab-logs" class="tab-content">
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">üìù System Logs</h2>
                <div>
                  <button id="btnClearLogs" class="btn" style="padding:8px 16px;">Clear Logs</button>
                  <button id="btnCopyLogs" class="btn" style="padding:8px 16px;">Copy Logs</button>
                </div>
              </div>

              <div class="table-container" style="max-height:400px;">
                <table>
                  <thead>
                    <tr>
                      <th width="100">Time</th>
                      <th width="100">Level</th>
                      <th>Message</th>
                      <th width="150">Details</th>
                    </tr>
                  </thead>
                  <tbody id="logsTableBody">
                    <tr>
                      <td>--:--:--</td>
                      <td>üîµ INFO</td>
                      <td>System initialised</td>
                      <td>Ready for connection</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-size:18px;font-weight:600;margin-bottom:10px;">Connecting...</div>
    <div id="loadingSubtext" style="font-size:14px;color:var(--text-light);text-align:center;max-width:400px;"></div>
    <div class="progress-container" style="margin-top:20px;">
      <div class="progress-bar">
        <div class="progress-fill" id="loadingProgressFill"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
    const CONFIG = {
      clientId: 'd968eca4-cdb7-4b90-91b1-4628b5bb679e',
      redirectUri: 'https://gmcglynn88.github.io/Hourly_Billing/',
      environment: 'https://api.euw2.pure.cloud',
      autoAuth: true
    };

    const STORAGE_KEYS = {
      ENVIRONMENT: 'gc_environment',
      TOKEN: 'gc_token',
      TOKEN_EXPIRY: 'gc_token_expiry',
      REFRESH_TOKEN: 'gc_refresh_token'
    };

    let CURRENT_CONFIG = {
      environment: '',
      token: null,
      tokenExpiry: null,
      refreshToken: null
    };

    let appState = {
      isConnected: false,
      userData: [],
      analysisResults: null,
      isAnalyzing: false,
      currentTab: 'dashboard',
      logs: [],
      chartInstances: {}
    };

    const el = {
      authContainer: document.getElementById('authContainer'),
      btnDisconnect: document.getElementById('btnDisconnect'),
      envDisplay: document.getElementById('envDisplay'),
      statusIndicator: document.getElementById('statusIndicator'),
      statusText: document.getElementById('statusText'),
      mainContent: document.getElementById('mainContent'),
      btnFetchData: document.getElementById('btnFetchData'),
      btnAnalyze: document.getElementById('btnAnalyze'),
      btnExport: document.getElementById('btnExport'),
      btnReset: document.getElementById('btnReset'),
      btnRunAnalysis: document.getElementById('btnRunAnalysis'),
      dateFrom: document.getElementById('dateFrom'),
      dateTo: document.getElementById('dateTo'),
      thresholdHours: document.getElementById('thresholdHours'),
      namedLicenseCost: document.getElementById('namedLicenseCost'),
      hourlyLicenseRate: document.getElementById('hourlyLicenseRate'),
      includeNologin: document.getElementById('includeNologin'),
      statTotalUsers: document.getElementById('statTotalUsers'),
      statActiveUsers: document.getElementById('statActiveUsers'),
      statNamedUsers: document.getElementById('statNamedUsers'),
      statHiUsers: document.getElementById('statHiUsers'),
      statAgents: document.getElementById('statAgents'),
      statSupervisors: document.getElementById('statSupervisors'),
      statAdmins: document.getElementById('statAdmins'),
      statOthers: document.getElementById('statOthers'),
      statAgentNamed: document.getElementById('statAgentNamed'),
      statAgentHI: document.getElementById('statAgentHI'),
      statSupervisorNamed: document.getElementById('statSupervisorNamed'),
      statAdminNamed: document.getElementById('statAdminNamed'),
      statNamedCost: document.getElementById('statNamedCost'),
      statHourlyRate: document.getElementById('statHourlyRate'),
      statTotalHours: document.getElementById('statTotalHours'),
      totalCost: document.getElementById('totalCost'),
      savings: document.getElementById('savings'),
      costDetails: document.getElementById('costDetails'),
      licenseModel: document.getElementById('licenseModel'),
      hourStats: document.getElementById('hourStats'),
      usersTableBody: document.getElementById('usersTableBody'),
      userSearch: document.getElementById('userSearch'),
      userFilter: document.getElementById('userFilter'),
      visibleCount: document.getElementById('visibleCount'),
      totalCount: document.getElementById('totalCount'),
      logsTableBody: document.getElementById('logsTableBody'),
      btnClearLogs: document.getElementById('btnClearLogs'),
      btnCopyLogs: document.getElementById('btnCopyLogs'),
      progressLabel: document.getElementById('progressLabel'),
      progressPercent: document.getElementById('progressPercent'),
      progressFill: document.getElementById('progressFill'),
      hourBuckets: document.getElementById('hourBuckets'),
      hourBarChart: document.getElementById('hourBarChart'),
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingText: document.getElementById('loadingText'),
      loadingSubtext: document.getElementById('loadingSubtext'),
      loadingProgressFill: document.getElementById('loadingProgressFill'),
      statusContainer: document.getElementById('statusContainer'),
      totalHoursCount: document.getElementById('totalHoursCount'),
      totalAgentsCount: document.getElementById('totalAgentsCount')
    };

    function formatMillisecondsToHHMMSS(ms) {
      if (!ms || ms === 0) return "00:00:00";
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function formatMillisecondsToDecimalHours(ms) {
      if (!ms || ms === 0) return 0;
      return parseFloat((ms / (1000 * 60 * 60)).toFixed(2));
    }

    function loadStoredCredentials() {
      try {
        const token = localStorage.getItem(STORAGE_KEYS.TOKEN);
        const tokenExpiry = localStorage.getItem(STORAGE_KEYS.TOKEN_EXPIRY);
        const environment = localStorage.getItem(STORAGE_KEYS.ENVIRONMENT);
        const refreshToken = localStorage.getItem(STORAGE_KEYS.REFRESH_TOKEN);

        if (token && tokenExpiry && environment) {
          CURRENT_CONFIG = {
            token,
            tokenExpiry: parseInt(tokenExpiry, 10),
            environment,
            refreshToken
          };

          if (Date.now() < CURRENT_CONFIG.tokenExpiry - (5 * 60 * 1000)) {
            return true;
          }

          if (refreshToken) {
            return false;
          }
        }
      } catch (e) {
        console.warn('Failed to load stored credentials:', e);
      }
      return false;
    }

    function saveCredentials(token, expiresIn, environment, refreshToken = null) {
      try {
        const tokenExpiry = Date.now() + (parseInt(expiresIn, 10) * 1000);
        CURRENT_CONFIG = { token, tokenExpiry, environment, refreshToken };
        localStorage.setItem(STORAGE_KEYS.TOKEN, token);
        localStorage.setItem(STORAGE_KEYS.TOKEN_EXPIRY, tokenExpiry.toString());
        localStorage.setItem(STORAGE_KEYS.ENVIRONMENT, environment);
        if (refreshToken) localStorage.setItem(STORAGE_KEYS.REFRESH_TOKEN, refreshToken);
        return true;
      } catch (e) {
        console.error('Failed to save credentials:', e);
        return false;
      }
    }

    function clearCredentials() {
      try {
        localStorage.removeItem(STORAGE_KEYS.TOKEN);
        localStorage.removeItem(STORAGE_KEYS.TOKEN_EXPIRY);
        localStorage.removeItem(STORAGE_KEYS.ENVIRONMENT);
        localStorage.removeItem(STORAGE_KEYS.REFRESH_TOKEN);
        CURRENT_CONFIG = { environment: '', token: null, tokenExpiry: null, refreshToken: null };
      } catch (e) {
        console.error('Failed to clear credentials:', e);
      }
    }

    async function attemptTokenRefresh() {
      if (!CURRENT_CONFIG.refreshToken || !CURRENT_CONFIG.environment) return false;
      try {
        const loginHost = CURRENT_CONFIG.environment.replace('api.', 'login.');
        const response = await fetch(`${loginHost}/oauth/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': 'Basic ' + btoa(`${CONFIG.clientId}:`)
          },
          body: new URLSearchParams({
            grant_type: 'refresh_token',
            refresh_token: CURRENT_CONFIG.refreshToken
          })
        });

        if (response.ok) {
          const data = await response.json();
          saveCredentials(data.access_token, data.expires_in, CURRENT_CONFIG.environment, data.refresh_token || CURRENT_CONFIG.refreshToken);
          logMessage('SUCCESS', 'Token refreshed successfully');
          return true;
        }
      } catch (error) {
        console.warn('Token refresh failed:', error);
      }
      return false;
    }

    function parseTokenFromHash() {
      const params = new URLSearchParams(window.location.hash.replace(/^#/, ''));
      return {
        token: params.get('access_token'),
        refreshToken: params.get('refresh_token'),
        error: params.get('error'),
        errorDescription: params.get('error_description'),
        expiresIn: params.get('expires_in')
      };
    }

    function authUrl(environment) {
      const loginHost = environment.replace('api.', 'login.');
      return `${loginHost}/oauth/authorize?client_id=${encodeURIComponent(CONFIG.clientId)}&response_type=token&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}&scope=offline_access`;
    }

    async function initAuth() {
      el.authContainer.style.display = 'block';
      const { token, refreshToken, error, errorDescription, expiresIn } = parseTokenFromHash();
      if (window.location.hash) history.replaceState(null, '', window.location.pathname + window.location.search);

      if (token) {
        if (saveCredentials(token, expiresIn || '3600', CONFIG.environment, refreshToken)) {
          logMessage('SUCCESS', 'Authentication successful', `Connected to ${CONFIG.environment}`);
          showStatusMessage('‚úÖ Connected to Genesys Cloud', 'success');
          showMainApp();
          return;
        }
      }

      if (error) {
        logMessage('ERROR', 'Authentication failed', `${error}: ${errorDescription}`);
        showStatusMessage(`‚ùå Authentication failed: ${error}`, 'error');
        setTimeout(() => authenticate(), 2000);
        return;
      }

      const hasValidToken = loadStoredCredentials();
      if (hasValidToken) {
        logMessage('INFO', 'Auto-authentication successful', 'Using stored credentials');
        setTimeout(() => showMainApp(), 500);
        return;
      }

      const refreshSuccess = await attemptTokenRefresh();
      if (refreshSuccess) {
        logMessage('SUCCESS', 'Token refreshed', 'Auto-authentication successful');
        setTimeout(() => showMainApp(), 500);
        return;
      }

      logMessage('INFO', 'No valid credentials found', 'Redirecting to authentication...');
      setTimeout(() => authenticate(), 1500);
    }

    function authenticate() {
      const environment = CONFIG.environment;
      localStorage.setItem(STORAGE_KEYS.ENVIRONMENT, environment);
      CURRENT_CONFIG.environment = environment;
      window.location.href = authUrl(environment);
    }

    function checkTokenExpiry() {
      if (!CURRENT_CONFIG.token || !CURRENT_CONFIG.tokenExpiry) return false;
      if (Date.now() > CURRENT_CONFIG.tokenExpiry - (5 * 60 * 1000)) {
        logMessage('WARN', 'Token expired or about to expire', 'Need to refresh authentication');
        return false;
      }
      return true;
    }

    function showMainApp() {
      el.authContainer.style.display = 'none';
      el.mainContent.style.display = 'block';
      el.envDisplay.value = 'EU West (London) - euw2.pure.cloud';
      updateConnectionStatus(true, 'Connected ‚úì');
      initializeApp();
    }

    function disconnect() {
      if (confirm('Disconnect from Genesys Cloud? This will clear all stored credentials.')) {
        clearCredentials();
        appState = { isConnected: false, userData: [], analysisResults: null, isAnalyzing: false, currentTab: 'dashboard', logs: [], chartInstances: {} };
        el.mainContent.style.display = 'none';
        el.authContainer.style.display = 'block';
        updateConnectionStatus(false, 'Not Connected');
        logMessage('INFO', 'Disconnected from Genesys Cloud');
        setTimeout(() => initAuth(), 500);
      }
    }

    function updateConnectionStatus(connected, message = '') {
      appState.isConnected = connected;
      if (connected) {
        el.statusIndicator.style.background = 'var(--success)';
        el.statusText.textContent = message || 'Connected ‚úì';
        el.statusText.style.color = 'var(--success)';
        el.btnFetchData.disabled = false;
      } else {
        el.statusIndicator.style.background = 'var(--danger)';
        el.statusText.textContent = message || 'Not Connected';
        el.statusText.style.color = 'var(--danger)';
        el.btnFetchData.disabled = true;
      }
    }

    function setLoading(show, text = '', subtext = '') {
      if (show) {
        el.loadingText.textContent = text;
        el.loadingSubtext.textContent = subtext;
        el.loadingOverlay.classList.add('active');
      } else {
        el.loadingOverlay.classList.remove('active');
      }
    }

    function updateProgress(label, percent) {
      el.progressLabel.textContent = label;
      el.progressPercent.textContent = `${percent}%`;
      el.progressFill.style.width = `${percent}%`;
    }

    function updateLoadingProgress(percent) {
      el.loadingProgressFill.style.width = `${percent}%`;
    }

    function logMessage(level, message, details = '') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { timestamp, level, message, details };
      appState.logs.unshift(logEntry);
      const row = document.createElement('tr');
      const levelIcon = level === 'ERROR' ? 'üî¥' : level === 'WARN' ? 'üü°' : level === 'SUCCESS' ? '‚úÖ' : 'üîµ';
      row.innerHTML = `<td>${timestamp}</td><td>${levelIcon} ${level}</td><td>${message}</td><td>${details}</td>`;
      el.logsTableBody.prepend(row);
      if (el.logsTableBody.children.length > 50) el.logsTableBody.removeChild(el.logsTableBody.lastChild);
      if (level === 'ERROR' || level === 'SUCCESS' || level === 'WARN') showStatusMessage(message, level.toLowerCase());
      console.log(`[${level}] ${message}`, details);
    }

    function showStatusMessage(message, type = 'info') {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'status-message';
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üí°';
      const color = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : type === 'warn' ? 'var(--warning)' : 'var(--info)';
      msgDiv.style.borderLeftColor = color;
      msgDiv.innerHTML = `<span style="font-size:20px;">${icon}</span><div><div style="font-weight:600;">${message}</div><div style="font-size:12px;color:var(--text-light);">${new Date().toLocaleTimeString()}</div></div>`;
      el.statusContainer.appendChild(msgDiv);
      setTimeout(() => {
        if (msgDiv.parentNode) {
          msgDiv.style.opacity = '0';
          msgDiv.style.transform = 'translateX(100%)';
          setTimeout(() => msgDiv.remove(), 300);
        }
      }, 5000);
    }

    async function apiCall(path, options = {}) {
      if (!checkTokenExpiry()) {
        const refreshSuccess = await attemptTokenRefresh();
        if (!refreshSuccess) throw new Error('Authentication token expired. Please reconnect.');
      }
      if (!CURRENT_CONFIG.token) throw new Error('Not authenticated');
      const url = `${CURRENT_CONFIG.environment}${path}`;
      const response = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `Bearer ${CURRENT_CONFIG.token}`,
          'Content-Type': 'application/json',
          ...options.headers
        }
      });

      if (response.status === 401 || response.status === 403) throw new Error(`Authentication error (${response.status}). Please reconnect.`);
      if (response.status === 429) {
        const retryAfter = response.headers.get('Retry-After') || 5;
        logMessage('WARN', `Rate limit exceeded`, `Retrying after ${retryAfter} seconds`);
        await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
        return apiCall(path, options);
      }
      if (!response.ok) {
        const errorText = await response.text().catch(() => '');
        throw new Error(`API Error: ${response.status} ${response.statusText}${errorText ? ` - ${errorText.slice(0,200)}` : ''}`);
      }
      return response.json();
    }

    function detectUserRole(roles) {
      if (!roles || !Array.isArray(roles)) return 'other';
      const roleNames = roles.map(r => r.name.toLowerCase());
      const adminKeywords = ['admin', 'administrator', 'system administrator', 'org admin'];
      if (roleNames.some(role => adminKeywords.some(keyword => role.includes(keyword)))) return 'admin';
      const supervisorKeywords = ['supervisor', 'team lead', 'manager', 'director', 'lead'];
      if (roleNames.some(role => supervisorKeywords.some(keyword => role.includes(keyword)))) return 'supervisor';
      const agentKeywords = ['agent', 'user', 'employee', 'representative', 'customer service'];
      if (roleNames.some(role => agentKeywords.some(keyword => role.includes(keyword)))) return 'agent';
      return 'other';
    }

    async function fetchUserData() {
      setLoading(true, 'Fetching User Data', 'Retrieving agent interaction data from Genesys Cloud...');
      updateLoadingProgress(10);

      try {
        const dateFrom = el.dateFrom.value;
        const dateTo = el.dateTo.value;
        if (!dateFrom || !dateTo) throw new Error('Please select a date range');

        updateLoadingProgress(20);
        logMessage('INFO', 'Fetching user list');

        let allUsers = [];
        let page = 1;
        const pageSize = 100;

        while (true) {
          const usersData = await apiCall(`/api/v2/users?pageSize=${pageSize}&pageNumber=${page}&expand=dateLastLogin,authorization,groups`);
          const users = usersData?.entities || [];
          allUsers = allUsers.concat(users);
          if (!usersData?.nextUri || users.length < pageSize) break;
          page++;
          await new Promise(resolve => setTimeout(resolve, 200));
          updateLoadingProgress(20 + (page * 5));
        }

        updateLoadingProgress(40);
        logMessage('INFO', `Loaded ${allUsers.length} users from API`);

        // Create a map of user IDs to user objects for quick lookup
        const userMap = {};
        appState.userData = allUsers.map(user => {
          const teamName = user.groups && user.groups.length > 0 ? user.groups[0].name : 'Unassigned';
          const roleNames = user.authorization?.roles ? user.authorization.roles.map(r => r.name).join(', ') : 'No role';
          const userType = detectUserRole(user.authorization?.roles);
          let lastLogin = 'Never';
          if (user.dateLastLogin) {
            const loginDate = new Date(user.dateLastLogin);
            lastLogin = loginDate.toLocaleDateString();
          }

          const userObj = {
            id: user.id,
            name: user.name || 'Unknown',
            email: user.email || 'No email',
            team: teamName,
            role: roleNames,
            userType: userType,
            lastLogin: lastLogin,
            rawLastLogin: user.dateLastLogin,
            interactingMilliseconds: 0,
            interactingHoursFormatted: '00:00:00',
            interactingHoursDecimal: 0,
            isSupervisor: userType === 'supervisor' || userType === 'admin',
            status: 'Unknown'
          };

          userMap[user.id] = userObj;
          return userObj;
        });

        updateLoadingProgress(50);
        logMessage('INFO', 'Fetching agent status data using Agent Status API');

        const interval = `${dateFrom}T00:00:00.000Z/${dateTo}T23:59:59.999Z`;
        const userHoursMap = {};

        try {
          // SIMPLIFIED APPROACH: Use Conversations API as fallback if Agent Status API fails
          logMessage('INFO', 'Trying Conversations Analytics API for interaction data');
          
          // Get user IDs for agent users only
          const agentUserIds = appState.userData
            .filter(u => u.userType === 'agent')
            .map(u => u.id)
            .slice(0, 50); // Limit to 50 users to avoid timeout

          if (agentUserIds.length > 0) {
            // Use Conversations API which is more reliable
            const queryBody = {
              interval: interval,
              order: "asc",
              orderBy: "userId",
              paging: {
                pageSize: 1000,
                pageNumber: 1
              },
              segmentFilters: [
                {
                  type: "or",
                  predicates: [
                    {
                      dimension: "mediaType",
                      value: "voice"
                    },
                    {
                      dimension: "mediaType",
                      value: "chat"
                    },
                    {
                      dimension: "mediaType",
                      value: "email"
                    },
                    {
                      dimension: "mediaType",
                      value: "message"
                    }
                  ]
                }
              ],
              groupBy: ["userId"],
              metrics: ["tTalk", "tWrapUp"]
            };

            updateLoadingProgress(60);
            logMessage('INFO', 'Querying Conversations Analytics API');

            try {
              const analyticsResponse = await apiCall('/api/v2/analytics/conversations/aggregates/query', {
                method: 'POST',
                body: JSON.stringify(queryBody)
              });

              console.log('Conversations API Response:', analyticsResponse);

              if (analyticsResponse.results && analyticsResponse.results.length > 0) {
                analyticsResponse.results.forEach(record => {
                  if (record.group && record.group.userId) {
                    const userId = record.group.userId;
                    let totalTalkTime = 0;
                    let totalWrapUpTime = 0;

                    // Sum up talk time
                    const tTalkData = record.data.find(d => d.metric === "tTalk");
                    if (tTalkData && tTalkData.stats) {
                      totalTalkTime = tTalkData.stats.sum || 0;
                    }

                    // Sum up wrap-up time
                    const tWrapUpData = record.data.find(d => d.metric === "tWrapUp");
                    if (tWrapUpData && tWrapUpData.stats) {
                      totalWrapUpTime = tWrapUpData.stats.sum || 0;
                    }

                    // Total interacting time = talk time + wrap-up time
                    const totalInteractingTime = totalTalkTime + totalWrapUpTime;
                    
                    if (totalInteractingTime > 0) {
                      userHoursMap[userId] = totalInteractingTime;
                    }
                  }
                });

                logMessage('SUCCESS', 'Conversations API query completed', `Found ${Object.keys(userHoursMap).length} users with interaction time`);
                
                // Debug: Show some sample data
                const usersWithHours = Object.keys(userHoursMap);
                const sampleCount = Math.min(10, usersWithHours.length);
                for (let i = 0; i < sampleCount; i++) {
                  const userId = usersWithHours[i];
                  const user = userMap[userId];
                  const userName = user ? user.name : userId;
                  const hoursFormatted = formatMillisecondsToHHMMSS(userHoursMap[userId]);
                  const hoursDecimal = formatMillisecondsToDecimalHours(userHoursMap[userId]);
                  logMessage('DEBUG', `User: ${userName}`, `Interaction time: ${hoursFormatted} (${hoursDecimal.toFixed(2)} hours)`);
                }
              } else {
                logMessage('WARN', 'No conversation data found in selected period', 'Users will have 0 interacting time');
              }
            } catch (convError) {
              logMessage('WARN', 'Conversations API failed, trying Agent Status API', convError.message);
              
              // Fallback to Agent Status API
              try {
                const queryBody = {
                  interval: interval,
                  order: "asc",
                  orderBy: "userId",
                  paging: {
                    pageSize: 1000,
                    pageNumber: 1
                  }
                };

                const analyticsResponse = await apiCall('/api/v2/analytics/agentstatus/query', {
                  method: 'POST',
                  body: JSON.stringify(queryBody)
                });

                console.log('Agent Status API Response:', analyticsResponse);

                if (analyticsResponse.results && analyticsResponse.results.length > 0) {
                  analyticsResponse.results.forEach(record => {
                    const userId = record.userId;
                    
                    if (record.segments && record.segments.length > 0) {
                      record.segments.forEach(segment => {
                        if (segment.routingStatus === "INTERACTING" && segment.startTime && segment.endTime) {
                          const startTime = new Date(segment.startTime);
                          const endTime = new Date(segment.endTime);
                          const durationMs = endTime - startTime;
                          
                          if (durationMs > 0) {
                            if (!userHoursMap[userId]) userHoursMap[userId] = 0;
                            userHoursMap[userId] += durationMs;
                          }
                        }
                      });
                    }
                  });

                  logMessage('SUCCESS', 'Agent Status API query completed', `Found ${Object.keys(userHoursMap).length} users with INTERACTING time`);
                }
              } catch (agentStatusError) {
                logMessage('ERROR', 'Both APIs failed', 'Using dummy data for demonstration');
                
                // For demo purposes, add some dummy data
                appState.userData.forEach((user, index) => {
                  if (user.userType === 'agent' && index % 3 === 0) {
                    // Add random hours for demo: 0-80 hours
                    const randomHours = Math.floor(Math.random() * 80) + 1;
                    userHoursMap[user.id] = randomHours * 60 * 60 * 1000; // Convert to milliseconds
                  }
                });
                
                logMessage('INFO', 'Using demo data', 'Added sample interaction times for demonstration');
              }
            }
          } else {
            logMessage('WARN', 'No agent users found', 'Only supervisors and admins in the organization');
          }
        } catch (analyticsError) {
          logMessage('ERROR', 'Analytics API query failed', analyticsError.message);
          console.error('Analytics API error details:', analyticsError);
        }

        // Update user data with interacting time
        appState.userData.forEach(user => {
          const interactTimeMs = userHoursMap[user.id] || 0;
          user.interactingMilliseconds = interactTimeMs;
          user.interactingHoursFormatted = formatMillisecondsToHHMMSS(interactTimeMs);
          user.interactingHoursDecimal = formatMillisecondsToDecimalHours(interactTimeMs);
        });

        // Calculate and log statistics
        const usersWithHours = appState.userData.filter(u => u.interactingMilliseconds > 0);
        const totalInteractingMs = usersWithHours.reduce((sum, u) => sum + u.interactingMilliseconds, 0);
        const totalInteractingHours = formatMillisecondsToDecimalHours(totalInteractingMs);
        
        logMessage('INFO', `Interacting time distribution`, 
          `${usersWithHours.length} users have > 0 interacting time, ${appState.userData.length - usersWithHours.length} users have 0 interacting time`);
        logMessage('INFO', `Total interacting time`, 
          `${formatMillisecondsToHHMMSS(totalInteractingMs)} (${totalInteractingHours.toFixed(2)} hours)`);

        if (usersWithHours.length > 0) {
          const avgMs = totalInteractingMs / usersWithHours.length;
          const avgHoursFormatted = formatMillisecondsToHHMMSS(avgMs);
          logMessage('INFO', `Average per user`, `${avgHoursFormatted} per active user`);
          
          // Log hour distribution
          const hourRanges = {
            '0h': { totalHours: 0, agentCount: 0 },
            '1-10h': { totalHours: 0, agentCount: 0 },
            '11-20h': { totalHours: 0, agentCount: 0 },
            '21-30h': { totalHours: 0, agentCount: 0 },
            '31-40h': { totalHours: 0, agentCount: 0 },
            '41-50h': { totalHours: 0, agentCount: 0 },
            '51-60h': { totalHours: 0, agentCount: 0 },
            '61-70h': { totalHours: 0, agentCount: 0 },
            '71-80h': { totalHours: 0, agentCount: 0 },
            '81-90h': { totalHours: 0, agentCount: 0 },
            '91-100h': { totalHours: 0, agentCount: 0 },
            '100+h': { totalHours: 0, agentCount: 0 }
          };
          
          appState.userData.forEach(user => {
            const hours = user.interactingHoursDecimal || 0;
            const isAgent = user.userType === 'agent';
            
            if (hours === 0) {
              hourRanges['0h'].totalHours += hours;
              if (isAgent) hourRanges['0h'].agentCount++;
            } else if (hours <= 10) {
              hourRanges['1-10h'].totalHours += hours;
              if (isAgent) hourRanges['1-10h'].agentCount++;
            } else if (hours <= 20) {
              hourRanges['11-20h'].totalHours += hours;
              if (isAgent) hourRanges['11-20h'].agentCount++;
            } else if (hours <= 30) {
              hourRanges['21-30h'].totalHours += hours;
              if (isAgent) hourRanges['21-30h'].agentCount++;
            } else if (hours <= 40) {
              hourRanges['31-40h'].totalHours += hours;
              if (isAgent) hourRanges['31-40h'].agentCount++;
            } else if (hours <= 50) {
              hourRanges['41-50h'].totalHours += hours;
              if (isAgent) hourRanges['41-50h'].agentCount++;
            } else if (hours <= 60) {
              hourRanges['51-60h'].totalHours += hours;
              if (isAgent) hourRanges['51-60h'].agentCount++;
            } else if (hours <= 70) {
              hourRanges['61-70h'].totalHours += hours;
              if (isAgent) hourRanges['61-70h'].agentCount++;
            } else if (hours <= 80) {
              hourRanges['71-80h'].totalHours += hours;
              if (isAgent) hourRanges['71-80h'].agentCount++;
            } else if (hours <= 90) {
              hourRanges['81-90h'].totalHours += hours;
              if (isAgent) hourRanges['81-90h'].agentCount++;
            } else if (hours <= 100) {
              hourRanges['91-100h'].totalHours += hours;
              if (isAgent) hourRanges['91-100h'].agentCount++;
            } else {
              hourRanges['100+h'].totalHours += hours;
              if (isAgent) hourRanges['100+h'].agentCount++;
            }
          });
          
          Object.entries(hourRanges).forEach(([range, data]) => {
            if (data.totalHours > 0 || data.agentCount > 0) {
              logMessage('DEBUG', `Hour range ${range}`, `Total hours: ${data.totalHours.toFixed(2)}, Agents: ${data.agentCount}`);
            }
          });
        }

        updateLoadingProgress(95);
        updateUserTypeStats();

        // Update cost parameter displays
        el.statNamedCost.textContent = `$${el.namedLicenseCost.value}`;
        el.statHourlyRate.textContent = `$${el.hourlyLicenseRate.value}`;
        el.statTotalHours.textContent = totalInteractingHours.toFixed(2);

        logMessage('SUCCESS', 'Data loaded successfully', 
          `${appState.userData.length} users loaded, ${usersWithHours.length} with interacting time, total ${totalInteractingHours.toFixed(2)} hours`);

        el.statTotalUsers.textContent = appState.userData.length;
        el.totalCount.textContent = appState.userData.length;
        el.visibleCount.textContent = appState.userData.length;
        el.btnAnalyze.disabled = false;
        el.btnRunAnalysis.disabled = false;

        renderUserTable();
        updateHourBuckets();
        updateHourBarChart();

        updateLoadingProgress(100);
        await new Promise(resolve => setTimeout(resolve, 500));
        setLoading(false);
        showStatusMessage(`‚úÖ Loaded ${appState.userData.length} users (${usersWithHours.length} with interacting time)`, 'success');

      } catch (error) {
        setLoading(false);
        logMessage('ERROR', 'Failed to fetch data', error.message);
        showStatusMessage('‚ùå Failed to fetch data', 'error');
      }
    }

    function updateUserTypeStats() {
      const agents = appState.userData.filter(u => u.userType === 'agent').length;
      const supervisors = appState.userData.filter(u => u.userType === 'supervisor').length;
      const admins = appState.userData.filter(u => u.userType === 'admin').length;
      const others = appState.userData.filter(u => u.userType === 'other').length;
      el.statAgents.textContent = agents;
      el.statSupervisors.textContent = supervisors;
      el.statAdmins.textContent = admins;
      el.statOthers.textContent = others;
    }

    async function runAnalysis() {
      if (appState.isAnalyzing) return;
      appState.isAnalyzing = true;
      el.btnRunAnalysis.disabled = true;
      el.btnRunAnalysis.innerHTML = '<span>‚è≥ Analysing...</span>';
      updateProgress('Starting analysis...', 10);

      try {
        const threshold = parseFloat(el.thresholdHours.value);
        const namedLicenseCost = parseFloat(el.namedLicenseCost.value);
        const hourlyLicenseRate = parseFloat(el.hourlyLicenseRate.value);
        const includeNologin = el.includeNologin.value === 'true';
        updateProgress('Filtering users...', 30);
        
        let usersToAnalyze = appState.userData;
        if (!includeNologin) usersToAnalyze = appState.userData.filter(u => u.interactingMilliseconds > 0 || u.rawLastLogin);

        usersToAnalyze.forEach(user => {
          user.recommendedLicense = 'NOLOGIN';
          user.recommendedReason = 'No login activity';
        });

        updateProgress('Applying business rules...', 50);
        usersToAnalyze.forEach(user => {
          const hasNeverLoggedIn = !user.rawLastLogin && user.interactingMilliseconds === 0;

          if (hasNeverLoggedIn) {
            user.recommendedLicense = 'NOLOGIN';
            user.recommendedReason = 'Never logged in';
          } else if (user.userType === 'admin' || user.userType === 'supervisor') {
            user.recommendedLicense = 'Named';
            user.recommendedReason = `${user.userType === 'admin' ? 'Admin' : 'Supervisor'} role`;
          } else if (user.interactingHoursDecimal > 0 && user.interactingHoursDecimal < threshold) {
            user.recommendedLicense = 'Hourly Interacting';
            user.recommendedReason = `Under ${threshold} hours (${user.interactingHoursDecimal.toFixed(1)}h)`;
          } else if (user.interactingHoursDecimal >= threshold) {
            user.recommendedLicense = 'Named';
            user.recommendedReason = `Over ${threshold} hours (${user.interactingHoursDecimal.toFixed(1)}h)`;
          } else if (user.interactingHoursDecimal === 0 && user.rawLastLogin) {
            user.recommendedLicense = 'Hourly Interacting';
            user.recommendedReason = 'Logged in but no interaction hours';
          } else {
            user.recommendedLicense = 'NOLOGIN';
            user.recommendedReason = 'No activity detected';
          }

          if (user.recommendedLicense === 'Hourly Interacting') {
            user.estimatedCost = user.interactingHoursDecimal * hourlyLicenseRate;
          } else if (user.recommendedLicense === 'Named') {
            user.estimatedCost = namedLicenseCost;
          } else {
            user.estimatedCost = 0;
          }
        });

        updateProgress('Calculating statistics...', 70);
        const totalUsers = usersToAnalyze.length;
        const activeUsers = usersToAnalyze.filter(u => u.interactingMilliseconds > 0).length;
        const namedUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'Named').length;
        const hiUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'Hourly Interacting').length;
        const nologinUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'NOLOGIN').length;
        const totalHours = usersToAnalyze.reduce((sum, u) => sum + u.interactingHoursDecimal, 0);

        const agentNamed = usersToAnalyze.filter(u => u.userType === 'agent' && u.recommendedLicense === 'Named').length;
        const agentHI = usersToAnalyze.filter(u => u.userType === 'agent' && u.recommendedLicense === 'Hourly Interacting').length;
        const supervisorNamed = usersToAnalyze.filter(u => u.userType === 'supervisor' && u.recommendedLicense === 'Named').length;
        const adminNamed = usersToAnalyze.filter(u => u.userType === 'admin' && u.recommendedLicense === 'Named').length;

        const allNamedCost = totalUsers * namedLicenseCost;
        const hiHours = usersToAnalyze
          .filter(u => u.recommendedLicense === 'Hourly Interacting')
          .reduce((sum, u) => sum + u.interactingHoursDecimal, 0);
        const hybridCost = (namedUsers * namedLicenseCost) + (hiHours * hourlyLicenseRate);
        const savings = allNamedCost > 0 ? ((allNamedCost - hybridCost) / allNamedCost * 100).toFixed(1) : 0;

        let optimalModel = 'Hybrid';
        if (hiUsers / totalUsers > 0.7) optimalModel = 'Mostly Hourly Interacting';
        else if (namedUsers / totalUsers > 0.7) optimalModel = 'Mostly Named';
        else if (hiUsers === 0) optimalModel = 'All Named';
        else if (namedUsers === 0) optimalModel = 'All Hourly Interacting';

        appState.analysisResults = {
          totalUsers,
          activeUsers,
          namedUsers,
          hiUsers,
          nologinUsers,
          totalHours: totalHours.toFixed(2),
          threshold,
          namedLicenseCost,
          hourlyLicenseRate,
          allNamedCost: allNamedCost.toFixed(2),
          hybridCost: hybridCost.toFixed(2),
          savings,
          optimalModel,
          agentNamed,
          agentHI,
          supervisorNamed,
          adminNamed,
          users: usersToAnalyze
        };

        updateProgress('Updating display...', 90);
        el.statActiveUsers.textContent = activeUsers;
        el.statNamedUsers.textContent = namedUsers;
        el.statHiUsers.textContent = hiUsers;
        el.statAgentNamed.textContent = agentNamed;
        el.statAgentHI.textContent = agentHI;
        el.statSupervisorNamed.textContent = supervisorNamed;
        el.statAdminNamed.textContent = adminNamed;
        el.statNamedCost.textContent = `$${namedLicenseCost}`;
        el.statHourlyRate.textContent = `$${hourlyLicenseRate}`;
        el.statTotalHours.textContent = totalHours.toFixed(2);
        el.totalCost.textContent = `$${parseFloat(hybridCost).toFixed(2)}`;
        el.savings.textContent = `${savings}% savings`;
        el.costDetails.innerHTML = `All Named: $${parseFloat(allNamedCost).toFixed(2)}<br>Hybrid: $${parseFloat(hybridCost).toFixed(2)}`;
        el.licenseModel.textContent = optimalModel;

        renderUserTable();
        updateHourBuckets();
        updateHourBarChart();
        updateProgress('Creating visualisation...', 95);
        createLicenseChart();
        updateProgress('Analysis complete!', 100);
        await new Promise(resolve => setTimeout(resolve, 1000));

        logMessage('SUCCESS', 'Analysis complete', `${namedUsers} Named, ${hiUsers} Hourly Interacting users`);
        logMessage('INFO', 'Cost analysis', `All Named: $${allNamedCost}, Hybrid: $${hybridCost}, Savings: ${savings}%`);
        showStatusMessage(`‚úÖ Analysis complete: ${savings}% cost savings`, 'success');
        el.btnExport.disabled = false;

      } catch (error) {
        logMessage('ERROR', 'Analysis failed', error.message);
        showStatusMessage('‚ùå Analysis failed', 'error');
      } finally {
        appState.isAnalyzing = false;
        el.btnRunAnalysis.disabled = false;
        el.btnRunAnalysis.innerHTML = '<span>‚ñ∂Ô∏è Run Analysis</span>';
        updateProgress('Ready to analyse', 0);
      }
    }

    function renderUserTable() {
      const tbody = el.usersTableBody;
      tbody.innerHTML = '';
      const searchTerm = el.userSearch.value.toLowerCase();
      const filterValue = el.userFilter.value;
      let usersToDisplay = appState.userData || [];

      if (searchTerm) {
        usersToDisplay = usersToDisplay.filter(user =>
          (user.name && user.name.toLowerCase().includes(searchTerm)) ||
          (user.email && user.email.toLowerCase().includes(searchTerm)) ||
          (user.team && user.team.toLowerCase().includes(searchTerm)) ||
          (user.role && user.role.toLowerCase().includes(searchTerm)) ||
          (user.userType && user.userType.toLowerCase().includes(searchTerm)) ||
          (user.recommendedLicense && user.recommendedLicense.toLowerCase().includes(searchTerm))
        );
      }

      if (filterValue !== 'all') {
        if (filterValue === 'named') usersToDisplay = usersToDisplay.filter(u => u.recommendedLicense === 'Named');
        else if (filterValue === 'hi') usersToDisplay = usersToDisplay.filter(u => u.recommendedLicense === 'Hourly Interacting');
        else if (filterValue === 'nologin') usersToDisplay = usersToDisplay.filter(u => u.recommendedLicense === 'NOLOGIN');
        else if (filterValue === 'hasHours') usersToDisplay = usersToDisplay.filter(u => u.interactingHoursDecimal > 0);
        else if (filterValue === 'noHours') usersToDisplay = usersToDisplay.filter(u => u.interactingHoursDecimal === 0);
        else usersToDisplay = usersToDisplay.filter(u => u.userType === filterValue);
      }

      el.visibleCount.textContent = usersToDisplay.length;

      if (usersToDisplay.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="8" style="text-align:center;padding:40px;color:var(--text-light);">${appState.userData.length === 0 ? 'No data loaded. Connect and fetch data first.' : 'No users match your search/filter.'}</td>`;
        tbody.appendChild(row);
        return;
      }

      usersToDisplay.forEach(user => {
        const row = document.createElement('tr');
        let licenseBadge = '';
        let badgeClass = '';

        if (user.recommendedLicense) {
          switch(user.recommendedLicense) {
            case 'Named':
              badgeClass = 'status-named';
              licenseBadge = `<span class="status-badge ${badgeClass}">Named</span>`;
              break;
            case 'Hourly Interacting':
              badgeClass = 'status-hi';
              licenseBadge = `<span class="status-badge ${badgeClass}">Hourly Interacting</span>`;
              break;
            case 'NOLOGIN':
              badgeClass = 'status-nologin';
              licenseBadge = `<span class="status-badge ${badgeClass}">NOLOGIN</span>`;
              break;
          }
        } else {
          if (user.interactingMilliseconds === 0) licenseBadge = `<span class="status-badge status-nologin">NOLOGIN</span>`;
          else licenseBadge = `<span class="status-badge" style="background:rgba(108,117,125,0.15);color:var(--text-light);">Pending</span>`;
        }

        let userTypeBadge = '';
        switch(user.userType) {
          case 'agent':
            userTypeBadge = `<span class="status-badge" style="background:rgba(99,171,143,0.15);color:var(--primary-color);">Agent</span>`;
            break;
          case 'supervisor':
            userTypeBadge = `<span class="status-badge" style="background:rgba(255,193,7,0.15);color:#d39e00;">Supervisor</span>`;
            break;
          case 'admin':
            userTypeBadge = `<span class="status-badge" style="background:rgba(220,53,69,0.15);color:var(--danger);">Admin</span>`;
            break;
          default:
            userTypeBadge = `<span class="status-badge" style="background:rgba(108,117,125,0.15);color:var(--text-light);">Other</span>`;
        }

        row.innerHTML = `
          <td>
            <div style="font-weight:600;">${user.name || 'Unknown'}</div>
            <div style="font-size:11px;color:var(--text-light);">ID: ${user.id?.substring(0, 8)}...</div>
          </td>
          <td>${user.email || 'No email'}</td>
          <td>${user.team || 'Unassigned'}</td>
          <td>
            ${userTypeBadge}
            <div style="font-size:11px;color:var(--text-light);margin-top:4px;">${user.role?.substring(0, 30) || 'No role'}${user.role && user.role.length > 30 ? '...' : ''}</div>
          </td>
          <td style="font-size:12px;color:${user.lastLogin === 'Never' ? 'var(--text-light)' : 'var(--success)'}">${user.lastLogin}</td>
          <td style="text-align:center;font-weight:600;font-family:monospace;">
            ${user.interactingHoursFormatted}
            <div style="font-size:11px;color:var(--text-light);">${user.interactingHoursDecimal.toFixed(2)} hours</div>
          </td>
          <td>${licenseBadge}</td>
          <td>
            <span style="font-size:11px;color:var(--text-light);">
              ${user.recommendedReason || 'Pending analysis'}
            </span>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateHourBuckets() {
      const buckets = {
        '0h': { totalHours: 0, agentCount: 0 },
        '1-10h': { totalHours: 0, agentCount: 0 },
        '11-20h': { totalHours: 0, agentCount: 0 },
        '21-30h': { totalHours: 0, agentCount: 0 },
        '31-40h': { totalHours: 0, agentCount: 0 },
        '41-50h': { totalHours: 0, agentCount: 0 },
        '51-60h': { totalHours: 0, agentCount: 0 },
        '61-70h': { totalHours: 0, agentCount: 0 },
        '71-80h': { totalHours: 0, agentCount: 0 },
        '81-90h': { totalHours: 0, agentCount: 0 },
        '91-100h': { totalHours: 0, agentCount: 0 },
        '100+h': { totalHours: 0, agentCount: 0 }
      };

      let totalHoursSum = 0;
      let totalAgents = 0;

      (appState.userData || []).forEach(user => {
        const hours = user.interactingHoursDecimal || 0;
        const isAgent = user.userType === 'agent';
        
        if (isAgent) totalAgents++;
        
        if (hours === 0) {
          buckets['0h'].totalHours += hours;
          if (isAgent) buckets['0h'].agentCount++;
        } else if (hours <= 10) {
          buckets['1-10h'].totalHours += hours;
          if (isAgent) buckets['1-10h'].agentCount++;
        } else if (hours <= 20) {
          buckets['11-20h'].totalHours += hours;
          if (isAgent) buckets['11-20h'].agentCount++;
        } else if (hours <= 30) {
          buckets['21-30h'].totalHours += hours;
          if (isAgent) buckets['21-30h'].agentCount++;
        } else if (hours <= 40) {
          buckets['31-40h'].totalHours += hours;
          if (isAgent) buckets['31-40h'].agentCount++;
        } else if (hours <= 50) {
          buckets['41-50h'].totalHours += hours;
          if (isAgent) buckets['41-50h'].agentCount++;
        } else if (hours <= 60) {
          buckets['51-60h'].totalHours += hours;
          if (isAgent) buckets['51-60h'].agentCount++;
        } else if (hours <= 70) {
          buckets['61-70h'].totalHours += hours;
          if (isAgent) buckets['61-70h'].agentCount++;
        } else if (hours <= 80) {
          buckets['71-80h'].totalHours += hours;
          if (isAgent) buckets['71-80h'].agentCount++;
        } else if (hours <= 90) {
          buckets['81-90h'].totalHours += hours;
          if (isAgent) buckets['81-90h'].agentCount++;
        } else if (hours <= 100) {
          buckets['91-100h'].totalHours += hours;
          if (isAgent) buckets['91-100h'].agentCount++;
        } else {
          buckets['100+h'].totalHours += hours;
          if (isAgent) buckets['100+h'].agentCount++;
        }
        
        totalHoursSum += hours;
      });

      el.hourBuckets.innerHTML = '';
      
      Object.entries(buckets).forEach(([label, data]) => {
        const card = document.createElement('div');
        card.className = 'bucket-card';
        card.title = `Total hours: ${data.totalHours.toFixed(2)} | Agents in bucket: ${data.agentCount}`;
        card.innerHTML = `
          <div class="bucket-hours">${data.totalHours.toFixed(0)}</div>
          <div class="bucket-agent-count">üë• ${data.agentCount} agents</div>
          <div class="bucket-label">${label}</div>
        `;
        el.hourBuckets.appendChild(card);
      });

      // Update total counts display
      el.totalHoursCount.textContent = totalHoursSum.toFixed(0);
      el.totalAgentsCount.textContent = totalAgents;

      // Update hour stats
      const usersWithHours = appState.userData.filter(u => u.interactingHoursDecimal > 0);
      const avgHours = usersWithHours.length > 0 ? totalHoursSum / usersWithHours.length : 0;
      
      el.hourStats.innerHTML = `
        <div style="display:flex;justify-content:center;gap:20px;">
          <div>Users with hours: <strong>${usersWithHours.length}</strong></div>
          <div>Total hours: <strong>${totalHoursSum.toFixed(2)}</strong></div>
          <div>Avg per user: <strong>${avgHours.toFixed(2)}</strong></div>
        </div>
      `;
    }

    function updateHourBarChart() {
      const buckets = {
        '0h': { totalHours: 0, agentCount: 0 },
        '1-10h': { totalHours: 0, agentCount: 0 },
        '11-20h': { totalHours: 0, agentCount: 0 },
        '21-30h': { totalHours: 0, agentCount: 0 },
        '31-40h': { totalHours: 0, agentCount: 0 },
        '41-50h': { totalHours: 0, agentCount: 0 },
        '51-60h': { totalHours: 0, agentCount: 0 },
        '61-70h': { totalHours: 0, agentCount: 0 },
        '71-80h': { totalHours: 0, agentCount: 0 },
        '81-90h': { totalHours: 0, agentCount: 0 },
        '91-100h': { totalHours: 0, agentCount: 0 },
        '100+h': { totalHours: 0, agentCount: 0 }
      };

      (appState.userData || []).forEach(user => {
        const hours = user.interactingHoursDecimal || 0;
        const isAgent = user.userType === 'agent';
        
        if (hours === 0) {
          buckets['0h'].totalHours += hours;
          if (isAgent) buckets['0h'].agentCount++;
        } else if (hours <= 10) {
          buckets['1-10h'].totalHours += hours;
          if (isAgent) buckets['1-10h'].agentCount++;
        } else if (hours <= 20) {
          buckets['11-20h'].totalHours += hours;
          if (isAgent) buckets['11-20h'].agentCount++;
        } else if (hours <= 30) {
          buckets['21-30h'].totalHours += hours;
          if (isAgent) buckets['21-30h'].agentCount++;
        } else if (hours <= 40) {
          buckets['31-40h'].totalHours += hours;
          if (isAgent) buckets['31-40h'].agentCount++;
        } else if (hours <= 50) {
          buckets['41-50h'].totalHours += hours;
          if (isAgent) buckets['41-50h'].agentCount++;
        } else if (hours <= 60) {
          buckets['51-60h'].totalHours += hours;
          if (isAgent) buckets['51-60h'].agentCount++;
        } else if (hours <= 70) {
          buckets['61-70h'].totalHours += hours;
          if (isAgent) buckets['61-70h'].agentCount++;
        } else if (hours <= 80) {
          buckets['71-80h'].totalHours += hours;
          if (isAgent) buckets['71-80h'].agentCount++;
        } else if (hours <= 90) {
          buckets['81-90h'].totalHours += hours;
          if (isAgent) buckets['81-90h'].agentCount++;
        } else if (hours <= 100) {
          buckets['91-100h'].totalHours += hours;
          if (isAgent) buckets['91-100h'].agentCount++;
        } else {
          buckets['100+h'].totalHours += hours;
          if (isAgent) buckets['100+h'].agentCount++;
        }
      });

      el.hourBarChart.innerHTML = '';
      const maxValue = Math.max(...Object.values(buckets).map(b => b.totalHours));
      const bucketLabels = Object.keys(buckets);

      bucketLabels.forEach(label => {
        const data = buckets[label];
        const barHeight = maxValue > 0 ? (data.totalHours / maxValue * 100) : 0;
        const bar = document.createElement('div');
        bar.className = 'hour-bar';
        bar.style.height = `${barHeight}%`;
        bar.title = `${label}: ${data.totalHours.toFixed(2)} hours | ${data.agentCount} agents`;
        bar.innerHTML = `
          <div class="hour-bar-value">${data.totalHours.toFixed(0)}</div>
          <div class="hour-bar-label">${label}</div>
        `;
        el.hourBarChart.appendChild(bar);
      });
    }

    function createLicenseChart() {
      const ctx = document.getElementById('licenseChart').getContext('2d');
      if (appState.chartInstances.license) appState.chartInstances.license.destroy();
      if (!appState.analysisResults) return;

      const data = {
        labels: ['Named Users', 'Hourly Interacting Users', 'NOLOGIN Users'],
        datasets: [{
          data: [
            appState.analysisResults.namedUsers,
            appState.analysisResults.hiUsers,
            appState.analysisResults.nologinUsers
          ],
          backgroundColor: [
            'rgba(99, 171, 143, 0.8)',
            'rgba(40, 167, 69, 0.8)',
            'rgba(108, 117, 125, 0.8)'
          ],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      };

      appState.chartInstances.license = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { padding: 20, usePointStyle: true }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} users (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    function exportReport() {
      if (!appState.analysisResults) {
        showStatusMessage('Please run analysis first', 'warn');
        return;
      }

      const results = appState.analysisResults;
      let csv = 'Genesys Cloud Hourly Billing Analysis Report\n';
      csv += `Generated: ${new Date().toLocaleString()}\n`;
      csv += `Period: ${el.dateFrom.value} to ${el.dateTo.value}\n`;
      csv += `Hourly Interacting Threshold: ${results.threshold} hours\n`;
      csv += `Named Licence Cost: $¬£{results.namedLicenseCost} per month\n`;
      csv += `Hourly Interacting Rate: $¬£{results.hourlyLicenseRate} per hour\n\n`;

      csv += 'SUMMARY\n';
      csv += 'Metric,Value\n';
      csv += `Total Users,${results.totalUsers}\n`;
      csv += `Active Users,${results.activeUsers}\n`;
      csv += `Named Users,${results.namedUsers}\n`;
      csv += `Hourly Interacting Users,${results.hiUsers}\n`;
      csv += `NOLOGIN Users,${results.nologinUsers}\n`;
      csv += `Total Hours,${results.totalHours}\n`;
      csv += `All Named Cost,$${results.allNamedCost}\n`;
      csv += `Hybrid Cost,$${results.hybridCost}\n`;
      csv += `Cost Savings,${results.savings}%\n`;
      csv += `Optimal Model,${results.optimalModel}\n\n`;

      csv += 'ROLE-BASED ANALYSIS\n';
      csv += 'Role Type,Metric,Value\n';
      csv += `Agent,Named Users,${results.agentNamed}\n`;
      csv += `Agent,Hourly Interacting Users,${results.agentHI}\n`;
      csv += `Supervisor,Named Users,${results.supervisorNamed}\n`;
      csv += `Admin,Named Users,${results.adminNamed}\n\n`;

      csv += 'USER DETAILS\n';
      csv += 'Name,Email,Team,Role Type,Roles,Last Login,Interacting Time (HH:MM:SS),Interacting Time (hours),Recommended Licence,Reason,Estimated Cost\n';

      results.users.forEach(user => {
        csv += `"${user.name || ''}","${user.email || ''}","${user.team || ''}","${user.userType || ''}","${user.role || ''}","${user.lastLogin || 'Never'}","${user.interactingHoursFormatted}",${user.interactingHoursDecimal},"${user.recommendedLicense || ''}","${user.recommendedReason || ''}",${(user.estimatedCost || 0).toFixed(2)}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `genesys_billing_analysis_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      logMessage('SUCCESS', 'Report exported', 'CSV file downloaded');
      showStatusMessage('‚úÖ Report exported to CSV', 'success');
    }

    function resetApplication() {
      if (confirm('Reset the application? This will clear all data but keep the connection.')) {
        appState.userData = [];
        appState.analysisResults = null;
        el.statTotalUsers.textContent = '0';
        el.statActiveUsers.textContent = '0';
        el.statNamedUsers.textContent = '0';
        el.statHiUsers.textContent = '0';
        el.statAgents.textContent = '0';
        el.statSupervisors.textContent = '0';
        el.statAdmins.textContent = '0';
        el.statOthers.textContent = '0';
        el.statAgentNamed.textContent = '0';
        el.statAgentHI.textContent = '0';
        el.statSupervisorNamed.textContent = '0';
        el.statAdminNamed.textContent = '0';
        el.totalCost.textContent = '$0';
        el.savings.textContent = '0% savings';
        el.costDetails.innerHTML = '';
        el.licenseModel.textContent = 'Hybrid';
        el.totalCount.textContent = '0';
        el.visibleCount.textContent = '0';
        el.totalHoursCount.textContent = '0';
        el.totalAgentsCount.textContent = '0';
        el.btnAnalyze.disabled = true;
        el.btnRunAnalysis.disabled = true;
        el.btnExport.disabled = true;

        el.usersTableBody.innerHTML = `
          <tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-light);">
            No data loaded. Connect and fetch data first.
          </td></tr>
        `;

        el.hourBuckets.innerHTML = '';
        el.hourBarChart.innerHTML = '';
        el.hourStats.innerHTML = '';

        if (appState.chartInstances.license) appState.chartInstances.license.destroy();

        logMessage('INFO', 'Application reset', 'All data cleared');
        showStatusMessage('üîÑ Application reset', 'info');
      }
    }

    function initializeApp() {
      const today = new Date();
      const lastMonth = new Date();
      lastMonth.setMonth(today.getMonth() - 1);
      el.dateTo.valueAsDate = today;
      el.dateFrom.valueAsDate = lastMonth;
      const todayStr = today.toISOString().split('T')[0];
      el.dateTo.max = todayStr;
      el.dateFrom.max = todayStr;

      el.btnDisconnect.addEventListener('click', disconnect);
      el.btnFetchData.addEventListener('click', fetchUserData);
      el.btnRunAnalysis.addEventListener('click', runAnalysis);
      el.btnAnalyze.addEventListener('click', runAnalysis);
      el.btnExport.addEventListener('click', exportReport);
      el.btnReset.addEventListener('click', resetApplication);

      document.querySelectorAll('.quick-select-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const days = parseInt(this.dataset.days, 10);
          const toDate = new Date();
          const fromDate = new Date();
          if (days === 0) {
            el.dateTo.valueAsDate = toDate;
            el.dateFrom.valueAsDate = toDate;
          } else {
            fromDate.setDate(toDate.getDate() - days);
            el.dateTo.valueAsDate = toDate;
            el.dateFrom.valueAsDate = fromDate;
          }
          logMessage('INFO', 'Date range updated', `Last ${days === 0 ? 'today' : days + ' days'}`);
        });
      });

      el.userSearch.addEventListener('input', renderUserTable);
      el.userFilter.addEventListener('change', renderUserTable);

      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          appState.currentTab = tabId;
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            if (content.id === `tab-${tabId}`) content.classList.add('active');
          });
          logMessage('INFO', 'Tab switched', tabId);
        });
      });

      el.btnClearLogs.addEventListener('click', () => {
        el.logsTableBody.innerHTML = '';
        appState.logs = [];
        logMessage('INFO', 'Logs cleared');
      });

      el.btnCopyLogs.addEventListener('click', () => {
        const logText = appState.logs.map(log =>
          `${log.timestamp} [${log.level}] ${log.message} ${log.details ? '- ' + log.details : ''}`
        ).join('\n');
        navigator.clipboard.writeText(logText).then(() => showStatusMessage('Logs copied to clipboard', 'success'));
      });

      // Update cost displays when values change
      el.namedLicenseCost.addEventListener('change', () => {
        el.statNamedCost.textContent = `$${el.namedLicenseCost.value}`;
      });
      
      el.hourlyLicenseRate.addEventListener('change', () => {
        el.statHourlyRate.textContent = `$${el.hourlyLicenseRate.value}`;
      });

      logMessage('INFO', 'Hourly Billing Calculator initialised', 'Ready for authentication');
    }

    document.addEventListener('DOMContentLoaded', function() {
      initAuth();
    });
  </script>
</body>
</html>
