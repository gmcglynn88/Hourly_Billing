<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Cloud Hourly Billing Calculator</title>
  <style>
    :root {
      --primary-color: #0066CC;
      --secondary-color: #004C99;
      --accent-color: #00A0E9;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --light-bg: #f8f9fa;
      --card-bg: #ffffff;
      --border-color: #dee2e6;
      --text-color: #212529;
      --text-light: #6c757d;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --radius: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 24px 32px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      border-left: 5px solid var(--primary-color);
    }

    h1 {
      color: var(--primary-color);
      margin-bottom: 8px;
      font-size: 28px;
    }

    .subtitle {
      color: var(--text-light);
      font-size: 16px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 24px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Card Styling */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
    }

    .card h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
      font-size: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--light-bg);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card h2 i {
      font-size: 24px;
    }

    /* Form Controls */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    .date-range {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Button Styling */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--secondary-color);
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(0, 102, 204, 0.2);
    }

    .btn-secondary {
      background: var(--light-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: #e9ecef;
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-block {
      width: 100%;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Auth Section */
    .auth-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 32px;
      border-radius: var(--radius);
      margin-bottom: 24px;
    }

    .auth-section h3 {
      margin-bottom: 16px;
      font-size: 20px;
    }

    .auth-section p {
      margin-bottom: 24px;
      opacity: 0.9;
    }

    /* Results Section */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .stat-card {
      background: var(--light-bg);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary-color);
      margin: 10px 0;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-change {
      font-size: 14px;
      margin-top: 8px;
    }

    .stat-change.positive {
      color: var(--success-color);
    }

    .stat-change.negative {
      color: var(--danger-color);
    }

    /* License Summary */
    .license-summary {
      background: linear-gradient(135deg, #e8f4fc 0%, #d4e7fa 100%);
      border-left: 4px solid var(--primary-color);
    }

    .license-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .license-item:last-child {
      border-bottom: none;
    }

    .license-name {
      font-weight: 600;
    }

    .license-count {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
    }

    /* Data Table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .data-table th {
      background: var(--light-bg);
      padding: 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text-color);
      border-bottom: 2px solid var(--border-color);
      position: sticky;
      top: 0;
    }

    .data-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .data-table tr:hover {
      background: rgba(0, 102, 204, 0.05);
    }

    .data-table .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-hi {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success-color);
    }

    .status-named {
      background: rgba(0, 102, 204, 0.1);
      color: var(--primary-color);
    }

    .status-supervisor {
      background: rgba(255, 193, 7, 0.1);
      color: #d39e00;
    }

    /* Charts */
    .chart-container {
      height: 300px;
      margin-top: 20px;
      position: relative;
    }

    /* Loading States */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 102, 204, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--light-bg);
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 24px;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab:hover {
      color: var(--primary-color);
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Alerts */
    .alert {
      padding: 16px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-info {
      background: rgba(0, 102, 204, 0.1);
      border-left: 4px solid var(--primary-color);
      color: var(--primary-color);
    }

    .alert-success {
      background: rgba(40, 167, 69, 0.1);
      border-left: 4px solid var(--success-color);
      color: var(--success-color);
    }

    .alert-warning {
      background: rgba(255, 193, 7, 0.1);
      border-left: 4px solid var(--warning-color);
      color: #856404;
    }

    .alert-danger {
      background: rgba(220, 53, 69, 0.1);
      border-left: 4px solid var(--danger-color);
      color: var(--danger-color);
    }

    /* Tooltips */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background: var(--text-color);
      color: white;
      text-align: center;
      padding: 8px;
      border-radius: 4px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      font-weight: normal;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .card {
        padding: 16px;
      }

      header {
        padding: 16px;
      }

      h1 {
        font-size: 24px;
      }

      .btn {
        padding: 10px 16px;
        font-size: 14px;
      }

      .stat-value {
        font-size: 28px;
      }
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--light-bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-light);
    }

    /* Badge */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 4px;
      margin-left: 8px;
    }

    .badge-primary {
      background: var(--primary-color);
      color: white;
    }

    .badge-success {
      background: var(--success-color);
      color: white;
    }

    .badge-warning {
      background: var(--warning-color);
      color: black;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä Genesys Cloud Hourly Billing Calculator</h1>
      <p class="subtitle">Calculate optimal license distribution and hourly billing based on user interaction data</p>
    </header>

    <div class="main-grid">
      <!-- Left Column: Controls -->
      <div class="left-column">
        <!-- Auth Section -->
        <div class="auth-section card">
          <h3>üîê Authentication</h3>
          <p>Enter your Genesys Cloud API credentials to fetch data</p>
          <div class="form-group">
            <label for="clientId">Client ID</label>
            <input type="text" id="clientId" placeholder="Enter Client ID">
          </div>
          <div class="form-group">
            <label for="clientSecret">Client Secret</label>
            <input type="password" id="clientSecret" placeholder="Enter Client Secret">
          </div>
          <div class="form-group">
            <label for="region">Region</label>
            <select id="region">
              <option value="mypurecloud.ie">Europe (Dublin) - mypurecloud.ie</option>
              <option value="mypurecloud.com">US East (Virginia) - mypurecloud.com</option>
              <option value="usw2.pure.cloud">US West (Oregon) - usw2.pure.cloud</option>
              <option value="cac1.pure.cloud">Canada - cac1.pure.cloud</option>
              <option value="apne2.pure.cloud">Asia Pacific (Tokyo) - apne2.pure.cloud</option>
              <option value="euw2.pure.cloud">Europe West (London) - euw2.pure.cloud</option>
            </select>
          </div>
          <button id="btnAuth" class="btn btn-primary btn-block">
            <span>Authenticate</span>
          </button>
        </div>

        <!-- Date Range Selector -->
        <div class="card">
          <h2>üìÖ Date Range</h2>
          <div class="form-group">
            <label for="dateFrom">From Date</label>
            <input type="date" id="dateFrom">
          </div>
          <div class="form-group">
            <label for="dateTo">To Date</label>
            <input type="date" id="dateTo">
          </div>
          <div class="form-group">
            <label>Quick Select</label>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <button class="btn btn-secondary" data-days="30">Last 30 days</button>
              <button class="btn btn-secondary" data-days="7">Last 7 days</button>
              <button class="btn btn-secondary" data-days="1">Yesterday</button>
            </div>
          </div>
        </div>

        <!-- Analysis Parameters -->
        <div class="card">
          <h2>‚öôÔ∏è Analysis Parameters</h2>
          <div class="form-group">
            <label for="thresholdHours" class="tooltip">
              HI Efficiency Threshold (hours/month)
              <span class="tooltip-text">Users with interacting time below this threshold are recommended for HI licenses</span>
            </label>
            <input type="number" id="thresholdHours" value="40" min="1" max="200">
          </div>
          <div class="form-group">
            <label for="includeNologin" class="tooltip">
              Include NOLOGIN users in analysis?
              <span class="tooltip-text">Include users who haven't logged in during the period</span>
            </label>
            <select id="includeNologin">
              <option value="true">Yes - include in totals</option>
              <option value="false">No - exclude from analysis</option>
            </select>
          </div>
          <div class="alert alert-info">
            <i>üí°</i>
            <div>
              <strong>Assumptions:</strong>
              <div style="font-size: 12px; margin-top: 4px;">
                ‚Ä¢ Users with Interacting time > 0 but < threshold = HI<br>
                ‚Ä¢ Users with Interacting time ‚â• threshold = Named<br>
                ‚Ä¢ Admins/Supervisors = Named (regardless of hours)
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="card">
          <button id="btnFetchData" class="btn btn-primary btn-block" disabled>
            <span>üì• Fetch Interaction Data</span>
          </button>
          <div style="height: 12px;"></div>
          <button id="btnCalculate" class="btn btn-success btn-block" disabled>
            <span>üßÆ Calculate Licensing</span>
          </button>
          <div style="height: 12px;"></div>
          <button id="btnExport" class="btn btn-secondary btn-block" disabled>
            <span>üìä Export Results</span>
          </button>
        </div>
      </div>

      <!-- Right Column: Results -->
      <div class="right-column">
        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" data-tab="summary">üìà Summary</button>
          <button class="tab" data-tab="details">üë• User Details</button>
          <button class="tab" data-tab="charts">üìä Charts</button>
          <button class="tab" data-tab="api">üîß API Logs</button>
        </div>

        <!-- Summary Tab -->
        <div id="tab-summary" class="tab-content active">
          <!-- License Recommendation -->
          <div class="card license-summary">
            <h2>üéØ License Recommendation</h2>
            <div class="license-item">
              <div class="license-name">Total Unique Users</div>
              <div class="license-count" id="totalUsers">0</div>
            </div>
            <div class="license-item">
              <div class="license-name">
                Named Users
                <span class="badge badge-primary">Recommended</span>
              </div>
              <div class="license-count" id="namedUsers">0</div>
            </div>
            <div class="license-item">
              <div class="license-name">
                Hourly Interacting (HI)
                <span class="badge badge-success">Flexible</span>
              </div>
              <div class="license-count" id="hiUsers">0</div>
            </div>
            <div class="license-item">
              <div class="license-name">Total HI Hours/Month</div>
              <div class="license-count" id="totalHours">0</div>
            </div>
            <div class="license-item" style="border-top: 2px solid var(--border-color); padding-top: 20px;">
              <div class="license-name" style="font-size: 18px;">Optimal License Model</div>
              <div class="license-count" style="font-size: 24px;" id="optimalModel">Hybrid</div>
            </div>
          </div>

          <!-- Key Statistics -->
          <div class="card">
            <h2>üìä Key Statistics</h2>
            <div class="results-grid">
              <div class="stat-card">
                <div class="stat-label">Active Users</div>
                <div class="stat-value" id="activeUsers">0</div>
                <div class="stat-change positive" id="activeChange">0% of total</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Avg Hours/User</div>
                <div class="stat-value" id="avgHours">0</div>
                <div class="stat-change" id="avgHoursText">per active user</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">HI Efficiency</div>
                <div class="stat-value" id="hiEfficiency">0%</div>
                <div class="stat-change positive">of users below threshold</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Cost Savings</div>
                <div class="stat-value" id="costSavings">0%</div>
                <div class="stat-change positive">vs all Named</div>
              </div>
            </div>
          </div>

          <!-- Hour Distribution -->
          <div class="card">
            <h2>‚è±Ô∏è Hour Distribution</h2>
            <div class="chart-container">
              <canvas id="hoursChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Details Tab -->
        <div id="tab-details" class="tab-content">
          <div class="card">
            <h2>üë§ User Analysis</h2>
            <div style="margin-bottom: 20px;">
              <input type="text" id="userSearch" placeholder="üîç Search users..." style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 6px;">
            </div>
            <div class="table-container" style="max-height: 600px; overflow-y: auto;">
              <table class="data-table" id="usersTable">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Interacting Hours</th>
                    <th>Recommended License</th>
                    <th>Status</th>
                    <th>Cost/Month</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <!-- Filled by JavaScript -->
                </tbody>
              </table>
            </div>
            <div style="margin-top: 20px; text-align: center; color: var(--text-light);">
              Showing <span id="visibleUsers">0</span> of <span id="totalUsersTable">0</span> users
            </div>
          </div>
        </div>

        <!-- Charts Tab -->
        <div id="tab-charts" class="tab-content">
          <div class="card">
            <h2>üìà License Distribution</h2>
            <div class="chart-container">
              <canvas id="licenseChart"></canvas>
            </div>
          </div>
          <div class="results-grid">
            <div class="card">
              <h2>‚è∞ Hours Breakdown</h2>
              <div class="chart-container">
                <canvas id="hoursBreakdownChart"></canvas>
              </div>
            </div>
            <div class="card">
              <h2>üí∞ Cost Comparison</h2>
              <div class="chart-container">
                <canvas id="costChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- API Logs Tab -->
        <div id="tab-api" class="tab-content">
          <div class="card">
            <h2>üîß API Request Logs</h2>
            <div style="margin-bottom: 20px;">
              <button id="btnClearLogs" class="btn btn-secondary">Clear Logs</button>
            </div>
            <div class="table-container" style="max-height: 600px; overflow-y: auto;">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Endpoint</th>
                    <th>Status</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody id="apiLogs">
                  <!-- Filled by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText">Fetching data from Genesys Cloud...</div>
    <div id="loadingProgress" style="margin-top: 10px; font-size: 14px; color: var(--text-light);"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Global variables
    let authToken = null;
    let apiBaseUrl = 'https://api.mypurecloud.ie';
    let userData = [];
    let analysisResults = null;
    let charts = {};

    // DOM Elements
    const elements = {
      // Authentication
      clientId: document.getElementById('clientId'),
      clientSecret: document.getElementById('clientSecret'),
      region: document.getElementById('region'),
      btnAuth: document.getElementById('btnAuth'),
      
      // Date Range
      dateFrom: document.getElementById('dateFrom'),
      dateTo: document.getElementById('dateTo'),
      
      // Parameters
      thresholdHours: document.getElementById('thresholdHours'),
      includeNologin: document.getElementById('includeNologin'),
      
      // Action Buttons
      btnFetchData: document.getElementById('btnFetchData'),
      btnCalculate: document.getElementById('btnCalculate'),
      btnExport: document.getElementById('btnExport'),
      
      // Results Display
      totalUsers: document.getElementById('totalUsers'),
      namedUsers: document.getElementById('namedUsers'),
      hiUsers: document.getElementById('hiUsers'),
      totalHours: document.getElementById('totalHours'),
      optimalModel: document.getElementById('optimalModel'),
      activeUsers: document.getElementById('activeUsers'),
      avgHours: document.getElementById('avgHours'),
      hiEfficiency: document.getElementById('hiEfficiency'),
      costSavings: document.getElementById('costSavings'),
      
      // Tables
      usersTableBody: document.getElementById('usersTableBody'),
      userSearch: document.getElementById('userSearch'),
      visibleUsers: document.getElementById('visibleUsers'),
      totalUsersTable: document.getElementById('totalUsersTable'),
      apiLogs: document.getElementById('apiLogs'),
      btnClearLogs: document.getElementById('btnClearLogs'),
      
      // Loading
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingText: document.getElementById('loadingText'),
      loadingProgress: document.getElementById('loadingProgress'),
      
      // Tabs
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content')
    };

    // Initialize date range (default: last 30 days)
    function initializeDates() {
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      elements.dateTo.valueAsDate = today;
      elements.dateFrom.valueAsDate = thirtyDaysAgo;
      
      // Set max date to today
      const todayStr = today.toISOString().split('T')[0];
      elements.dateTo.max = todayStr;
      elements.dateFrom.max = todayStr;
    }

    // Toggle loading overlay
    function setLoading(isLoading, text = '') {
      if (isLoading) {
        elements.loadingText.textContent = text || 'Processing...';
        elements.loadingOverlay.classList.add('active');
      } else {
        elements.loadingOverlay.classList.remove('active');
      }
    }

    // Update loading progress
    function updateProgress(text) {
      elements.loadingProgress.textContent = text;
    }

    // Add API log entry
    function addApiLog(endpoint, status, details) {
      const now = new Date();
      const time = now.toLocaleTimeString();
      const row = document.createElement('tr');
      
      let statusBadge = 'üü¢';
      if (status === 'error') statusBadge = 'üî¥';
      else if (status === 'warning') statusBadge = 'üü°';
      else if (status === 'processing') statusBadge = 'üîÑ';
      
      row.innerHTML = `
        <td>${time}</td>
        <td><code>${endpoint}</code></td>
        <td>${statusBadge}</td>
        <td>${details}</td>
      `;
      
      elements.apiLogs.prepend(row);
    }

    // Authenticate with Genesys Cloud
    async function authenticate() {
      const clientId = elements.clientId.value.trim();
      const clientSecret = elements.clientSecret.value.trim();
      const region = elements.region.value;
      
      if (!clientId || !clientSecret) {
        alert('Please enter both Client ID and Client Secret');
        return;
      }
      
      setLoading(true, 'Authenticating with Genesys Cloud...');
      addApiLog('POST /oauth/token', 'processing', 'Starting authentication');
      
      try {
        const authUrl = `https://login.${region}/oauth/token`;
        const credentials = btoa(`${clientId}:${clientSecret}`);
        
        const response = await fetch(authUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Basic ${credentials}`,
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: 'grant_type=client_credentials'
        });
        
        if (!response.ok) {
          throw new Error(`Authentication failed: ${response.status}`);
        }
        
        const data = await response.json();
        authToken = data.access_token;
        apiBaseUrl = `https://api.${region}`;
        
        addApiLog('POST /oauth/token', 'success', 'Authentication successful');
        alert('‚úÖ Authentication successful!');
        
        // Enable fetch button
        elements.btnFetchData.disabled = false;
        elements.btnAuth.innerHTML = '‚úÖ Authenticated';
        elements.btnAuth.classList.add('btn-success');
        elements.btnAuth.classList.remove('btn-primary');
        
      } catch (error) {
        addApiLog('POST /oauth/token', 'error', error.message);
        alert(`‚ùå Authentication failed: ${error.message}`);
      } finally {
        setLoading(false);
      }
    }

    // Fetch user interaction data
    async function fetchInteractionData() {
      if (!authToken) {
        alert('Please authenticate first');
        return;
      }
      
      const dateFrom = elements.dateFrom.value;
      const dateTo = elements.dateTo.value;
      
      if (!dateFrom || !dateTo) {
        alert('Please select a date range');
        return;
      }
      
      setLoading(true, 'Fetching user interaction data...');
      updateProgress('Step 1/3: Creating analytics job...');
      
      try {
        // Create analytics job
        const jobUrl = `${apiBaseUrl}/api/v2/analytics/users/details/jobs`;
        const interval = `${dateFrom}T00:00:00.000Z/${dateTo}T23:59:59.999Z`;
        
        const jobBody = {
          presenceFilters: [{
            type: "and",
            clauses: [{
              type: "or",
              predicates: [{
                dimension: "systemPresence",
                operator: "matches",
                value: "e08eaf1b-ee47-4fa9-a231-1200e284798f"
              }]
            }]
          }],
          routingStatusFilters: [{
            type: "and",
            predicates: [{
              dimension: "routingStatus",
              value: "INTERACTING"
            }]
          }],
          interval: interval
        };
        
        addApiLog('POST /analytics/users/details/jobs', 'processing', 'Creating analytics job');
        
        const jobResponse = await fetch(jobUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(jobBody)
        });
        
        if (!jobResponse.ok) {
          throw new Error(`Failed to create job: ${jobResponse.status}`);
        }
        
        const jobData = await jobResponse.json();
        const jobId = jobData.id;
        
        addApiLog('POST /analytics/users/details/jobs', 'success', `Job created: ${jobId}`);
        updateProgress('Step 2/3: Waiting for job completion...');
        
        // Poll for job completion
        let jobStatus = 'PENDING';
        let attempts = 0;
        const maxAttempts = 60;
        
        while (jobStatus !== 'COMPLETED' && attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          const statusResponse = await fetch(`${apiBaseUrl}/api/v2/analytics/users/details/jobs/${jobId}`, {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });
          
          const statusData = await statusResponse.json();
          jobStatus = statusData.state;
          
          attempts++;
          updateProgress(`Step 2/3: Job status: ${jobStatus} (${attempts}/${maxAttempts})`);
          
          if (jobStatus === 'FAILED') {
            throw new Error('Analytics job failed');
          }
        }
        
        if (jobStatus !== 'COMPLETED') {
          throw new Error('Job timeout');
        }
        
        addApiLog('GET /analytics/users/details/jobs/{id}', 'success', 'Job completed');
        updateProgress('Step 3/3: Fetching results...');
        
        // Fetch results with pagination
        let allResults = [];
        let cursor = null;
        
        do {
          let resultsUrl = `${apiBaseUrl}/api/v2/analytics/users/details/jobs/${jobId}/results`;
          if (cursor) {
            resultsUrl += `?cursor=${cursor}`;
          }
          
          const resultsResponse = await fetch(resultsUrl, {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });
          
          if (!resultsResponse.ok) {
            throw new Error(`Failed to fetch results: ${resultsResponse.status}`);
          }
          
          const resultsData = await resultsResponse.json();
          allResults = allResults.concat(resultsData.results || []);
          cursor = resultsData.cursor;
          
          updateProgress(`Step 3/3: Fetched ${allResults.length} records...`);
          
          // Add delay to avoid rate limiting
          await new Promise(resolve => setTimeout(resolve, 100));
          
        } while (cursor);
        
        addApiLog('GET /analytics/users/details/jobs/{id}/results', 'success', `Fetched ${allResults.length} records`);
        
        // Process the raw data
        userData = processUserData(allResults);
        
        alert(`‚úÖ Successfully fetched data for ${userData.length} users`);
        elements.btnCalculate.disabled = false;
        elements.btnExport.disabled = false;
        
        // Show summary of fetched data
        const activeUsers = userData.filter(u => u.interactingHours > 0).length;
        const totalHours = userData.reduce((sum, u) => sum + u.interactingHours, 0);
        addApiLog('Data Processing', 'success', `Processed ${userData.length} users, ${activeUsers} active, ${totalHours.toFixed(1)} total hours`);
        
      } catch (error) {
        addApiLog('Data Fetch', 'error', error.message);
        alert(`‚ùå Error fetching data: ${error.message}`);
      } finally {
        setLoading(false);
      }
    }

    // Process raw API data into user objects
    function processUserData(rawResults) {
      const userMap = new Map();
      
      rawResults.forEach(record => {
        const userId = record.userId;
        const userName = record.userName || 'Unknown';
        const duration = record.totalDuration || 0;
        const hours = duration / 3600000; // Convert ms to hours
        
        if (!userMap.has(userId)) {
          userMap.set(userId, {
            id: userId,
            name: userName,
            interactingHours: 0,
            isSupervisor: userName.toLowerCase().includes('admin') || 
                         userName.toLowerCase().includes('supervisor') ||
                         userName.toLowerCase().includes('manager')
          });
        }
        
        const user = userMap.get(userId);
        user.interactingHours += hours;
      });
      
      return Array.from(userMap.values());
    }

    // Calculate licensing recommendations
    function calculateLicensing() {
      if (userData.length === 0) {
        alert('Please fetch data first');
        return;
      }
      
      const threshold = parseFloat(elements.thresholdHours.value);
      const includeNologin = elements.includeNologin.value === 'true';
      
      // Filter users if needed
      let usersToAnalyze = userData;
      if (!includeNologin) {
        usersToAnalyze = userData.filter(u => u.interactingHours > 0);
      }
      
      // Analyze each user
      usersToAnalyze.forEach(user => {
        if (user.isSupervisor) {
          user.recommendedLicense = 'Named';
          user.recommendedReason = 'Admin/Supervisor role';
        } else if (user.interactingHours === 0) {
          user.recommendedLicense = 'NOLOGIN';
          user.recommendedReason = 'No login activity';
        } else if (user.interactingHours < threshold) {
          user.recommendedLicense = 'HI';
          user.recommendedReason = `Under ${threshold} hours`;
        } else {
          user.recommendedLicense = 'Named';
          user.recommendedReason = `Over ${threshold} hours`;
        }
        
        // Calculate estimated cost (simplified)
        if (user.recommendedLicense === 'HI') {
          user.estimatedCost = user.interactingHours * 0.5; // Example: $0.5 per hour
        } else if (user.recommendedLicense === 'Named') {
          user.estimatedCost = 75; // Example: $75 per month per named user
        } else {
          user.estimatedCost = 0;
        }
      });
      
      // Calculate summary statistics
      const totalUsers = usersToAnalyze.length;
      const namedUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'Named').length;
      const hiUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'HI').length;
      const nologinUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'NOLOGIN').length;
      const activeUsers = usersToAnalyze.filter(u => u.interactingHours > 0).length;
      const totalHours = usersToAnalyze.reduce((sum, u) => sum + u.interactingHours, 0);
      const avgHours = activeUsers > 0 ? totalHours / activeUsers : 0;
      
      // Calculate cost comparisons
      const currentCost = totalUsers * 75; // Assuming all Named
      const recommendedCost = (namedUsers * 75) + (totalHours * 0.5);
      const costSavings = ((currentCost - recommendedCost) / currentCost * 100).toFixed(1);
      
      // Determine optimal model
      let optimalModel = 'Hybrid';
      if (hiUsers === 0 && namedUsers > 0) optimalModel = 'All Named';
      else if (namedUsers === 0 && hiUsers > 0) optimalModel = 'All HI';
      else if (hiUsers / totalUsers > 0.7) optimalModel = 'Mostly HI';
      else if (namedUsers / totalUsers > 0.7) optimalModel = 'Mostly Named';
      
      // Store results
      analysisResults = {
        totalUsers,
        namedUsers,
        hiUsers,
        nologinUsers,
        activeUsers,
        totalHours: totalHours.toFixed(2),
        avgHours: avgHours.toFixed(1),
        threshold,
        currentCost: currentCost.toFixed(0),
        recommendedCost: recommendedCost.toFixed(0),
        costSavings,
        optimalModel,
        users: usersToAnalyze
      };
      
      // Update UI
      updateResultsUI();
      renderUserTable();
      createCharts();
      
      addApiLog('Analysis', 'success', `Calculated licensing for ${totalUsers} users`);
      alert('‚úÖ Licensing calculation complete!');
    }

    // Update results in UI
    function updateResultsUI() {
      if (!analysisResults) return;
      
      const r = analysisResults;
      
      elements.totalUsers.textContent = r.totalUsers;
      elements.namedUsers.textContent = r.namedUsers;
      elements.hiUsers.textContent = r.hiUsers;
      elements.totalHours.textContent = r.totalHours;
      elements.optimalModel.textContent = r.optimalModel;
      elements.activeUsers.textContent = r.activeUsers;
      elements.avgHours.textContent = r.avgHours;
      
      // Calculate HI efficiency
      const hiEfficiency = r.activeUsers > 0 ? (r.hiUsers / r.activeUsers * 100).toFixed(1) : 0;
      elements.hiEfficiency.textContent = `${hiEfficiency}%`;
      
      elements.costSavings.textContent = `${r.costSavings}%`;
      
      // Update change indicators
      const activePercent = ((r.activeUsers / r.totalUsers) * 100).toFixed(1);
      document.getElementById('activeChange').textContent = `${activePercent}% of total`;
      document.getElementById('avgHoursText').textContent = `per active user`;
    }

    // Render user table
    function renderUserTable(filter = '') {
      if (!analysisResults) return;
      
      const tbody = elements.usersTableBody;
      tbody.innerHTML = '';
      
      let filteredUsers = analysisResults.users;
      if (filter) {
        const searchTerm = filter.toLowerCase();
        filteredUsers = analysisResults.users.filter(user => 
          user.name.toLowerCase().includes(searchTerm) ||
          user.recommendedLicense.toLowerCase().includes(searchTerm)
        );
      }
      
      filteredUsers.sort((a, b) => b.interactingHours - a.interactingHours);
      
      filteredUsers.forEach(user => {
        const row = document.createElement('tr');
        
        let statusClass = 'status-named';
        if (user.recommendedLicense === 'HI') statusClass = 'status-hi';
        if (user.recommendedLicense === 'NOLOGIN') statusClass = 'status-supervisor';
        
        row.innerHTML = `
          <td>
            <div style="font-weight: 600;">${user.name}</div>
            <div style="font-size: 12px; color: var(--text-light);">${user.id}</div>
          </td>
          <td style="font-weight: 600; text-align: center;">${user.interactingHours.toFixed(1)}</td>
          <td>
            <span class="status-badge ${statusClass}">${user.recommendedLicense}</span>
            <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">${user.recommendedReason}</div>
          </td>
          <td>${user.isSupervisor ? 'Admin/Supervisor' : 'Regular User'}</td>
          <td style="text-align: right;">$${user.estimatedCost.toFixed(2)}</td>
        `;
        
        tbody.appendChild(row);
      });
      
      elements.visibleUsers.textContent = filteredUsers.length;
      elements.totalUsersTable.textContent = analysisResults.users.length;
    }

    // Create charts
    function createCharts() {
      if (!analysisResults) return;
      
      const r = analysisResults;
      
      // Destroy existing charts
      Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
      });
      
      // License Distribution Chart
      const licenseCtx = document.getElementById('licenseChart').getContext('2d');
      charts.license = new Chart(licenseCtx, {
        type: 'doughnut',
        data: {
          labels: ['Named Users', 'HI Users', 'No Login'],
          datasets: [{
            data: [r.namedUsers, r.hiUsers, r.nologinUsers],
            backgroundColor: [
              'rgba(0, 102, 204, 0.8)',
              'rgba(40, 167, 69, 0.8)',
              'rgba(108, 117, 125, 0.8)'
            ],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = r.totalUsers;
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      
      // Hours Distribution Chart
      const hoursCtx = document.getElementById('hoursChart').getContext('2d');
      
      // Categorize users by hour buckets
      const hourBuckets = {
        'Under 10 hrs': 0,
        '10-20 hrs': 0,
        '20-30 hrs': 0,
        '30-40 hrs': 0,
        '40-50 hrs': 0,
        '50-60 hrs': 0,
        '60-70 hrs': 0,
        '70-80 hrs': 0,
        '80-90 hrs': 0,
        '90-100 hrs': 0,
        'Above 100 hrs': 0
      };
      
      analysisResults.users.forEach(user => {
        const hours = user.interactingHours;
        if (hours < 10) hourBuckets['Under 10 hrs']++;
        else if (hours < 20) hourBuckets['10-20 hrs']++;
        else if (hours < 30) hourBuckets['20-30 hrs']++;
        else if (hours < 40) hourBuckets['30-40 hrs']++;
        else if (hours < 50) hourBuckets['40-50 hrs']++;
        else if (hours < 60) hourBuckets['50-60 hrs']++;
        else if (hours < 70) hourBuckets['60-70 hrs']++;
        else if (hours < 80) hourBuckets['70-80 hrs']++;
        else if (hours < 90) hourBuckets['80-90 hrs']++;
        else if (hours < 100) hourBuckets['90-100 hrs']++;
        else hourBuckets['Above 100 hrs']++;
      });
      
      charts.hours = new Chart(hoursCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(hourBuckets),
          datasets: [{
            label: 'Number of Users',
            data: Object.values(hourBuckets),
            backgroundColor: 'rgba(0, 102, 204, 0.7)',
            borderColor: 'rgba(0, 102, 204, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Users'
              }
            },
            x: {
              ticks: {
                maxRotation: 45
              }
            }
          }
        }
      });
      
      // Hours Breakdown Chart
      const breakdownCtx = document.getElementById('hoursBreakdownChart').getContext('2d');
      charts.breakdown = new Chart(breakdownCtx, {
        type: 'pie',
        data: {
          labels: ['Named Users Hours', 'HI Users Hours'],
          datasets: [{
            data: [
              analysisResults.users.filter(u => u.recommendedLicense === 'Named')
                .reduce((sum, u) => sum + u.interactingHours, 0),
              analysisResults.users.filter(u => u.recommendedLicense === 'HI')
                .reduce((sum, u) => sum + u.interactingHours, 0)
            ],
            backgroundColor: [
              'rgba(0, 102, 204, 0.8)',
              'rgba(40, 167, 69, 0.8)'
            ]
          }]
        }
      });
      
      // Cost Comparison Chart
      const costCtx = document.getElementById('costChart').getContext('2d');
      charts.cost = new Chart(costCtx, {
        type: 'bar',
        data: {
          labels: ['All Named Model', 'Hybrid Model', 'Savings'],
          datasets: [{
            label: 'Monthly Cost ($)',
            data: [
              parseFloat(r.currentCost),
              parseFloat(r.recommendedCost),
              parseFloat(r.currentCost) - parseFloat(r.recommendedCost)
            ],
            backgroundColor: [
              'rgba(108, 117, 125, 0.7)',
              'rgba(0, 102, 204, 0.7)',
              'rgba(40, 167, 69, 0.7)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Cost ($)'
              }
            }
          }
        }
      });
    }

    // Export results
    function exportResults() {
      if (!analysisResults) {
        alert('Please calculate licensing first');
        return;
      }
      
      // Create CSV content
      let csv = 'User ID,User Name,Interacting Hours,Recommended License,Reason,Is Supervisor,Estimated Cost\n';
      
      analysisResults.users.forEach(user => {
        csv += `"${user.id}","${user.name.replace(/"/g, '""')}",${user.interactingHours.toFixed(2)},"${user.recommendedLicense}","${user.recommendedReason}",${user.isSupervisor},${user.estimatedCost.toFixed(2)}\n`;
      });
      
      // Add summary section
      csv += '\nSUMMARY\n';
      csv += `Total Users,${analysisResults.totalUsers}\n`;
      csv += `Named Users,${analysisResults.namedUsers}\n`;
      csv += `HI Users,${analysisResults.hiUsers}\n`;
      csv += `No Login Users,${analysisResults.nologinUsers}\n`;
      csv += `Active Users,${analysisResults.activeUsers}\n`;
      csv += `Total Hours,${analysisResults.totalHours}\n`;
      csv += `Average Hours/User,${analysisResults.avgHours}\n`;
      csv += `Threshold Hours,${analysisResults.threshold}\n`;
      csv += `Optimal Model,${analysisResults.optimalModel}\n`;
      csv += `Current Cost (All Named),$${analysisResults.currentCost}\n`;
      csv += `Recommended Cost,$${analysisResults.recommendedCost}\n`;
      csv += `Cost Savings,${analysisResults.costSavings}%\n`;
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      
      a.href = url;
      a.download = `genesys_billing_analysis_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      addApiLog('Export', 'success', 'Exported results to CSV');
    }

    // Initialize the application
    function initializeApp() {
      // Set up event listeners
      elements.btnAuth.addEventListener('click', authenticate);
      elements.btnFetchData.addEventListener('click', fetchInteractionData);
      elements.btnCalculate.addEventListener('click', calculateLicensing);
      elements.btnExport.addEventListener('click', exportResults);
      elements.btnClearLogs.addEventListener('click', () => {
        elements.apiLogs.innerHTML = '';
      });
      
      // Date quick select buttons
      document.querySelectorAll('[data-days]').forEach(button => {
        button.addEventListener('click', function() {
          const days = parseInt(this.dataset.days);
          const toDate = new Date();
          const fromDate = new Date();
          fromDate.setDate(toDate.getDate() - days);
          
          elements.dateTo.valueAsDate = toDate;
          elements.dateFrom.valueAsDate = fromDate;
        });
      });
      
      // User search
      elements.userSearch.addEventListener('input', function() {
        renderUserTable(this.value);
      });
      
      // Tab switching
      elements.tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          
          // Update active tab
          elements.tabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Show active content
          elements.tabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === `tab-${tabId}`) {
              content.classList.add('active');
            }
          });
        });
      });
      
      // Initialize dates
      initializeDates();
      
      // Add welcome log
      addApiLog('App Initialization', 'success', 'Hourly Billing Calculator ready');
    }

    // Start the app when page loads
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
