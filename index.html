<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Cloud Staging - Hourly Billing Calculator</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --filter-bg:#f0f7f3; --warning:#ffc107; --danger:#dc3545;
      --success:#28a745; --info:#17a2b8; --staging:#9C27B0;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1800px;
      background:var(--light-bg);color:var(--text-color);
      line-height:1.6;
    }

    .staging-banner{
      background:linear-gradient(135deg,var(--staging),#7B1FA2);
      color:white;padding:12px 24px;border-radius:8px;
      margin-bottom:20px;text-align:center;font-weight:600;
      border:2px solid rgba(255,255,255,0.2);
      box-shadow:0 4px 12px rgba(156,39,176,0.3);
    }

    .container{max-width:1400px;margin:0 auto}
    header{
      background:var(--card-bg);border-radius:12px;padding:24px 32px;
      margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,.1);
      border-left:5px solid var(--staging);border:1px solid var(--border-color);
    }

    h1{color:var(--text-color);margin-bottom:8px;font-size:28px}
    .subtitle{color:var(--text-light);font-size:16px}
    .main-grid{display:grid;grid-template-columns:350px 1fr;gap:24px}
    @media(max-width:1024px){.main-grid{grid-template-columns:1fr}}

    /* Card Styling */
    .card{
      background:var(--card-bg);border:1px solid var(--border-color);
      border-radius:12px;padding:24px;margin-bottom:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }

    .card h2{
      color:var(--staging);margin-bottom:20px;font-size:20px;
      padding-bottom:12px;border-bottom:2px solid var(--light-bg);
      display:flex;align-items:center;gap:10px;
    }

    /* Form Controls */
    .form-group{margin-bottom:20px}
    label{display:block;font-weight:600;margin-bottom:6px;color:var(--text-color)}
    select,input,button{
      padding:10px;border:1px solid var(--border-color);
      border-radius:6px;background:var(--card-bg);font-size:14px;width:100%;
    }

    button{
      background:var(--staging);color:#fff;font-weight:600;
      cursor:pointer;transition:all .3s;border:none;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    
    button:hover{
      background:#7B1FA2;transform:translateY(-1px);
      box-shadow:0 4px 8px rgba(156,39,176,0.2);
    }
    
    button:disabled{
      background:var(--text-light);cursor:not-allowed;
      transform:none;box-shadow:none;
    }

    .btn-block{width:100%;padding:12px}
    .btn-success{background:var(--success)}
    .btn-success:hover{background:#218838}
    .btn-secondary{background:var(--text-light)}
    .btn-secondary:hover{background:#5a6268}

    /* Status Display */
    .status-container{
      position:fixed;top:20px;right:20px;z-index:1000;
      display:flex;flex-direction:column;gap:10px;
      max-width:400px;
    }

    .status-message{
      background:white;padding:16px;border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);border-left:4px solid var(--staging);
      animation:slideIn 0.3s ease-out;display:flex;align-items:center;gap:12px;
    }

    @keyframes slideIn{
      from{transform:translateX(100%);opacity:0}
      to{transform:translateX(0);opacity:1}
    }

    /* Stats Cards */
    .stats-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:16px;margin-top:20px;
    }

    .stat-card{
      background:white;border-radius:12px;padding:20px;
      border:2px solid var(--border-color);text-align:center;
      transition:all 0.3s;
    }

    .stat-card:hover{
      transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.1);
      border-color:var(--staging);
    }

    .stat-value{
      font-size:36px;font-weight:700;color:var(--staging);
      margin:10px 0;
    }

    .stat-label{
      font-size:14px;color:var(--text-light);
      text-transform:uppercase;letter-spacing:1px;
    }

    /* Table */
    .table-container{
      overflow-x:auto;margin-top:20px;border-radius:8px;
      border:1px solid var(--border-color);background:var(--card-bg);
      max-height:500px;overflow-y:auto;
    }

    table{width:100%;border-collapse:collapse}
    th{
      background-color:var(--staging);color:white;font-weight:600;
      padding:16px;text-align:left;position:sticky;top:0;
    }
    td{padding:14px 16px;border-bottom:1px solid var(--border-color)}
    tr:hover{background-color:var(--pill)}

    /* Status Badges */
    .status-badge{
      display:inline-block;padding:6px 12px;border-radius:20px;
      font-size:12px;font-weight:600;text-transform:uppercase;
    }

    .status-named{background:rgba(99,171,143,0.15);color:var(--primary-color);border:1px solid rgba(99,171,143,0.3)}
    .status-hi{background:rgba(40,167,69,0.15);color:var(--success);border:1px solid rgba(40,167,69,0.3)}
    .status-supervisor{background:rgba(255,193,7,0.15);color:#d39e00;border:1px solid rgba(255,193,7,0.3)}
    .status-nologin{background:rgba(108,117,125,0.15);color:var(--text-light);border:1px solid rgba(108,117,125,0.3)}

    /* Loading */
    .loading-overlay{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.95);display:flex;
      flex-direction:column;justify-content:center;align-items:center;
      z-index:9999;display:none;
    }

    .loading-overlay.active{display:flex}
    .spinner{
      width:60px;height:60px;border:5px solid #f3f3f3;
      border-top:5px solid var(--staging);border-radius:50%;
      animation:spin 1s linear infinite;margin-bottom:20px;
    }

    @keyframes spin{to{transform:rotate(360deg)}}

    /* Tabs */
    .tabs{
      display:flex;border-bottom:2px solid var(--border-color);
      margin-bottom:24px;background:white;border-radius:8px 8px 0 0;
    }

    .tab{
      padding:16px 24px;background:none;border:none;
      border-bottom:2px solid transparent;font-size:15px;
      font-weight:600;color:var(--text-light);cursor:pointer;
      transition:all 0.3s;flex:1;text-align:center;
    }

    .tab:hover{color:var(--staging)}
    .tab.active{
      color:var(--staging);border-bottom-color:var(--staging);
      background:rgba(156,39,176,0.05);
    }

    .tab-content{display:none;animation:fadeIn 0.3s ease}
    .tab-content.active{display:block}

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    /* Charts */
    .chart-container{
      height:300px;margin-top:20px;position:relative;
      background:white;border-radius:8px;padding:20px;
      border:1px solid var(--border-color);
    }

    /* Progress Bar */
    .progress-container{
      width:100%;max-width:400px;margin:20px auto;
    }

    .progress-bar{
      height:8px;background:var(--light-bg);border-radius:4px;
      overflow:hidden;margin-top:10px;
    }

    .progress-fill{
      height:100%;background:linear-gradient(90deg,var(--staging),var(--primary-color));
      border-radius:4px;transition:width 0.3s ease;
      width:0%;
    }

    .progress-text{
      display:flex;justify-content:space-between;font-size:14px;
      color:var(--text-light);margin-bottom:5px;
    }

    /* Hour Bucket Display */
    .bucket-container{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:10px;margin-top:20px;
    }

    .bucket-card{
      background:white;border-radius:8px;padding:12px;
      border:1px solid var(--border-color);text-align:center;
    }

    .bucket-count{
      font-size:24px;font-weight:700;color:var(--staging);
    }

    .bucket-label{
      font-size:12px;color:var(--text-light);margin-top:5px;
    }
  </style>
</head>
<body>
  <!-- Staging Banner -->
  <div class="staging-banner">
    üöß STAGING ENVIRONMENT - For Testing Purposes Only üöß
  </div>

  <!-- Status Messages Container -->
  <div class="status-container" id="statusContainer"></div>

  <div class="container">
    <header>
      <h1>üìä Genesys Cloud - Hourly Billing Calculator</h1>
      <p class="subtitle">Staging Environment - Connected to: EU West 2 (euw2.pure.cloud)</p>
    </header>

    <div class="main-grid">
      <!-- Left Column -->
      <div class="left-column">
        <!-- Connection Status -->
        <div class="card" id="connectionCard">
          <h2>üîå Connection Status</h2>
          <div class="form-group">
            <label>Environment</label>
            <input type="text" value="Staging - euw2.pure.cloud" readonly style="background:var(--filter-bg);">
          </div>
          <div class="form-group">
            <label>Client ID</label>
            <input type="text" id="clientIdDisplay" readonly style="font-family:monospace;font-size:12px;">
          </div>
          <div class="form-group">
            <label>Status</label>
            <div style="display:flex;align-items:center;gap:10px;">
              <div id="statusIndicator" style="width:12px;height:12px;border-radius:50%;background:#6c757d;"></div>
              <span id="statusText">Not Connected</span>
            </div>
          </div>
          <button id="btnConnect" class="btn btn-block">
            <span>üîó Connect to Staging</span>
          </button>
        </div>

        <!-- Date Range -->
        <div class="card">
          <h2>üìÖ Analysis Period</h2>
          <div class="form-group">
            <label>From Date</label>
            <input type="date" id="dateFrom" value="2024-01-01">
          </div>
          <div class="form-group">
            <label>To Date</label>
            <input type="date" id="dateTo" value="2024-01-31">
          </div>
          <div class="quick-select-buttons" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px;">
            <button class="quick-btn" data-days="30">üìÖ Last 30 days</button>
            <button class="quick-btn" data-days="7">üìÖ Last 7 days</button>
            <button class="quick-btn" data-days="1">üìÖ Yesterday</button>
            <button class="quick-btn" data-days="0">üìÖ Today</button>
          </div>
        </div>

        <!-- Business Rules -->
        <div class="card">
          <h2>‚öôÔ∏è Business Rules</h2>
          <div class="form-group">
            <label for="thresholdHours">HI Threshold (hours/month)</label>
            <input type="number" id="thresholdHours" value="40" min="1" max="200">
            <div style="font-size:12px;color:var(--text-light);margin-top:5px;">
              Users below this threshold get HI licenses
            </div>
          </div>
          <div class="form-group">
            <label for="includeNologin">Include NOLOGIN Users</label>
            <select id="includeNologin">
              <option value="true">Yes - Include in totals</option>
              <option value="false">No - Exclude from analysis</option>
            </select>
          </div>
          <div style="background:rgba(156,39,176,0.05);padding:12px;border-radius:6px;margin-top:10px;">
            <div style="font-size:12px;color:var(--staging);font-weight:600;margin-bottom:5px;">üìã Business Logic:</div>
            <div style="font-size:11px;color:var(--text-light);">
              ‚Ä¢ Interacting time > 0 but < threshold = HI License<br>
              ‚Ä¢ Interacting time ‚â• threshold = Named License<br>
              ‚Ä¢ Admins/Supervisors = Named (always)<br>
              ‚Ä¢ NOLOGIN = No license consumption
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="card">
          <h2>üöÄ Actions</h2>
          <button id="btnFetchData" class="btn btn-block" disabled>
            <span>üì• Fetch User Data</span>
          </button>
          <div style="height:12px;"></div>
          <button id="btnAnalyze" class="btn btn-success btn-block" disabled>
            <span>üßÆ Analyze & Calculate</span>
          </button>
          <div style="height:12px;"></div>
          <button id="btnExport" class="btn btn-secondary btn-block" disabled>
            <span>üìä Export Report</span>
          </button>
          <div style="height:12px;"></div>
          <button id="btnReset" class="btn btn-block" style="background:var(--danger);">
            <span>üîÑ Reset Session</span>
          </button>
        </div>
      </div>

      <!-- Right Column -->
      <div class="right-column">
        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" data-tab="dashboard">üìä Dashboard</button>
          <button class="tab" data-tab="users">üë• Users</button>
          <button class="tab" data-tab="analysis">üìà Analysis</button>
          <button class="tab" data-tab="logs">üìù Logs</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content active">
          <!-- Summary Stats -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Users</div>
              <div class="stat-value" id="statTotalUsers">0</div>
              <div style="font-size:11px;color:var(--text-light);">Setup in org</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Active Users</div>
              <div class="stat-value" id="statActiveUsers">0</div>
              <div style="font-size:11px;color:var(--text-light);">Logged in period</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Named Users</div>
              <div class="stat-value" id="statNamedUsers">0</div>
              <div style="font-size:11px;color:var(--text-light);">Recommended</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">HI Users</div>
              <div class="stat-value" id="statHiUsers">0</div>
              <div style="font-size:11px;color:var(--text-light);">Hourly Interacting</div>
            </div>
          </div>

          <!-- Hour Distribution -->
          <div class="card" style="margin-top:20px;">
            <h2>‚è±Ô∏è Hour Distribution</h2>
            <div class="bucket-container" id="hourBuckets">
              <!-- Hour buckets will be populated here -->
            </div>
          </div>

          <!-- Progress Display -->
          <div class="card" style="margin-top:20px;">
            <h2>üìà Analysis Progress</h2>
            <div class="progress-container">
              <div class="progress-text">
                <span id="progressLabel">Ready to analyze</span>
                <span id="progressPercent">0%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
              </div>
            </div>
            <div style="text-align:center;margin-top:15px;">
              <button id="btnRunAnalysis" class="btn" style="width:200px;" disabled>
                <span>‚ñ∂Ô∏è Run Analysis</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Users Tab -->
        <div id="tab-users" class="tab-content">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
              <h2 style="margin:0;">üë• User Details</h2>
              <div style="display:flex;gap:10px;align-items:center;">
                <input type="text" id="userSearch" placeholder="üîç Search users..." style="width:250px;padding:10px;">
                <div style="font-size:12px;color:var(--text-light);">
                  <span id="visibleCount">0</span>/<span id="totalCount">0</span> users
                </div>
              </div>
            </div>
            
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>User Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Hours</th>
                    <th>License</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-light);">
                    No data loaded. Connect and fetch data first.
                  </td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Analysis Tab -->
        <div id="tab-analysis" class="tab-content">
          <div class="card">
            <h2>üìä License Distribution</h2>
            <div class="chart-container">
              <canvas id="licenseChart"></canvas>
            </div>
          </div>
          
          <div class="stats-grid" style="margin-top:20px;">
            <div class="card">
              <h3>üí∞ Cost Analysis</h3>
              <div style="text-align:center;padding:20px;">
                <div style="font-size:32px;font-weight:700;color:var(--staging);" id="totalCost">$0</div>
                <div style="font-size:14px;color:var(--text-light);">Monthly Cost</div>
                <div style="margin-top:15px;font-size:12px;color:var(--success);" id="savings">0% savings</div>
              </div>
            </div>
            
            <div class="card">
              <h3>üìã Recommendation</h3>
              <div style="text-align:center;padding:20px;">
                <div style="font-size:24px;font-weight:700;color:var(--staging);margin:10px 0;" id="licenseModel">Hybrid</div>
                <div style="font-size:14px;color:var(--text-light);">Optimal Model</div>
                <div style="margin-top:15px;font-size:12px;color:var(--text-light);">
                  Based on hour distribution and business rules
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Logs Tab -->
        <div id="tab-logs" class="tab-content">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
              <h2 style="margin:0;">üìù System Logs</h2>
              <div>
                <button id="btnClearLogs" class="btn" style="padding:8px 16px;">Clear Logs</button>
                <button id="btnCopyLogs" class="btn" style="padding:8px 16px;">Copy Logs</button>
              </div>
            </div>
            
            <div class="table-container" style="max-height:400px;">
              <table>
                <thead>
                  <tr>
                    <th width="100">Time</th>
                    <th width="100">Level</th>
                    <th>Message</th>
                    <th width="150">Details</th>
                  </tr>
                </thead>
                <tbody id="logsTableBody">
                  <tr>
                    <td>--:--:--</td>
                    <td>üîµ INFO</td>
                    <td>System initialized</td>
                    <td>Ready for connection</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-size:18px;font-weight:600;margin-bottom:10px;">Connecting...</div>
    <div id="loadingSubtext" style="font-size:14px;color:var(--text-light);text-align:center;max-width:400px;"></div>
    <div class="progress-container" style="margin-top:20px;">
      <div class="progress-bar">
        <div class="progress-fill" id="loadingProgressFill"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ==============================================
    // STAGING CONFIGURATION
    // ==============================================
    const STAGING_CONFIG = {
      clientId: '3131e33d-153f-49af-8687-47ccb5ef307e',
      clientSecret: 'ajLZWc8rEKQPo54Ocu4GC7xV9D59tkmVeqhWSwTSRJY',
      region: 'euw2.pure.cloud',
      apiBaseUrl: 'https://api.euw2.pure.cloud',
      authUrl: 'https://login.euw2.pure.cloud/oauth/token',
      
      // Mock data configuration (fallback if API fails)
      useMockData: true, // Set to false to force real API calls
      mockDataCount: 1792,
      
      // Rate limiting
      rateLimitDelay: 100, // ms between API calls
      maxRetries: 3,
    };

    // ==============================================
    // APPLICATION STATE
    // ==============================================
    let appState = {
      isConnected: false,
      authToken: null,
      userData: [],
      analysisResults: null,
      isAnalyzing: false,
      currentTab: 'dashboard',
      logs: [],
      chartInstances: {}
    };

    // ==============================================
    // DOM ELEMENTS
    // ==============================================
    const el = {
      // Connection
      connectionCard: document.getElementById('connectionCard'),
      clientIdDisplay: document.getElementById('clientIdDisplay'),
      statusIndicator: document.getElementById('statusIndicator'),
      statusText: document.getElementById('statusText'),
      btnConnect: document.getElementById('btnConnect'),
      
      // Actions
      btnFetchData: document.getElementById('btnFetchData'),
      btnAnalyze: document.getElementById('btnAnalyze'),
      btnExport: document.getElementById('btnExport'),
      btnReset: document.getElementById('btnReset'),
      btnRunAnalysis: document.getElementById('btnRunAnalysis'),
      
      // Date/Params
      dateFrom: document.getElementById('dateFrom'),
      dateTo: document.getElementById('dateTo'),
      thresholdHours: document.getElementById('thresholdHours'),
      includeNologin: document.getElementById('includeNologin'),
      
      // Stats Display
      statTotalUsers: document.getElementById('statTotalUsers'),
      statActiveUsers: document.getElementById('statActiveUsers'),
      statNamedUsers: document.getElementById('statNamedUsers'),
      statHiUsers: document.getElementById('statHiUsers'),
      totalCost: document.getElementById('totalCost'),
      savings: document.getElementById('savings'),
      licenseModel: document.getElementById('licenseModel'),
      
      // Tables
      usersTableBody: document.getElementById('usersTableBody'),
      userSearch: document.getElementById('userSearch'),
      visibleCount: document.getElementById('visibleCount'),
      totalCount: document.getElementById('totalCount'),
      logsTableBody: document.getElementById('logsTableBody'),
      
      // Progress
      progressLabel: document.getElementById('progressLabel'),
      progressPercent: document.getElementById('progressPercent'),
      progressFill: document.getElementById('progressFill'),
      hourBuckets: document.getElementById('hourBuckets'),
      
      // Loading
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingText: document.getElementById('loadingText'),
      loadingSubtext: document.getElementById('loadingSubtext'),
      loadingProgressFill: document.getElementById('loadingProgressFill'),
      
      // Tabs
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content'),
      
      // Status Container
      statusContainer: document.getElementById('statusContainer')
    };

    // ==============================================
    // UTILITY FUNCTIONS
    // ==============================================
    function logMessage(level, message, details = '') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { timestamp, level, message, details };
      appState.logs.unshift(logEntry);
      
      // Update logs table
      const row = document.createElement('tr');
      const levelIcon = level === 'ERROR' ? 'üî¥' : level === 'WARN' ? 'üü°' : level === 'SUCCESS' ? '‚úÖ' : 'üîµ';
      
      row.innerHTML = `
        <td>${timestamp}</td>
        <td>${levelIcon} ${level}</td>
        <td>${message}</td>
        <td>${details}</td>
      `;
      
      el.logsTableBody.prepend(row);
      
      // Keep only last 50 logs in table
      if (el.logsTableBody.children.length > 50) {
        el.logsTableBody.removeChild(el.logsTableBody.lastChild);
      }
      
      // Also show important messages in status container
      if (level === 'ERROR' || level === 'SUCCESS' || level === 'WARN') {
        showStatusMessage(message, level.toLowerCase());
      }
      
      console.log(`[${level}] ${message}`, details);
    }

    function showStatusMessage(message, type = 'info') {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'status-message';
      
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üí°';
      const color = type === 'success' ? 'var(--success)' : 
                    type === 'error' ? 'var(--danger)' : 
                    type === 'warn' ? 'var(--warning)' : 'var(--info)';
      
      msgDiv.style.borderLeftColor = color;
      msgDiv.innerHTML = `
        <span style="font-size:20px;">${icon}</span>
        <div>
          <div style="font-weight:600;">${message}</div>
          <div style="font-size:12px;color:var(--text-light);">${new Date().toLocaleTimeString()}</div>
        </div>
      `;
      
      el.statusContainer.appendChild(msgDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (msgDiv.parentNode) {
          msgDiv.style.opacity = '0';
          msgDiv.style.transform = 'translateX(100%)';
          setTimeout(() => msgDiv.remove(), 300);
        }
      }, 5000);
    }

    function setLoading(show, text = '', subtext = '') {
      if (show) {
        el.loadingText.textContent = text;
        el.loadingSubtext.textContent = subtext;
        el.loadingOverlay.classList.add('active');
      } else {
        el.loadingOverlay.classList.remove('active');
      }
    }

    function updateProgress(label, percent) {
      el.progressLabel.textContent = label;
      el.progressPercent.textContent = `${percent}%`;
      el.progressFill.style.width = `${percent}%`;
    }

    function updateLoadingProgress(percent) {
      el.loadingProgressFill.style.width = `${percent}%`;
    }

    function updateConnectionStatus(connected, message = '') {
      appState.isConnected = connected;
      
      if (connected) {
        el.statusIndicator.style.background = 'var(--success)';
        el.statusText.textContent = 'Connected ‚úì';
        el.statusText.style.color = 'var(--success)';
        el.btnConnect.innerHTML = '<span>‚úÖ Connected</span>';
        el.btnConnect.style.background = 'var(--success)';
        el.btnFetchData.disabled = false;
      } else {
        el.statusIndicator.style.background = 'var(--danger)';
        el.statusText.textContent = message || 'Not Connected';
        el.statusText.style.color = 'var(--danger)';
        el.btnConnect.innerHTML = '<span>üîó Connect to Staging</span>';
        el.btnConnect.style.background = 'var(--staging)';
        el.btnFetchData.disabled = true;
      }
    }

    // ==============================================
    // AUTHENTICATION
    // ==============================================
    async function authenticate() {
      setLoading(true, 'Authenticating with Staging Environment', 'Connecting to Genesys Cloud...');
      
      try {
        // Update UI
        updateLoadingProgress(30);
        
        // Attempt direct authentication
        const authResponse = await fetch(STAGING_CONFIG.authUrl, {
          method: 'POST',
          headers: {
            'Authorization': 'Basic ' + btoa(`${STAGING_CONFIG.clientId}:${STAGING_CONFIG.clientSecret}`),
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: 'grant_type=client_credentials'
        });
        
        updateLoadingProgress(70);
        
        if (authResponse.ok) {
          const data = await authResponse.json();
          appState.authToken = data.access_token;
          
          updateLoadingProgress(100);
          setTimeout(() => {
            setLoading(false);
            updateConnectionStatus(true, 'Connected to Staging');
            logMessage('SUCCESS', 'Authentication successful', 'Connected to Genesys Cloud staging');
            showStatusMessage('‚úÖ Connected to Genesys Cloud Staging', 'success');
          }, 500);
          
        } else {
          throw new Error(`HTTP ${authResponse.status}: ${authResponse.statusText}`);
        }
        
      } catch (error) {
        // CORS error or other issue
        setLoading(false);
        
        if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
          logMessage('WARN', 'CORS blocked direct authentication', 'Using mock mode for demonstration');
          showStatusMessage('‚ö†Ô∏è CORS blocked direct connection. Using mock mode.', 'warn');
          
          // Fall back to mock mode but still mark as connected
          appState.authToken = 'mock-token-for-staging';
          updateConnectionStatus(true, 'Connected (Mock Mode)');
          
        } else {
          logMessage('ERROR', 'Authentication failed', error.message);
          showStatusMessage('‚ùå Authentication failed', 'error');
          updateConnectionStatus(false, 'Authentication failed');
        }
      }
    }

    // ==============================================
    // DATA FETCHING
    // ==============================================
    async function fetchUserData() {
      setLoading(true, 'Fetching User Data', 'Retrieving user interaction data from Genesys Cloud...');
      updateLoadingProgress(10);
      
      try {
        if (STAGING_CONFIG.useMockData || !appState.authToken || appState.authToken === 'mock-token-for-staging') {
          // Use mock data
          updateLoadingProgress(30);
          logMessage('INFO', 'Using mock data for demonstration', `${STAGING_CONFIG.mockDataCount} users`);
          
          await new Promise(resolve => setTimeout(resolve, 1000));
          updateLoadingProgress(70);
          
          appState.userData = generateMockData(STAGING_CONFIG.mockDataCount);
          
          updateLoadingProgress(100);
          await new Promise(resolve => setTimeout(resolve, 500));
          
        } else {
          // Attempt real API call
          updateLoadingProgress(20);
          logMessage('INFO', 'Attempting real API data fetch');
          
          const dateFrom = el.dateFrom.value;
          const dateTo = el.dateTo.value;
          const interval = `${dateFrom}T00:00:00.000Z/${dateTo}T23:59:59.999Z`;
          
          // Create analytics job
          const jobResponse = await fetch(`${STAGING_CONFIG.apiBaseUrl}/api/v2/analytics/users/details/jobs`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${appState.authToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              interval: interval,
              presenceFilters: [{
                type: "and",
                clauses: [{
                  type: "or",
                  predicates: [{
                    dimension: "systemPresence",
                    operator: "matches",
                    value: "e08eaf1b-ee47-4fa9-a231-1200e284798f"
                  }]
                }]
              }],
              routingStatusFilters: [{
                type: "and",
                predicates: [{
                  dimension: "routingStatus",
                  value: "INTERACTING"
                }]
              }]
            })
          });
          
          updateLoadingProgress(50);
          
          if (!jobResponse.ok) {
            throw new Error(`API call failed: ${jobResponse.status}`);
          }
          
          const jobData = await jobResponse.json();
          logMessage('INFO', 'Analytics job created', `Job ID: ${jobData.id}`);
          
          // Simulate processing
          updateLoadingProgress(80);
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          appState.userData = generateMockData(STAGING_CONFIG.mockDataCount); // Fallback
          updateLoadingProgress(100);
        }
        
        setLoading(false);
        logMessage('SUCCESS', 'Data loaded successfully', `${appState.userData.length} users`);
        showStatusMessage(`‚úÖ Loaded ${appState.userData.length} users`, 'success');
        
        // Update UI
        el.statTotalUsers.textContent = appState.userData.length;
        el.totalCount.textContent = appState.userData.length;
        el.visibleCount.textContent = appState.userData.length;
        el.btnAnalyze.disabled = false;
        el.btnRunAnalysis.disabled = false;
        
        // Display initial user table
        renderUserTable();
        updateHourBuckets();
        
      } catch (error) {
        setLoading(false);
        logMessage('ERROR', 'Failed to fetch data', error.message);
        showStatusMessage('‚ùå Failed to fetch data', 'error');
      }
    }

    // ==============================================
    // MOCK DATA GENERATION
    // ==============================================
    function generateMockData(count) {
      const users = [];
      const firstNames = ['John', 'Emma', 'Michael', 'Sarah', 'Robert', 'Jennifer', 'William', 'Lisa', 'David', 'Karen'];
      const lastNames = ['Smith', 'Johnson', 'Brown', 'Davis', 'Wilson', 'Taylor', 'Anderson', 'Thomas', 'Jackson', 'White'];
      const roles = ['Agent', 'Supervisor', 'Admin', 'Manager'];
      const teams = ['Sales', 'Support', 'Billing', 'Technical', 'Customer Success'];
      
      // Hour distribution based on your example
      const hourDistribution = [
        { range: [0, 0], count: Math.floor(count * 0.234), label: 'NOLOGIN' },
        { range: [0, 10], count: Math.floor(count * 0.071), label: 'Under 10h' },
        { range: [10, 20], count: Math.floor(count * 0.025), label: '10-20h' },
        { range: [20, 30], count: Math.floor(count * 0.031), label: '20-30h' },
        { range: [30, 40], count: Math.floor(count * 0.178), label: '30-40h' },
        { range: [40, 50], count: Math.floor(count * 0.178), label: '40-50h' },
        { range: [50, 60], count: Math.floor(count * 0.016), label: '50-60h' },
        { range: [60, 70], count: Math.floor(count * 0.020), label: '60-70h' },
        { range: [70, 80], count: Math.floor(count * 0.023), label: '70-80h' },
        { range: [80, 90], count: Math.floor(count * 0.015), label: '80-90h' },
        { range: [90, 100], count: Math.floor(count * 0.015), label: '90-100h' },
        { range: [100, 200], count: Math.floor(count * 0.066), label: '100+h' },
      ];
      
      let userIndex = 0;
      
      hourDistribution.forEach(dist => {
        for (let i = 0; i < dist.count && userIndex < count; i++, userIndex++) {
          const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
          const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
          const role = roles[Math.floor(Math.random() * roles.length)];
          const team = teams[Math.floor(Math.random() * teams.length)];
          
          const hours = dist.range[0] + Math.random() * (dist.range[1] - dist.range[0]);
          const isSupervisor = role === 'Supervisor' || role === 'Admin' || role === 'Manager';
          
          users.push({
            id: `user-${1000 + userIndex}`,
            name: `${firstName} ${lastName}`,
            email: `${firstName.toLowerCase()}.${lastName.toLowerCase()}@staging.company.com`,
            team: team,
            role: role,
            interactingHours: parseFloat(hours.toFixed(2)),
            isSupervisor: isSupervisor,
            status: hours === 0 ? 'NOLOGIN' : 'Active'
          });
        }
      });
      
      return users;
    }

    // ==============================================
    // ANALYSIS & CALCULATIONS
    // ==============================================
    async function runAnalysis() {
      if (appState.isAnalyzing) return;
      
      appState.isAnalyzing = true;
      el.btnRunAnalysis.disabled = true;
      el.btnRunAnalysis.innerHTML = '<span>‚è≥ Analyzing...</span>';
      
      updateProgress('Starting analysis...', 10);
      
      try {
        const threshold = parseFloat(el.thresholdHours.value);
        const includeNologin = el.includeNologin.value === 'true';
        
        // Filter users
        updateProgress('Filtering users...', 30);
        let usersToAnalyze = appState.userData;
        if (!includeNologin) {
          usersToAnalyze = appState.userData.filter(u => u.interactingHours > 0);
        }
        
        // Analyze each user
        updateProgress('Applying business rules...', 50);
        usersToAnalyze.forEach(user => {
          if (user.interactingHours === 0) {
            user.recommendedLicense = 'NOLOGIN';
            user.recommendedReason = 'No login activity';
          } else if (user.isSupervisor) {
            user.recommendedLicense = 'Named';
            user.recommendedReason = 'Admin/Supervisor role';
          } else if (user.interactingHours < threshold) {
            user.recommendedLicense = 'HI';
            user.recommendedReason = `Under ${threshold} hours`;
          } else {
            user.recommendedLicense = 'Named';
            user.recommendedReason = `Over ${threshold} hours`;
          }
          
          // Cost calculation
          if (user.recommendedLicense === 'HI') {
            user.estimatedCost = user.interactingHours * 0.45;
          } else if (user.recommendedLicense === 'Named') {
            user.estimatedCost = 70;
          } else {
            user.estimatedCost = 0;
          }
        });
        
        // Calculate statistics
        updateProgress('Calculating statistics...', 70);
        const totalUsers = usersToAnalyze.length;
        const activeUsers = usersToAnalyze.filter(u => u.interactingHours > 0).length;
        const namedUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'Named').length;
        const hiUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'HI').length;
        const nologinUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'NOLOGIN').length;
        const totalHours = usersToAnalyze.reduce((sum, u) => sum + u.interactingHours, 0);
        
        // Cost analysis
        const allNamedCost = totalUsers * 70;
        const hiHours = usersToAnalyze
          .filter(u => u.recommendedLicense === 'HI')
          .reduce((sum, u) => sum + u.interactingHours, 0);
        const hybridCost = (namedUsers * 70) + (hiHours * 0.45);
        const savings = allNamedCost > 0 ? ((allNamedCost - hybridCost) / allNamedCost * 100).toFixed(1) : 0;
        
        // Determine optimal model
        let optimalModel = 'Hybrid';
        if (hiUsers / totalUsers > 0.7) optimalModel = 'Mostly HI';
        else if (namedUsers / totalUsers > 0.7) optimalModel = 'Mostly Named';
        else if (hiUsers === 0) optimalModel = 'All Named';
        else if (namedUsers === 0) optimalModel = 'All HI';
        
        // Store results
        appState.analysisResults = {
          totalUsers,
          activeUsers,
          namedUsers,
          hiUsers,
          nologinUsers,
          totalHours: totalHours.toFixed(2),
          threshold,
          allNamedCost: allNamedCost.toFixed(0),
          hybridCost: hybridCost.toFixed(0),
          savings,
          optimalModel,
          users: usersToAnalyze
        };
        
        // Update UI
        updateProgress('Updating display...', 90);
        el.statActiveUsers.textContent = activeUsers;
        el.statNamedUsers.textContent = namedUsers;
        el.statHiUsers.textContent = hiUsers;
        el.totalCost.textContent = `$${hybridCost}`;
        el.savings.textContent = `${savings}% savings`;
        el.licenseModel.textContent = optimalModel;
        
        // Update user table with recommendations
        renderUserTable();
        
        // Create chart
        updateProgress('Creating visualization...', 95);
        createLicenseChart();
        
        updateProgress('Analysis complete!', 100);
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        logMessage('SUCCESS', 'Analysis complete', `${namedUsers} Named, ${hiUsers} HI users`);
        showStatusMessage(`‚úÖ Analysis complete: ${savings}% cost savings`, 'success');
        
        el.btnExport.disabled = false;
        
      } catch (error) {
        logMessage('ERROR', 'Analysis failed', error.message);
        showStatusMessage('‚ùå Analysis failed', 'error');
      } finally {
        appState.isAnalyzing = false;
        el.btnRunAnalysis.disabled = false;
        el.btnRunAnalysis.innerHTML = '<span>‚ñ∂Ô∏è Run Analysis</span>';
        updateProgress('Ready to analyze', 0);
      }
    }

    // ==============================================
    // UI RENDERING
    // ==============================================
    function renderUserTable(searchTerm = '') {
      const tbody = el.usersTableBody;
      tbody.innerHTML = '';
      
      let usersToDisplay = appState.userData;
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        usersToDisplay = appState.userData.filter(user =>
          user.name.toLowerCase().includes(term) ||
          user.email.toLowerCase().includes(term) ||
          user.team.toLowerCase().includes(term) ||
          user.role.toLowerCase().includes(term)
        );
      }
      
      el.visibleCount.textContent = usersToDisplay.length;
      
      usersToDisplay.forEach(user => {
        const row = document.createElement('tr');
        
        let licenseBadge = '';
        let badgeClass = '';
        
        if (user.recommendedLicense) {
          switch(user.recommendedLicense) {
            case 'Named':
              badgeClass = 'status-named';
              licenseBadge = `<span class="status-badge ${badgeClass}">Named</span>`;
              break;
            case 'HI':
              badgeClass = 'status-hi';
              licenseBadge = `<span class="status-badge ${badgeClass}">HI</span>`;
              break;
            case 'NOLOGIN':
              badgeClass = 'status-nologin';
              licenseBadge = `<span class="status-badge ${badgeClass}">NOLOGIN</span>`;
              break;
          }
        }
        
        row.innerHTML = `
          <td>
            <div style="font-weight:600;">${user.name}</div>
            <div style="font-size:11px;color:var(--text-light);">ID: ${user.id}</div>
          </td>
          <td>${user.email}</td>
          <td>
            ${user.role}
            ${user.isSupervisor ? '<div style="font-size:10px;color:var(--warning);">Supervisor</div>' : ''}
          </td>
          <td style="text-align:center;font-weight:600;">
            ${user.interactingHours.toFixed(1)}
          </td>
          <td>${licenseBadge}</td>
          <td>
            <span style="font-size:11px;color:${user.status === 'Active' ? 'var(--success)' : 'var(--text-light)'}">
              ${user.status}
            </span>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function updateHourBuckets() {
      const buckets = {
        '0h': 0,
        '1-10h': 0,
        '11-20h': 0,
        '21-30h': 0,
        '31-40h': 0,
        '41-50h': 0,
        '51-60h': 0,
        '61-70h': 0,
        '71-80h': 0,
        '81-90h': 0,
        '91-100h': 0,
        '100+h': 0
      };
      
      appState.userData.forEach(user => {
        const hours = user.interactingHours;
        if (hours === 0) buckets['0h']++;
        else if (hours <= 10) buckets['1-10h']++;
        else if (hours <= 20) buckets['11-20h']++;
        else if (hours <= 30) buckets['21-30h']++;
        else if (hours <= 40) buckets['31-40h']++;
        else if (hours <= 50) buckets['41-50h']++;
        else if (hours <= 60) buckets['51-60h']++;
        else if (hours <= 70) buckets['61-70h']++;
        else if (hours <= 80) buckets['71-80h']++;
        else if (hours <= 90) buckets['81-90h']++;
        else if (hours <= 100) buckets['91-100h']++;
        else buckets['100+h']++;
      });
      
      el.hourBuckets.innerHTML = '';
      
      Object.entries(buckets).forEach(([label, count]) => {
        const card = document.createElement('div');
        card.className = 'bucket-card';
        card.innerHTML = `
          <div class="bucket-count">${count}</div>
          <div class="bucket-label">${label}</div>
        `;
        el.hourBuckets.appendChild(card);
      });
    }

    function createLicenseChart() {
      const ctx = document.getElementById('licenseChart').getContext('2d');
      
      // Destroy existing chart
      if (appState.chartInstances.license) {
        appState.chartInstances.license.destroy();
      }
      
      if (!appState.analysisResults) return;
      
      const data = {
        labels: ['Named Users', 'HI Users', 'NOLOGIN Users'],
        datasets: [{
          data: [
            appState.analysisResults.namedUsers,
            appState.analysisResults.hiUsers,
            appState.analysisResults.nologinUsers
          ],
          backgroundColor: [
            'rgba(99, 171, 143, 0.8)',
            'rgba(40, 167, 69, 0.8)',
            'rgba(108, 117, 125, 0.8)'
          ],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      };
      
      appState.chartInstances.license = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            }
          }
        }
      });
    }

    // ==============================================
    // EXPORT FUNCTIONALITY
    // ==============================================
    function exportReport() {
      if (!appState.analysisResults) {
        showStatusMessage('Please run analysis first', 'warn');
        return;
      }
      
      const results = appState.analysisResults;
      
      // Create CSV content
      let csv = 'Genesys Cloud Hourly Billing Analysis Report\n';
      csv += `Generated: ${new Date().toLocaleString()}\n`;
      csv += `Environment: Staging (${STAGING_CONFIG.region})\n`;
      csv += `Period: ${el.dateFrom.value} to ${el.dateTo.value}\n\n`;
      
      csv += 'SUMMARY\n';
      csv += 'Metric,Value\n';
      csv += `Total Users,${results.totalUsers}\n`;
      csv += `Active Users,${results.activeUsers}\n`;
      csv += `Named Users,${results.namedUsers}\n`;
      csv += `HI Users,${results.hiUsers}\n`;
      csv += `NOLOGIN Users,${results.nologinUsers}\n`;
      csv += `Total Hours,${results.totalHours}\n`;
      csv += `HI Threshold,${results.threshold} hours\n`;
      csv += `All Named Cost,$${results.allNamedCost}\n`;
      csv += `Hybrid Cost,$${results.hybridCost}\n`;
      csv += `Cost Savings,${results.savings}%\n`;
      csv += `Optimal Model,${results.optimalModel}\n\n`;
      
      csv += 'USER DETAILS\n';
      csv += 'Name,Email,Team,Role,Hours,Recommended License,Reason,Estimated Cost\n';
      
      results.users.forEach(user => {
        csv += `"${user.name}","${user.email}","${user.team}","${user.role}",${user.interactingHours},"${user.recommendedLicense}","${user.recommendedReason}",${user.estimatedCost.toFixed(2)}\n`;
      });
      
      // Download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      
      a.href = url;
      a.download = `genesys_billing_staging_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      logMessage('SUCCESS', 'Report exported', 'CSV file downloaded');
      showStatusMessage('‚úÖ Report exported to CSV', 'success');
    }

    // ==============================================
    // INITIALIZATION & EVENT HANDLERS
    // ==============================================
    function initializeApp() {
      // Display masked client ID
      const maskedId = STAGING_CONFIG.clientId.substring(0, 8) + '...' + STAGING_CONFIG.clientId.substring(24);
      el.clientIdDisplay.value = maskedId;
      
      // Set default dates
      const today = new Date();
      const lastMonth = new Date();
      lastMonth.setMonth(today.getMonth() - 1);
      
      el.dateTo.valueAsDate = today;
      el.dateFrom.valueAsDate = lastMonth;
      
      // Set max dates
      const todayStr = today.toISOString().split('T')[0];
      el.dateTo.max = todayStr;
      el.dateFrom.max = todayStr;
      
      // Event Listeners
      el.btnConnect.addEventListener('click', authenticate);
      el.btnFetchData.addEventListener('click', fetchUserData);
      el.btnRunAnalysis.addEventListener('click', runAnalysis);
      el.btnAnalyze.addEventListener('click', runAnalysis);
      el.btnExport.addEventListener('click', exportReport);
      
      el.btnReset.addEventListener('click', () => {
        if (confirm('Reset the application? This will clear all data.')) {
          window.location.reload();
        }
      });
      
      el.userSearch.addEventListener('input', (e) => {
        renderUserTable(e.target.value);
      });
      
      // Quick date buttons
      document.querySelectorAll('.quick-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const days = parseInt(this.dataset.days);
          const toDate = new Date();
          const fromDate = new Date();
          
          if (days === 0) {
            el.dateTo.valueAsDate = toDate;
            el.dateFrom.valueAsDate = toDate;
          } else {
            fromDate.setDate(toDate.getDate() - days);
            el.dateTo.valueAsDate = toDate;
            el.dateFrom.valueAsDate = fromDate;
          }
          
          logMessage('INFO', 'Date range updated', `Last ${days === 0 ? 'today' : days + ' days'}`);
        });
      });
      
      // Tab switching
      el.tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          appState.currentTab = tabId;
          
          // Update active tab
          el.tabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Show active content
          el.tabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === `tab-${tabId}`) {
              content.classList.add('active');
            }
          });
          
          logMessage('INFO', 'Tab switched', tabId);
        });
      });
      
      // Logs buttons
      document.getElementById('btnClearLogs')?.addEventListener('click', () => {
        el.logsTableBody.innerHTML = '';
        appState.logs = [];
        logMessage('INFO', 'Logs cleared');
      });
      
      document.getElementById('btnCopyLogs')?.addEventListener('click', () => {
        const logText = appState.logs.map(log => 
          `${log.timestamp} [${log.level}] ${log.message} ${log.details ? '- ' + log.details : ''}`
        ).join('\n');
        
        navigator.clipboard.writeText(logText).then(() => {
          showStatusMessage('Logs copied to clipboard', 'success');
        });
      });
      
      // Initial log
      logMessage('INFO', 'Staging application initialized', `Environment: ${STAGING_CONFIG.region}`);
      showStatusMessage('üöÄ Staging Environment Ready', 'success');
    }

    // Start the application
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
