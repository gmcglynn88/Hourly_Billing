<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Cloud Hourly Billing Calculator</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --filter-bg:#f0f7f3; --warning:#ffc107; --danger:#dc3545;
      --success:#28a745; --info:#17a2b8;
      
      /* Status colors */
      --status-onqueue: #b3e0ff;
      --status-offqueue: #d2b48c;
      --status-available: #c3e6cb;
      --status-offline: #e2e3e5;
      --status-unavailable: #d6d8db;
      --status-busy: #f5c6cb;
      --status-meetings: #f8d7da;
      --status-breaks: #ffeaa7;
      --status-meal: #ffcc99;
      --status-away: #ffc107;
      --status-training: #c3e6cb;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1800px;
      background:var(--light-bg);color:var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px 32px;
      margin-bottom: 24px;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
      border-left: 5px solid var(--primary-color);
      border:1px solid var(--border-color);
    }

    h1 {
      color: var(--text-color);
      margin-bottom: 8px;
      font-size: 28px;
    }

    .subtitle {
      color: var(--text-light);
      font-size: 16px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 24px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Card Styling */
    .card{
      background:var(--card-bg);
      border:1px solid var(--border-color);
      border-radius:12px;
      padding:24px;
      margin-bottom:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }

    .card h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
      font-size: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--light-bg);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Form Controls */
    .form-group {
      margin-bottom: 20px;
    }

    label{
      display:block;
      font-weight:600;
      margin-bottom:6px;
      color: var(--text-color);
    }

    select,input,button{
      padding:10px;
      border:1px solid var(--border-color);
      border-radius:6px;
      background:var(--card-bg);
      font-size:14px;
      width: 100%;
    }

    button{
      background:var(--primary-color);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      transition:background .2s;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:hover{
      background:var(--secondary-color);
    }
    
    button:disabled{
      background:var(--text-light);
      cursor:not-allowed;
    }

    .btn-block {
      width: 100%;
      padding: 12px;
    }

    /* Date Range */
    .date-range {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Auth Section */
    .auth-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .auth-section h3 {
      margin-bottom: 16px;
      font-size: 20px;
      color: white;
    }

    .auth-section p {
      margin-bottom: 24px;
      opacity: 0.9;
    }

    /* Results Section */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .stat-card {
      background: var(--pill);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary-color);
      margin: 10px 0;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* License Summary */
    .license-summary {
      background: linear-gradient(135deg, #e8f6f0 0%, #d4f2e4 100%);
      border-left: 4px solid var(--primary-color);
    }

    .license-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .license-item:last-child {
      border-bottom: none;
    }

    .license-name {
      font-weight: 600;
    }

    .license-count {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
    }

    /* Badge Styling */
    .badge {
      display: inline-block;
      padding: 4px 12px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 20px;
      margin-left: 8px;
    }

    .badge-primary {
      background: var(--primary-color);
      color: white;
    }

    .badge-success {
      background: var(--success);
      color: white;
    }

    .badge-warning {
      background: var(--warning);
      color: black;
    }

    .badge-info {
      background: var(--info);
      color: white;
    }

    /* Data Table */
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
      padding: 16px;
      text-align: left;
    }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-color);
    }

    tr:hover {
      background-color: var(--pill);
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-named {
      background: rgba(0, 102, 204, 0.1);
      color: var(--primary-color);
    }

    .status-hi {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success);
    }

    .status-supervisor {
      background: rgba(255, 193, 7, 0.1);
      color: #d39e00;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 24px;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab:hover {
      color: var(--primary-color);
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Alerts */
    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-info {
      background: rgba(99, 171, 143, 0.1);
      border-left: 4px solid var(--primary-color);
      color: var(--text-color);
    }

    .alert-success {
      background: rgba(40, 167, 69, 0.1);
      border-left: 4px solid var(--success);
      color: var(--success);
    }

    .alert-warning {
      background: rgba(255, 193, 7, 0.1);
      border-left: 4px solid var(--warning);
      color: #856404;
    }

    .alert-danger {
      background: rgba(220, 53, 69, 0.1);
      border-left: 4px solid var(--danger);
      color: var(--danger);
    }

    /* Loading States */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(99, 171, 143, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--light-bg);
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 6px;
    }

    .export-btn {
      background: var(--text-light);
    }

    .export-btn:hover {
      background: #5a6268;
    }

    /* Mode Selector */
    .mode-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .mode-btn {
      flex: 1;
      padding: 12px;
      text-align: center;
      background: var(--light-bg);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .mode-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    /* Charts */
    .chart-container {
      height: 300px;
      margin-top: 20px;
      position: relative;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        margin: 10px;
        padding: 10px;
      }

      .card {
        padding: 16px;
      }

      header {
        padding: 16px;
      }

      h1 {
        font-size: 24px;
      }

      .btn-block {
        padding: 10px 16px;
        font-size: 14px;
      }

      .stat-value {
        font-size: 28px;
      }

      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Tooltips */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background: var(--text-color);
      color: white;
      text-align: center;
      padding: 8px;
      border-radius: 4px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      font-weight: normal;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--light-bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-light);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä Genesys Cloud Hourly Billing Calculator</h1>
      <p class="subtitle">Calculate optimal license distribution and hourly billing based on user interaction data</p>
    </header>

    <!-- Mode Selector -->
    <div class="card">
      <h2>üîß Application Mode</h2>
      <div class="mode-selector">
        <div class="mode-btn active" data-mode="mock">Mock Data Mode</div>
        <div class="mode-btn" data-mode="api">Live API Mode</div>
      </div>
      <div class="alert alert-info" id="modeAlert">
        <span>üìã</span>
        <div>
          <strong>Mock Mode Active:</strong> Using sample data for demonstration. To use real Genesys Cloud data, switch to Live API Mode and set up a server-side proxy to avoid CORS restrictions.
        </div>
      </div>
    </div>

    <div class="main-grid">
      <!-- Left Column: Controls -->
      <div class="left-column">
        <!-- Auth Section (Only in API Mode) -->
        <div id="authSection" class="auth-section card" style="display: none;">
          <h3>üîê Authentication</h3>
          <p>Enter your Genesys Cloud API credentials</p>
          <div class="form-group">
            <label for="clientId">Client ID</label>
            <input type="text" id="clientId" placeholder="Enter Client ID">
          </div>
          <div class="form-group">
            <label for="clientSecret">Client Secret</label>
            <input type="password" id="clientSecret" placeholder="Enter Client Secret">
          </div>
          <div class="form-group">
            <label for="region">Region</label>
            <select id="region">
              <option value="mypurecloud.ie">Europe (Dublin) - mypurecloud.ie</option>
              <option value="euw2.pure.cloud">Europe West (London) - euw2.pure.cloud</option>
              <option value="mypurecloud.com">US East (Virginia) - mypurecloud.com</option>
              <option value="usw2.pure.cloud">US West (Oregon) - usw2.pure.cloud</option>
            </select>
          </div>
          <button id="btnAuth" class="btn btn-block">
            <span>Authenticate</span>
          </button>
        </div>

        <!-- Date Range Selector -->
        <div class="card">
          <h2>üìÖ Date Range</h2>
          <div class="form-group">
            <label for="dateFrom">From Date</label>
            <input type="date" id="dateFrom">
          </div>
          <div class="form-group">
            <label for="dateTo">To Date</label>
            <input type="date" id="dateTo">
          </div>
          <div class="form-group">
            <label>Quick Select</label>
            <div class="action-buttons">
              <button class="action-btn" data-days="30">Last 30 days</button>
              <button class="action-btn" data-days="7">Last 7 days</button>
              <button class="action-btn" data-days="1">Yesterday</button>
            </div>
          </div>
        </div>

        <!-- Analysis Parameters -->
        <div class="card">
          <h2>‚öôÔ∏è Analysis Parameters</h2>
          <div class="form-group">
            <label for="thresholdHours" class="tooltip">
              HI Efficiency Threshold (hours/month)
              <span class="tooltip-text">Users with interacting time below this threshold are recommended for HI licenses</span>
            </label>
            <input type="number" id="thresholdHours" value="40" min="1" max="200">
          </div>
          <div class="form-group">
            <label for="includeNologin" class="tooltip">
              Include NOLOGIN users in analysis?
              <span class="tooltip-text">Include users who haven't logged in during the period</span>
            </label>
            <select id="includeNologin">
              <option value="true">Yes - include in totals</option>
              <option value="false">No - exclude from analysis</option>
            </select>
          </div>
          <div class="alert alert-info">
            <span>üí°</span>
            <div>
              <strong>Assumptions:</strong>
              <div style="font-size: 12px; margin-top: 4px;">
                ‚Ä¢ Users with Interacting time > 0 but < threshold = HI<br>
                ‚Ä¢ Users with Interacting time ‚â• threshold = Named<br>
                ‚Ä¢ Admins/Supervisors = Named (regardless of hours)
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="card">
          <button id="btnFetchData" class="btn btn-primary btn-block">
            <span>üì• Load Mock Data</span>
          </button>
          <div style="height: 12px;"></div>
          <button id="btnCalculate" class="btn btn-success btn-block" disabled>
            <span>üßÆ Calculate Licensing</span>
          </button>
          <div style="height: 12px;"></div>
          <button id="btnExport" class="btn btn-secondary btn-block" disabled>
            <span>üìä Export Results</span>
          </button>
        </div>
      </div>

      <!-- Right Column: Results -->
      <div class="right-column">
        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" data-tab="summary">üìà Summary</button>
          <button class="tab" data-tab="details">üë• User Details</button>
          <button class="tab" data-tab="charts">üìä Charts</button>
          <button class="tab" data-tab="api">üîß API Logs</button>
        </div>

        <!-- Summary Tab -->
        <div id="tab-summary" class="tab-content active">
          <!-- License Recommendation -->
          <div class="card license-summary">
            <h2>üéØ License Recommendation</h2>
            <div class="license-item">
              <div class="license-name">Total Unique Users</div>
              <div class="license-count" id="totalUsers">0</div>
            </div>
            <div class="license-item">
              <div class="license-name">
                Named Users
                <span class="badge badge-primary">Recommended</span>
              </div>
              <div class="license-count" id="namedUsers">0</div>
            </div>
            <div class="license-item">
              <div class="license-name">
                Hourly Interacting (HI)
                <span class="badge badge-success">Flexible</span>
              </div>
              <div class="license-count" id="hiUsers">0</div>
            </div>
            <div class="license-item">
              <div class="license-name">Total HI Hours/Month</div>
              <div class="license-count" id="totalHours">0</div>
            </div>
            <div class="license-item" style="border-top: 2px solid var(--border-color); padding-top: 20px;">
              <div class="license-name" style="font-size: 18px;">Optimal License Model</div>
              <div class="license-count" style="font-size: 24px;" id="optimalModel">Hybrid</div>
            </div>
          </div>

          <!-- Key Statistics -->
          <div class="card">
            <h2>üìä Key Statistics</h2>
            <div class="results-grid">
              <div class="stat-card">
                <div class="stat-label">Active Users</div>
                <div class="stat-value" id="activeUsers">0</div>
                <div class="stat-label" style="font-size: 12px;" id="activeChange">0% of total</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Avg Hours/User</div>
                <div class="stat-value" id="avgHours">0</div>
                <div class="stat-label" style="font-size: 12px;" id="avgHoursText">per active user</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">HI Efficiency</div>
                <div class="stat-value" id="hiEfficiency">0%</div>
                <div class="stat-label" style="font-size: 12px;">of users below threshold</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Cost Savings</div>
                <div class="stat-value" id="costSavings">0%</div>
                <div class="stat-label" style="font-size: 12px;">vs all Named</div>
              </div>
            </div>
          </div>

          <!-- Hour Distribution -->
          <div class="card">
            <h2>‚è±Ô∏è Hour Distribution</h2>
            <div class="chart-container">
              <canvas id="hoursChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Details Tab -->
        <div id="tab-details" class="tab-content">
          <div class="card">
            <h2>üë§ User Analysis</h2>
            <div style="margin-bottom: 20px;">
              <input type="text" id="userSearch" placeholder="üîç Search users..." style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 6px;">
            </div>
            <div class="table-container">
              <table class="data-table" id="usersTable">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Interacting Hours</th>
                    <th>Recommended License</th>
                    <th>Status</th>
                    <th>Cost/Month</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <!-- Filled by JavaScript -->
                </tbody>
              </table>
            </div>
            <div style="margin-top: 20px; text-align: center; color: var(--text-light);">
              Showing <span id="visibleUsers">0</span> of <span id="totalUsersTable">0</span> users
            </div>
          </div>
        </div>

        <!-- Charts Tab -->
        <div id="tab-charts" class="tab-content">
          <div class="card">
            <h2>üìà License Distribution</h2>
            <div class="chart-container">
              <canvas id="licenseChart"></canvas>
            </div>
          </div>
          <div class="results-grid">
            <div class="card">
              <h2>‚è∞ Hours Breakdown</h2>
              <div class="chart-container">
                <canvas id="hoursBreakdownChart"></canvas>
              </div>
            </div>
            <div class="card">
              <h2>üí∞ Cost Comparison</h2>
              <div class="chart-container">
                <canvas id="costChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- API Logs Tab -->
        <div id="tab-api" class="tab-content">
          <div class="card">
            <h2>üîß Application Logs</h2>
            <div class="action-buttons">
              <button id="btnClearLogs" class="action-btn">Clear Logs</button>
            </div>
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Action</th>
                    <th>Status</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody id="apiLogs">
                  <!-- Filled by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText">Processing...</div>
    <div id="loadingProgress" style="margin-top: 10px; font-size: 14px; color: var(--text-light);"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Global variables
    let currentMode = 'mock'; // 'mock' or 'api'
    let authToken = null;
    let apiBaseUrl = 'https://api.euw2.pure.cloud';
    let userData = [];
    let analysisResults = null;
    let charts = {};

    // DOM Elements
    const elements = {
      // Mode Selector
      modeAlert: document.getElementById('modeAlert'),
      
      // Authentication
      authSection: document.getElementById('authSection'),
      clientId: document.getElementById('clientId'),
      clientSecret: document.getElementById('clientSecret'),
      region: document.getElementById('region'),
      btnAuth: document.getElementById('btnAuth'),
      
      // Date Range
      dateFrom: document.getElementById('dateFrom'),
      dateTo: document.getElementById('dateTo'),
      
      // Parameters
      thresholdHours: document.getElementById('thresholdHours'),
      includeNologin: document.getElementById('includeNologin'),
      
      // Action Buttons
      btnFetchData: document.getElementById('btnFetchData'),
      btnCalculate: document.getElementById('btnCalculate'),
      btnExport: document.getElementById('btnExport'),
      btnClearLogs: document.getElementById('btnClearLogs'),
      
      // Results Display
      totalUsers: document.getElementById('totalUsers'),
      namedUsers: document.getElementById('namedUsers'),
      hiUsers: document.getElementById('hiUsers'),
      totalHours: document.getElementById('totalHours'),
      optimalModel: document.getElementById('optimalModel'),
      activeUsers: document.getElementById('activeUsers'),
      avgHours: document.getElementById('avgHours'),
      hiEfficiency: document.getElementById('hiEfficiency'),
      costSavings: document.getElementById('costSavings'),
      activeChange: document.getElementById('activeChange'),
      avgHoursText: document.getElementById('avgHoursText'),
      
      // Tables
      usersTableBody: document.getElementById('usersTableBody'),
      userSearch: document.getElementById('userSearch'),
      visibleUsers: document.getElementById('visibleUsers'),
      totalUsersTable: document.getElementById('totalUsersTable'),
      apiLogs: document.getElementById('apiLogs'),
      
      // Loading
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingText: document.getElementById('loadingText'),
      loadingProgress: document.getElementById('loadingProgress'),
      
      // Tabs
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content')
    };

    // Initialize date range (default: last 30 days)
    function initializeDates() {
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      elements.dateTo.valueAsDate = today;
      elements.dateFrom.valueAsDate = thirtyDaysAgo;
      
      // Set max date to today
      const todayStr = today.toISOString().split('T')[0];
      elements.dateTo.max = todayStr;
      elements.dateFrom.max = todayStr;
    }

    // Toggle loading overlay
    function setLoading(isLoading, text = '') {
      if (isLoading) {
        elements.loadingText.textContent = text || 'Processing...';
        elements.loadingOverlay.classList.add('active');
      } else {
        elements.loadingOverlay.classList.remove('active');
      }
    }

    // Update loading progress
    function updateProgress(text) {
      elements.loadingProgress.textContent = text;
    }

    // Add log entry
    function addLog(action, status, details) {
      const now = new Date();
      const time = now.toLocaleTimeString();
      const row = document.createElement('tr');
      
      let statusBadge = 'üü¢';
      if (status === 'error') statusBadge = 'üî¥';
      else if (status === 'warning') statusBadge = 'üü°';
      else if (status === 'processing') statusBadge = 'üîÑ';
      else if (status === 'info') statusBadge = 'üîµ';
      
      row.innerHTML = `
        <td>${time}</td>
        <td>${action}</td>
        <td>${statusBadge}</td>
        <td>${details}</td>
      `;
      
      elements.apiLogs.prepend(row);
    }

    // Switch between mock and API mode
    function switchMode(mode) {
      currentMode = mode;
      
      // Update UI
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      
      if (mode === 'mock') {
        elements.authSection.style.display = 'none';
        elements.btnFetchData.innerHTML = '<span>üì• Load Mock Data</span>';
        elements.btnFetchData.disabled = false;
        elements.btnCalculate.disabled = true;
        elements.btnExport.disabled = true;
        elements.modeAlert.innerHTML = `
          <span>üìã</span>
          <div>
            <strong>Mock Mode Active:</strong> Using sample data for demonstration. To use real Genesys Cloud data, switch to Live API Mode.
          </div>
        `;
        elements.modeAlert.className = 'alert alert-info';
        addLog('Mode Switch', 'info', 'Switched to Mock Data Mode');
      } else {
        elements.authSection.style.display = 'block';
        elements.btnFetchData.innerHTML = '<span>üì• Fetch Live Data</span>';
        elements.btnFetchData.disabled = true;
        elements.btnCalculate.disabled = true;
        elements.btnExport.disabled = true;
        elements.modeAlert.innerHTML = `
          <span>‚ö†Ô∏è</span>
          <div>
            <strong>API Mode Active:</strong> CORS restrictions prevent direct browser access to Genesys Cloud OAuth. You need to set up a server-side proxy. Using mock data for now.
          </div>
        `;
        elements.modeAlert.className = 'alert alert-warning';
        addLog('Mode Switch', 'warning', 'Switched to Live API Mode (CORS restrictions apply)');
      }
    }

    // Generate mock user data based on your example
    function generateMockData() {
      const mockUsers = [];
      const names = [
        'John Smith', 'Emma Johnson', 'Michael Brown', 'Sarah Davis', 'Robert Wilson',
        'Jennifer Taylor', 'William Anderson', 'Lisa Thomas', 'David Jackson', 'Karen White',
        'Richard Harris', 'Susan Martin', 'Joseph Thompson', 'Jessica Garcia', 'Charles Martinez',
        'Nancy Robinson', 'Thomas Clark', 'Betty Rodriguez', 'Christopher Lewis', 'Margaret Lee',
        'Daniel Walker', 'Sandra Hall', 'Paul Allen', 'Donna Young', 'Mark King',
        'Carol Wright', 'Steven Scott', 'Ruth Green', 'Andrew Baker', 'Sharon Adams'
      ];
      
      const statuses = ['Agent', 'Supervisor', 'Admin', 'Manager'];
      
      // Generate users based on your example distribution
      // Total: ~1800 users as in your example
      
      // NOLOGIN users (419 from your example)
      for (let i = 0; i < 419; i++) {
        mockUsers.push({
          id: `user-nologin-${i}`,
          name: `User ${i+1} (No Login)`,
          interactingHours: 0,
          isSupervisor: Math.random() < 0.1,
          status: 'NOLOGIN'
        });
      }
      
      // HI users (632 from your example under 40 hours)
      for (let i = 0; i < 632; i++) {
        const hours = Math.random() * 40; // 0-40 hours
        mockUsers.push({
          id: `user-hi-${i}`,
          name: names[Math.floor(Math.random() * names.length)] + ' (HI)',
          interactingHours: hours,
          isSupervisor: false,
          status: 'Agent'
        });
      }
      
      // Named users under threshold but admins
      for (let i = 0; i < 194; i++) {
        const hours = Math.random() * 30; // 0-30 hours
        mockUsers.push({
          id: `user-admin-${i}`,
          name: names[Math.floor(Math.random() * names.length)] + ' (Admin)',
          interactingHours: hours,
          isSupervisor: true,
          status: 'Admin'
        });
      }
      
      // Named users over threshold (319 from your example 40-50 hours bucket)
      for (let i = 0; i < 319; i++) {
        const hours = 40 + Math.random() * 10; // 40-50 hours
        mockUsers.push({
          id: `user-named-${i}`,
          name: names[Math.floor(Math.random() * names.length)] + ' (Named)',
          interactingHours: hours,
          isSupervisor: false,
          status: 'Agent'
        });
      }
      
      // Additional users in higher hour buckets
      const hourBuckets = [
        { count: 128, range: [0, 10] },
        { count: 44, range: [10, 20] },
        { count: 56, range: [20, 30] },
        { count: 28, range: [50, 60] },
        { count: 35, range: [60, 70] },
        { count: 42, range: [70, 80] },
        { count: 26, range: [80, 90] },
        { count: 27, range: [90, 100] },
        { count: 119, range: [100, 120] },
        { count: 1373, range: [120, 200] } // Above 100 hours
      ];
      
      hourBuckets.forEach((bucket, index) => {
        for (let i = 0; i < bucket.count; i++) {
          const hours = bucket.range[0] + Math.random() * (bucket.range[1] - bucket.range[0]);
          mockUsers.push({
            id: `user-bucket${index}-${i}`,
            name: `${names[Math.floor(Math.random() * names.length)]} (${bucket.range[0]}-${bucket.range[1]}h)`,
            interactingHours: hours,
            isSupervisor: Math.random() < 0.05,
            status: statuses[Math.floor(Math.random() * statuses.length)]
          });
        }
      });
      
      // Shuffle and return
      return mockUsers.sort(() => Math.random() - 0.5).slice(0, 1800);
    }

    // Load mock data
    function loadMockData() {
      setLoading(true, 'Generating mock user data...');
      
      setTimeout(() => {
        userData = generateMockData();
        
        const activeUsers = userData.filter(u => u.interactingHours > 0).length;
        const totalHours = userData.reduce((sum, u) => sum + u.interactingHours, 0);
        
        addLog('Data Load', 'success', `Loaded ${userData.length} mock users, ${activeUsers} active, ${totalHours.toFixed(1)} total hours`);
        alert(`‚úÖ Loaded ${userData.length} mock users for analysis`);
        
        elements.btnCalculate.disabled = false;
        setLoading(false);
      }, 1000);
    }

    // Authenticate with Genesys Cloud (Note: CORS will block this in browser)
    async function authenticate() {
      const clientId = elements.clientId.value.trim();
      const clientSecret = elements.clientSecret.value.trim();
      const region = elements.region.value;
      
      if (!clientId || !clientSecret) {
        alert('Please enter both Client ID and Client Secret');
        return;
      }
      
      setLoading(true, 'Attempting authentication...');
      addLog('Authentication', 'processing', 'Starting authentication');
      
      try {
        // Note: This will fail due to CORS in browser
        // In production, you need a server-side proxy
        const authUrl = `https://login.${region}/oauth/token`;
        
        addLog('Authentication', 'warning', 'CORS will block this request in browser. Using mock mode instead.');
        
        // Simulate authentication with mock token
        setTimeout(() => {
          authToken = 'mock-token-for-demo';
          apiBaseUrl = `https://api.${region}`;
          
          addLog('Authentication', 'success', 'Using mock authentication for demo');
          alert('‚ö†Ô∏è CORS prevents browser authentication. Using mock mode for demonstration.');
          
          elements.btnFetchData.disabled = false;
          elements.btnAuth.innerHTML = '‚úÖ Using Mock Mode';
          elements.btnAuth.classList.add('btn-success');
          setLoading(false);
        }, 1500);
        
      } catch (error) {
        addLog('Authentication', 'error', error.message);
        alert(`‚ùå Authentication error: ${error.message}`);
        setLoading(false);
      }
    }

    // Fetch real data from Genesys Cloud (Note: CORS issues)
    async function fetchRealData() {
      if (!authToken) {
        alert('Please authenticate first');
        return;
      }
      
      const dateFrom = elements.dateFrom.value;
      const dateTo = elements.dateTo.value;
      
      if (!dateFrom || !dateTo) {
        alert('Please select a date range');
        return;
      }
      
      setLoading(true, 'Fetching data from Genesys Cloud...');
      addLog('Data Fetch', 'warning', 'CORS prevents direct API calls from browser');
      
      // Since CORS blocks direct API calls, use mock data instead
      setTimeout(() => {
        loadMockData();
        addLog('Data Fetch', 'info', 'Using mock data due to CORS restrictions');
      }, 2000);
    }

    // Calculate licensing recommendations
    function calculateLicensing() {
      if (userData.length === 0) {
        alert('Please load data first');
        return;
      }
      
      const threshold = parseFloat(elements.thresholdHours.value);
      const includeNologin = elements.includeNologin.value === 'true';
      
      // Filter users if needed
      let usersToAnalyze = userData;
      if (!includeNologin) {
        usersToAnalyze = userData.filter(u => u.interactingHours > 0);
      }
      
      // Analyze each user
      usersToAnalyze.forEach(user => {
        if (user.isSupervisor || user.status === 'Admin' || user.status === 'Supervisor') {
          user.recommendedLicense = 'Named';
          user.recommendedReason = 'Admin/Supervisor role';
        } else if (user.interactingHours === 0) {
          user.recommendedLicense = 'NOLOGIN';
          user.recommendedReason = 'No login activity';
        } else if (user.interactingHours < threshold) {
          user.recommendedLicense = 'HI';
          user.recommendedReason = `Under ${threshold} hours`;
        } else {
          user.recommendedLicense = 'Named';
          user.recommendedReason = `Over ${threshold} hours`;
        }
        
        // Calculate estimated cost (simplified)
        if (user.recommendedLicense === 'HI') {
          user.estimatedCost = user.interactingHours * 0.5; // Example: $0.5 per hour
        } else if (user.recommendedLicense === 'Named') {
          user.estimatedCost = 75; // Example: $75 per month per named user
        } else {
          user.estimatedCost = 0;
        }
      });
      
      // Calculate summary statistics
      const totalUsers = usersToAnalyze.length;
      const namedUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'Named').length;
      const hiUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'HI').length;
      const nologinUsers = usersToAnalyze.filter(u => u.recommendedLicense === 'NOLOGIN').length;
      const activeUsers = usersToAnalyze.filter(u => u.interactingHours > 0).length;
      const totalHours = usersToAnalyze.reduce((sum, u) => sum + u.interactingHours, 0);
      const avgHours = activeUsers > 0 ? totalHours / activeUsers : 0;
      
      // Calculate cost comparisons
      const currentCost = totalUsers * 75; // Assuming all Named
      const recommendedCost = (namedUsers * 75) + (totalHours * 0.5);
      const costSavings = currentCost > 0 ? ((currentCost - recommendedCost) / currentCost * 100).toFixed(1) : 0;
      
      // Determine optimal model
      let optimalModel = 'Hybrid';
      if (hiUsers === 0 && namedUsers > 0) optimalModel = 'All Named';
      else if (namedUsers === 0 && hiUsers > 0) optimalModel = 'All HI';
      else if (hiUsers / totalUsers > 0.7) optimalModel = 'Mostly HI';
      else if (namedUsers / totalUsers > 0.7) optimalModel = 'Mostly Named';
      
      // Store results
      analysisResults = {
        totalUsers,
        namedUsers,
        hiUsers,
        nologinUsers,
        activeUsers,
        totalHours: totalHours.toFixed(2),
        avgHours: avgHours.toFixed(1),
        threshold,
        currentCost: currentCost.toFixed(0),
        recommendedCost: recommendedCost.toFixed(0),
        costSavings,
        optimalModel,
        users: usersToAnalyze
      };
      
      // Update UI
      updateResultsUI();
      renderUserTable();
      createCharts();
      
      elements.btnExport.disabled = false;
      
      addLog('Analysis', 'success', `Calculated licensing for ${totalUsers} users`);
      alert('‚úÖ Licensing calculation complete!');
    }

    // Update results in UI
    function updateResultsUI() {
      if (!analysisResults) return;
      
      const r = analysisResults;
      
      elements.totalUsers.textContent = r.totalUsers;
      elements.namedUsers.textContent = r.namedUsers;
      elements.hiUsers.textContent = r.hiUsers;
      elements.totalHours.textContent = r.totalHours;
      elements.optimalModel.textContent = r.optimalModel;
      elements.activeUsers.textContent = r.activeUsers;
      elements.avgHours.textContent = r.avgHours;
      
      // Calculate HI efficiency
      const hiEfficiency = r.activeUsers > 0 ? (r.hiUsers / r.activeUsers * 100).toFixed(1) : 0;
      elements.hiEfficiency.textContent = `${hiEfficiency}%`;
      
      elements.costSavings.textContent = `${r.costSavings}%`;
      
      // Update change indicators
      const activePercent = ((r.activeUsers / r.totalUsers) * 100).toFixed(1);
      elements.activeChange.textContent = `${activePercent}% of total`;
      elements.avgHoursText.textContent = `per active user`;
    }

    // Render user table
    function renderUserTable(filter = '') {
      if (!analysisResults) return;
      
      const tbody = elements.usersTableBody;
      tbody.innerHTML = '';
      
      let filteredUsers = analysisResults.users;
      if (filter) {
        const searchTerm = filter.toLowerCase();
        filteredUsers = analysisResults.users.filter(user => 
          user.name.toLowerCase().includes(searchTerm) ||
          user.recommendedLicense.toLowerCase().includes(searchTerm) ||
          user.status.toLowerCase().includes(searchTerm)
        );
      }
      
      filteredUsers.sort((a, b) => b.interactingHours - a.interactingHours);
      
      filteredUsers.forEach(user => {
        const row = document.createElement('tr');
        
        let statusClass = 'status-named';
        if (user.recommendedLicense === 'HI') statusClass = 'status-hi';
        if (user.recommendedLicense === 'NOLOGIN') statusClass = 'status-supervisor';
        
        row.innerHTML = `
          <td>
            <div style="font-weight: 600;">${user.name}</div>
            <div style="font-size: 12px; color: var(--text-light);">${user.id}</div>
          </td>
          <td style="font-weight: 600; text-align: center;">${user.interactingHours.toFixed(1)}</td>
          <td>
            <span class="status-badge ${statusClass}">${user.recommendedLicense}</span>
            <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">${user.recommendedReason}</div>
          </td>
          <td>${user.status}</td>
          <td style="text-align: right;">$${user.estimatedCost.toFixed(2)}</td>
        `;
        
        tbody.appendChild(row);
      });
      
      elements.visibleUsers.textContent = filteredUsers.length;
      elements.totalUsersTable.textContent = analysisResults.users.length;
    }

    // Create charts
    function createCharts() {
      if (!analysisResults) return;
      
      const r = analysisResults;
      
      // Destroy existing charts
      Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
      });
      
      // License Distribution Chart
      const licenseCtx = document.getElementById('licenseChart').getContext('2d');
      charts.license = new Chart(licenseCtx, {
        type: 'doughnut',
        data: {
          labels: ['Named Users', 'HI Users', 'No Login'],
          datasets: [{
            data: [r.namedUsers, r.hiUsers, r.nologinUsers],
            backgroundColor: [
              'rgba(99, 171, 143, 0.8)',
              'rgba(40, 167, 69, 0.8)',
              'rgba(108, 117, 125, 0.8)'
            ],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = r.totalUsers;
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      
      // Hours Distribution Chart
      const hoursCtx = document.getElementById('hoursChart').getContext('2d');
      
      // Categorize users by hour buckets
      const hourBuckets = {
        'Under 10 hrs': 0,
        '10-20 hrs': 0,
        '20-30 hrs': 0,
        '30-40 hrs': 0,
        '40-50 hrs': 0,
        '50-60 hrs': 0,
        '60-70 hrs': 0,
        '70-80 hrs': 0,
        '80-90 hrs': 0,
        '90-100 hrs': 0,
        'Above 100 hrs': 0
      };
      
      analysisResults.users.forEach(user => {
        const hours = user.interactingHours;
        if (hours < 10) hourBuckets['Under 10 hrs']++;
        else if (hours < 20) hourBuckets['10-20 hrs']++;
        else if (hours < 30) hourBuckets['20-30 hrs']++;
        else if (hours < 40) hourBuckets['30-40 hrs']++;
        else if (hours < 50) hourBuckets['40-50 hrs']++;
        else if (hours < 60) hourBuckets['50-60 hrs']++;
        else if (hours < 70) hourBuckets['60-70 hrs']++;
        else if (hours < 80) hourBuckets['70-80 hrs']++;
        else if (hours < 90) hourBuckets['80-90 hrs']++;
        else if (hours < 100) hourBuckets['90-100 hrs']++;
        else hourBuckets['Above 100 hrs']++;
      });
      
      charts.hours = new Chart(hoursCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(hourBuckets),
          datasets: [{
            label: 'Number of Users',
            data: Object.values(hourBuckets),
            backgroundColor: 'rgba(99, 171, 143, 0.7)',
            borderColor: 'rgba(99, 171, 143, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Users'
              }
            },
            x: {
              ticks: {
                maxRotation: 45
              }
            }
          }
        }
      });
      
      // Hours Breakdown Chart
      const breakdownCtx = document.getElementById('hoursBreakdownChart').getContext('2d');
      charts.breakdown = new Chart(breakdownCtx, {
        type: 'pie',
        data: {
          labels: ['Named Users Hours', 'HI Users Hours'],
          datasets: [{
            data: [
              analysisResults.users.filter(u => u.recommendedLicense === 'Named')
                .reduce((sum, u) => sum + u.interactingHours, 0),
              analysisResults.users.filter(u => u.recommendedLicense === 'HI')
                .reduce((sum, u) => sum + u.interactingHours, 0)
            ],
            backgroundColor: [
              'rgba(99, 171, 143, 0.8)',
              'rgba(40, 167, 69, 0.8)'
            ]
          }]
        }
      });
      
      // Cost Comparison Chart
      const costCtx = document.getElementById('costChart').getContext('2d');
      charts.cost = new Chart(costCtx, {
        type: 'bar',
        data: {
          labels: ['All Named Model', 'Hybrid Model', 'Savings'],
          datasets: [{
            label: 'Monthly Cost ($)',
            data: [
              parseFloat(r.currentCost),
              parseFloat(r.recommendedCost),
              parseFloat(r.currentCost) - parseFloat(r.recommendedCost)
            ],
            backgroundColor: [
              'rgba(108, 117, 125, 0.7)',
              'rgba(99, 171, 143, 0.7)',
              'rgba(40, 167, 69, 0.7)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Cost ($)'
              }
            }
          }
        }
      });
    }

    // Export results
    function exportResults() {
      if (!analysisResults) {
        alert('Please calculate licensing first');
        return;
      }
      
      // Create CSV content
      let csv = 'User ID,User Name,Interacting Hours,Recommended License,Reason,Status,Estimated Cost\n';
      
      analysisResults.users.forEach(user => {
        csv += `"${user.id}","${user.name.replace(/"/g, '""')}",${user.interactingHours.toFixed(2)},"${user.recommendedLicense}","${user.recommendedReason}","${user.status}",${user.estimatedCost.toFixed(2)}\n`;
      });
      
      // Add summary section
      csv += '\nSUMMARY\n';
      csv += `Total Users,${analysisResults.totalUsers}\n`;
      csv += `Named Users,${analysisResults.namedUsers}\n`;
      csv += `HI Users,${analysisResults.hiUsers}\n`;
      csv += `No Login Users,${analysisResults.nologinUsers}\n`;
      csv += `Active Users,${analysisResults.activeUsers}\n`;
      csv += `Total Hours,${analysisResults.totalHours}\n`;
      csv += `Average Hours/User,${analysisResults.avgHours}\n`;
      csv += `Threshold Hours,${analysisResults.threshold}\n`;
      csv += `Optimal Model,${analysisResults.optimalModel}\n`;
      csv += `Current Cost (All Named),$${analysisResults.currentCost}\n`;
      csv += `Recommended Cost,$${analysisResults.recommendedCost}\n`;
      csv += `Cost Savings,${analysisResults.costSavings}%\n`;
      csv += `\nBased on your analysis:\n`;
      csv += `- Users with < ${analysisResults.threshold} hours: HI License\n`;
      csv += `- Users with ‚â• ${analysisResults.threshold} hours: Named License\n`;
      csv += `- Admins/Supervisors: Named License (regardless of hours)\n`;
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      
      a.href = url;
      a.download = `genesys_billing_analysis_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      addLog('Export', 'success', 'Exported results to CSV');
    }

    // Initialize the application
    function initializeApp() {
      // Initialize dates
      initializeDates();
      
      // Set up event listeners
      elements.btnAuth.addEventListener('click', authenticate);
      elements.btnFetchData.addEventListener('click', () => {
        if (currentMode === 'mock') {
          loadMockData();
        } else {
          fetchRealData();
        }
      });
      elements.btnCalculate.addEventListener('click', calculateLicensing);
      elements.btnExport.addEventListener('click', exportResults);
      elements.btnClearLogs.addEventListener('click', () => {
        elements.apiLogs.innerHTML = '';
        addLog('Logs', 'info', 'Logs cleared');
      });
      
      // Mode selector buttons
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          switchMode(this.dataset.mode);
        });
      });
      
      // Date quick select buttons
      document.querySelectorAll('[data-days]').forEach(button => {
        button.addEventListener('click', function() {
          const days = parseInt(this.dataset.days);
          const toDate = new Date();
          const fromDate = new Date();
          fromDate.setDate(toDate.getDate() - days);
          
          elements.dateTo.valueAsDate = toDate;
          elements.dateFrom.valueAsDate = fromDate;
          
          addLog('Date Range', 'info', `Set date range to last ${days} days`);
        });
      });
      
      // User search
      elements.userSearch.addEventListener('input', function() {
        renderUserTable(this.value);
      });
      
      // Tab switching
      elements.tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          
          // Update active tab
          elements.tabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Show active content
          elements.tabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === `tab-${tabId}`) {
              content.classList.add('active');
            }
          });
          
          addLog('Navigation', 'info', `Switched to ${tabId} tab`);
        });
      });
      
      // Add welcome log
      addLog('App Initialization', 'success', 'Hourly Billing Calculator ready - Using Mock Data Mode');
    }

    // Start the app when page loads
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
